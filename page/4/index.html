<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","width":250,"display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":15},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MaxSoft">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="MaxSoft">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="maxsoft">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>MaxSoft</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">MaxSoft</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">「路漫漫其修远兮，吾将上下而求索」</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/09/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E7%9A%84%E4%B8%80%E8%88%AC%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/11/09/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E7%9A%84%E4%B8%80%E8%88%AC%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">算法设计的一般过程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-11-09 20:15:11" itemprop="dateCreated datePublished" datetime="2014-11-09T20:15:11+08:00">2014-11-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 收拾书架的时候看到了大学时学习的「算法设计与分析」，重新学习了一下算法设计的一般过程这个章节，感觉还是比较适用 <del>V</del>。</p>
<h2 id="算法设计的一般过程"><a href="#算法设计的一般过程" class="headerlink" title="算法设计的一般过程"></a>算法设计的一般过程</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法问题的解决方案，这个解决问题的方案本身并不是问题的答案，而是能获得答案的指令序列。不言而喻，由于实际问题千奇百怪，问题求解的方法千变万化，所以，算法的设计过程是一个灵活的充满智慧的过程，它要求设计人员根据实际情况具体问题具体分析。可以肯定的是，发明（或发现）算法是一个非常有创造性和值的付出精力的过程。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在设计算法时，遵循下列步骤可以在一定程度上指导算法的设计。</p>
<h3 id="理解问题"><a href="#理解问题" class="headerlink" title="理解问题"></a>理解问题</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在面对一个算法任务时，算法设计者往往不能准确的理解要求他做的是什么，对算法希望实现什么只有一个大致的想法就匆忙的落笔写算法，其后果往往是写出的算法漏洞百出。在设计算法时需要做的第一件事情是完全理解要解决的问题，仔细阅读问题的描述，手工处理一些小的用例。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对设计算法来说，这是一项重要的技能：准确的理解算法的输入是什么？要求算法做的是什么？即明确算法的入口和出口，这是设计算法的切入点。</p>
<h3 id="预测所有可能的输入"><a href="#预测所有可能的输入" class="headerlink" title="预测所有可能的输入"></a>预测所有可能的输入</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法的输入确定了该算法所解决问题的一个实例。一般而言，对于问题 P. 总有其相对应的实例集 I. 则算法 A 若是问题 P. 的算法，意味着把 P. 的任意一个实例 input ∈I. 作为算法 A. 的输入，都能得到问题 P. 的输出。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;预测算法所有可能的输入。包括合法的输入和非法的输出。事实上，无法保证一个算法（或程序）永远不会遇到一个错误的输入，一个对大部分输入都运行正确而只有一个输入不行的算法，就像一颗等待爆炸的炸弹。这绝不是危言耸听，有大量这种引起灾难性后果的案例。例如，许多年以前，整个 AT&amp;T 的长途电话网崩溃，造成了几十亿美元的直接损失。原因只是一段程序设计者认为他的代码能一直传送正确的参数值，可是有一天，一个不应该有的值作为参数传递了，导致了整个北美电话系统的崩溃。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果养成习惯——首先考虑问题和他的数据，然后列举出算法必须处理的所有特殊情况，那么可以更快速的成功构造算法。</p>
<h3 id="在精确解和近似解间做选择"><a href="#在精确解和近似解间做选择" class="headerlink" title="在精确解和近似解间做选择"></a>在精确解和近似解间做选择</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;计算机科学的研究目标是用计算机来求解人类所面临的各种问题。但是，有些问题无法求得精确解，例如求平方根、解非线性方程、求定积分等，有些问题由于其固有的复杂性，求精确解需要花费太多的时间，其中最著名的要算旅行商问题（即 TSP 问题，是指旅行家要旅行 n 个城市，要求经理各个城市且仅经历一次，并要求所走的路程最短），此时，只能求出近似解。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有时需要根据问题以及问题所受的资源限制，在精确解和近似解间做选择。</p>
<h3 id="确定适当的数据结构"><a href="#确定适当的数据结构" class="headerlink" title="确定适当的数据结构"></a>确定适当的数据结构</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在结构化的程序设计时代，著名的计算机学者沃斯（Wirth）提出了“算法 + 数据结构 = 程序”的观点，断言了算法和数据结构是构成计算机程序的重要基础。在面向对象的程序设计时代，数据结构对于算法设计和分析任然是至关重要的。本书所讨论的很多算法设计技术都是基于精心设计的数据结构。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确定数据结构通常包括对问题实例的数据进行组织和重构，以及完成算法所设计的辅助数据结构，在很多情况下，数据结构的设计直接影响基于该结构之上设计的算法的时间性能。</p>
<h3 id="算法设计技术"><a href="#算法设计技术" class="headerlink" title="算法设计技术"></a>算法设计技术</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在，设计算法的必要条件都已经具备了，如何设计一个算法来解决一个特定的问题呢？这正是本书讨论的主题。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法设计技术（algorithm design technique, 也称算法设计策略）是设计算法的一般性方法，可用于解决不同计算领域的多种问题。本书讨论的算法设计技术已经被证明是对算法设计非常有用的通用技术，包括蛮力法、分治法、减治法、动态规划法、贪心法、回溯法，分支限界法、概率算法、近似算法等。这些算法设计技术构成了一组强有力的工具，在为新问题（即没有令人满意的已知算法可以解决的问题）设计算法时，可以运用这些技术设计出新的算法。算法设计技术作为问题求解的一般性策略，在解决计算机领域以外的问题时，也能发挥相当大的作用，读者在日后的学习和工作中将会发现学习算法设计技术的好处。</p>
<h3 id="描述算法"><a href="#描述算法" class="headerlink" title="描述算法"></a>描述算法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在构思和设计了一个算法之后，必须清楚准确的将所设计的求解步骤记录下载，即描述算法。描述算法的常用方法有自然语言，流程图，程序设计语言和伪代码等，其中伪代码是比较合适的描述算法的方法。</p>
<h3 id="跟踪算法"><a href="#跟踪算法" class="headerlink" title="跟踪算法"></a>跟踪算法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;逻辑错误无法由计算机检测出来，因为计算机只会执行程序，而不会理解动机。经验和研究都表明，发现算法（或程序）中的逻辑错误的重要方法就是系统地跟踪算法。跟踪必须要用“心和手”来进行，跟踪者要像计算机一样，用一组输入值来执行该算法，并且这组输入值要最大可能的暴露算法中的错误。即使有十年经验的高级软件工程师，也经常使用该方法查找算法中的逻辑错误。</p>
<h3 id="分析算法的效率"><a href="#分析算法的效率" class="headerlink" title="分析算法的效率"></a>分析算法的效率</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法有俩种效率：时间效率和空间效率，时间效率显示了算法运行的有多快，空间效率则显示了算法需要多少额外的存储空间，相比而言，我们更加关注算法的时间效率。事实上，计算机所有应用问题，包括计算机自身的发展，都是围绕着“时间——速度”这样一个中心进行的。一般来说，一个好的算法首先应该是比同类算法的时间效率高，算法的时间效率用时间复杂度性来度量。</p>
<h3 id="根据算法编写代码"><a href="#根据算法编写代码" class="headerlink" title="根据算法编写代码"></a>根据算法编写代码</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现代计算机技术还不能讲伪代码形式的算法直接“输入”进计算机中，而需要把算法转变为特定的程序设计语言编写的程序，算法中的一条指令可能对应实际程序中的多条指令。在把算法转变为程序的过程中，虽然现代编译器提供了代码优化功能，但仍需要一些标准的技巧，比如，在循环之外计算循环中的不变式、合并公共子表达式、用开销低的操作替代开销高的操作等。一般来说，这样的优化对算法速度的影响是一个常数因子，可能会使程序提高10% ~ 50% 的速度。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法设计的一般过程如 图 1. 所示。需要强调的是，一个好的算法是反复努力和重新修正的结果，所以，即使幸运的得到了一个貌似完美的算法，也应该尝试的改进它，那么，什么时候应该停止这种改进呢？设计算法是一种工程行为，需要在资源有限的情况下，在互斥的目标之间进行权衡。设计者的时间显然也是一种资源，在实际应用中，常常是项目进度表迫使我们停止改进算法。<br><img src="/uploads/2014-11-09-01.png" title="图 1. 算法设计的一般过程" /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/08/29/Tomcat%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/08/29/Tomcat%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Tomcat配置总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-08-29 15:20:31" itemprop="dateCreated datePublished" datetime="2014-08-29T15:20:31+08:00">2014-08-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index">
                    <span itemprop="name">Web容器</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Tomcat-简介"><a href="#Tomcat-简介" class="headerlink" title="Tomcat 简介"></a>Tomcat 简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tomcat是Apache 软件基金会（Apache Software Foundation）的一个核心项目，主要由Apache组织、Sun 公司开发而成。在Tomcat中最新的Servlet 和JSP规范总是能得到很好的体现，主要原因大概就是Tomcat的发展历程有Sun的提倡和参与建立。由于Tomcat性能相对较稳定，技术也相对比较新且免费开源；是当前相对比较流行的Web容器。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tomcat 的配置文件是一个格式化的XML文档，所有配置信息都在conf/server.xml文件中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8085"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JasperListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span>  <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span> </span></span><br><span class="line"><span class="tag">		<span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span>  <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">maxPostSize</span>=<span class="string">"5120000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8089"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span>  <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span>  <span class="attr">prefix</span>=<span class="string">"localhost_access_log."</span> <span class="attr">suffix</span>=<span class="string">".txt"</span> <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以下简单介绍几个常用的配置标签以及属性。</p>
<h3 id="Server标签"><a href="#Server标签" class="headerlink" title="Server标签"></a>Server标签</h3><p><font color=red><b>Server</b></font>标签代表了整个Catalina servlet容器。 因此，它必须是conf/server.xml配置文件中的单个根标签。 其属性代表了整个servlet容器所具有的特性。<br>基本属性如下：<br>&nbsp;&nbsp;1&gt; <font color=red><b>className</b></font> ：值为Java实现类的名称。 这个类必须实现org.apache.catalina.Server接口。 如果没有指定类名，则使用标准实现类名称（Server的标准实现是org.apache.catalina.core.StandardServer）。<br>&nbsp;&nbsp;2&gt; <font color=red><b>address</b></font> ：值为服务器等待关机命令的TCP / IP地址。 如果没有指定地址，则使用localhost地址。<br>&nbsp;&nbsp;3&gt; <font color=red><b>port</b></font> ：值为服务器等待关机命令的TCP / IP端口号。 设置值为-1则，禁用关闭端口。<br>&nbsp;&nbsp;4&gt; <font color=red><b>shutdown</b></font> ：值为通过TCP / IP连接接收到指定端口号的命令字符串来关闭Tomcat</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	... // 其他配置</span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Service标签"><a href="#Service标签" class="headerlink" title="Service标签"></a>Service标签</h3><p><font color=red><b>Service</b></font>标签表示一个或多个连接器组件的组合，这些组件共享一个用于处理传入请求的引擎组件。 一个或多个Service标签可以嵌套在Server标签中。<br>基本属性如下：<br>&nbsp;&nbsp;1&gt; <font color=red><b>className</b></font> ：值为Java实现类的名称。 这个类必须实现org.apache.catalina.Service接口。 如果没有指定类名，则使用标准实现（Service的标准实现是org.apache.catalina.core.StandardService）。<br>&nbsp;&nbsp;2&gt; <font color=red><b>name</b></font> ：值为服务的显示名称，如果您使用标准Catalina组件，将包含在日志消息中。 与特定服务器关联的每个服务的名称必须是唯一的。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Executor标签"><a href="#Executor标签" class="headerlink" title="Executor标签"></a>Executor标签</h3><p><font color=red><b>Executor</b></font>表示可以在Tomcat中的组件之间共享的线程池。 虽然每个连接器都可以创建了一个线程池，但是我们也可以在多个连接器之间共享一个线程池。执行线程的执行者必须实现org.apache.catalina.Executor接口。执行程序是Service标签的嵌套标签。 为了让连接器获取它，Executor标签必须配置在server.xml中的Connector标签之前<br>基本属性如下：<br>&nbsp;&nbsp;1&gt; <font color=red><b>className</b></font> ：值为Java实现类名，该类必须实现org.apache.catalina.Executor接口。 该接口确保对象可以通过其名称属性进行引用，并实现生命周期，以便可以使用容器启动和停止该对象。 (className的默认值是org.apache.catalina.core.StandardThreadExecutor)<br>&nbsp;&nbsp;2&gt; <font color=red><b>name</b></font> ：值为用于在server.xml中的其他位置引用此池的名称。 该名称是必填项，并且是全局唯一的。</p>
<p>默认的实现类（org.apache.catalina.core.StandardThreadExecutor）支持如下属性：<br>&nbsp;&nbsp;1&gt; <font color=red><b>threadPriority</b></font> ：(Integer)线程优先级，默认为5(Thread.NORM_PRIORITY常量的值)<br>&nbsp;&nbsp;2&gt; <font color=red><b>daemon</b></font> ：(Boolean)线程是否为守护线程，默认是true<br>&nbsp;&nbsp;3&gt; <font color=red><b>namePrefix</b></font> ：(String)线程的名称前缀。格式(namePrefix + threadNumber)<br>&nbsp;&nbsp;4&gt; <font color=red><b>maxThreads</b></font> ：(Integer)线程池中活动线程的最大数量，默认值为200<br>&nbsp;&nbsp;5&gt; <font color=red><b>minSpareThreads</b></font> ：(Integer)始终保持活动状态的线程的最小数量，默认值为25<br>&nbsp;&nbsp;6&gt; <font color=red><b>maxIdleTime</b></font> ：(Integer)空闲线程关闭之前的毫秒数，默认值是60000ms<br>&nbsp;&nbsp;7&gt; <font color=red><b>maxQueueSize</b></font> ：(Integer)排队等待执行的最大可运行任务数。 默认值是Integer.MAX_VALUE<br>&nbsp;&nbsp;8&gt; <font color=red><b>prestartminSpareThreads</b></font> ：(Boolean)启动Executor时是否启动minSpareThreads，默认是false<br>&nbsp;&nbsp;9&gt; <font color=red><b>threadRenewalDelay</b></font> ：(Long)如果配置了ThreadLocalLeakPreventionListener，它会通知这个执行者关于停止的上下文。 上下文停止后，池中的线程将被更新。 为了避免同时更新所有的线程，这个选项设置了更新任何2个线程之间的延迟。 该值以毫秒为单位，默认值为1000毫秒。 如果值是负数，线程不会被更新。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">		...</span><br><span class="line">		<span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">"maxsoftThreadPool"</span> <span class="attr">namePrefix</span>=<span class="string">"maxsoft-exec-"</span>  <span class="attr">maxThreads</span>=<span class="string">"100"</span> <span class="attr">minSpareThreads</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">		...</span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Connector标签之HTTP协议"><a href="#Connector标签之HTTP协议" class="headerlink" title="Connector标签之HTTP协议"></a>Connector标签之HTTP协议</h3><p><font color=red><b>HTTP</b></font>连接器标签表示支持HTTP / 1.1协议的连接器组件。 它使Catalina除了能够执行servlet和JSP页面外，还可以作为独立的Web服务器。 此组件的特定实例将监听服务器上特定TCP端口号的连接。 一个或多个这样的连接器可以配置为单个服务的一部分，每个连接器都可以转发给关联的引擎执行请求处理并创建响应。<br>连接器的所有实现都支持以下属性：<br>&nbsp;&nbsp;1&gt; <font color=red><b>allowTrace</b></font>：用于启用或禁用TRACE方法，默认值为false<br>&nbsp;&nbsp;2&gt; <font color=red><b>asyncTimeout</b></font>：异步请求的默认超时时间(毫秒)，默认值为10000ms<br>&nbsp;&nbsp;3&gt; <font color=red><b>enableLookups</b></font>：配置是否需要调用request.getRemoteHost()来执行DNS查找并返回远程客户端的实际主机名。默认值为false(以字符串形式返回IP地址)<br>&nbsp;&nbsp;4&gt; <font color=red><b>maxHeaderCount</b></font>：容器允许的最大请求头数，默认值100<br>&nbsp;&nbsp;5&gt; <font color=red><b>maxParameterCount</b></font>：参数和值对（GET和POST）的最大数量将由容器自动解析，如果超出此限制的参数和值对将被忽略。 小于0的值意味着没有限制。 默认值为10000<br>&nbsp;&nbsp;6&gt; <font color=red><b>maxPostSize</b></font>：将由容器FORM URL参数分析处理的POST的最大字节数。 通过将此属性设置为小于零的值可以禁用限制。 默认值为2097152（2MB）。<br>&nbsp;&nbsp;7&gt; <font color=red><b>maxSavePostSize</b></font>：在FORM或CLIENT-CERT身份验证期间，容器将保存/缓存的POST的最大数据（单位KB）。 对于这两种身份验证，POST都将在用户通过身份验证之前保存/缓存。 对于CLIENT-CERT认证，POST在SSL握手期间被缓冲，并且在请求被处理时清空缓冲器。 对于FORM认证，当用户被重定向到登录表单时，POST被保存，并保留到用户成功认证或与认证请求关联的会话过期。 可以通过将此属性设置为-1来禁用限制。 将该属性设置为零将禁用在验证过程中保存POST数据。 默认值为4096（4kb）。<br>&nbsp;&nbsp;8&gt; <font color=red><b>parseBodyMethods</b></font>：一个用逗号分隔的HTTP方法列表，为其请求参数将被解析为与POST相同的请求参数。 这对于希望支持PUT请求的POST风格语义的RESTful应用程序非常有用。 注意，除POST之外的任何设置都会导致Tomcat的行为违背了servlet规范的意图。 根据HTTP规范，这里特别禁止HTTP方法TRACE。 默认值POST<br>&nbsp;&nbsp;9&gt; <font color=red><b>port</b></font>：TCP端口号，如果设置为0，则Tomcat将随机选择一个空闲端口用于该连接器。<br>&nbsp;&nbsp;10&gt; <font color=red><b>protocol</b></font>：设置协议类别，默认是HTTP/1.1。它使用自动切换机制来选择阻塞的基于Java的连接器或基于APR /本机的连接器。如果PATH（Windows）或LD_LIBRARY_PATH（在大多数unix系统上）环境变量包含Tomcat本机库，则将使用APR /本机连接器。如果找不到本地库，将使用阻塞的基于Java的连接器。请注意，APR /本机连接器具有与Java连接器不同的HTTPS设置。<br>为了使用明确的协议而不是依靠上述的自动切换机制，可以使用以下值：<br>org.apache.coyote.http11.Http11Protocol - 阻止Java连接器<br>org.apache.coyote.http11.Http11NioProtocol - 非阻塞的Java连接器<br>org.apache.coyote.http11.Http11AprProtocol - APR /本地连接器。<br>&nbsp;&nbsp;11&gt; <font color=red><b>proxyName</b></font>：代理服务器名称。如果在代理配置中使用该连接器，则配置该属性是要指定要调用request.getServerName()时要返回的服务器名称。<br>&nbsp;&nbsp;12&gt; <font color=red><b>proxyPort</b></font>：代理服务端口。如果在代理配置中使用该连接器，则配置该属性是要指定要调用request.getServerPort()时要返回的服务器端口号。<br>&nbsp;&nbsp;13&gt; <font color=red><b>redirectPort</b></font>：重定向端口。如果该连接器支持非SSL请求，并且收到匹配的<security-constraint>需要SSL传输的请求，Catalina将自动将请求重定向到此处指定的端口号。<br>&nbsp;&nbsp;14&gt; <font color=red><b>scheme</b></font>：协议名称。可以通过调用request.getScheme()返回协议的名称。 默认值是HTTP。<br>&nbsp;&nbsp;15&gt; <font color=red><b>secure</b></font>：是否加密。如果您希望调用request.isSecure（）以对此连接器接收到的请求返回true，请将此属性设置为true。 您可能希望在SSL连接器或从SSL加速器接收数据的非SSL连接器（如加密卡，SSL设备甚至Web服务器）上使用此连接器。 默认值是false。<br>&nbsp;&nbsp;16&gt; <font color=red><b>URIEncoding</b></font>：设置用于解码URI字节的字符编码，在％xx解码URL之后。 默认值是ISO-8859-1。<br>&nbsp;&nbsp;17&gt; <font color=red><b>useBodyEncodingForURI</b></font>：这指定了contentType中指定的编码是否应该用于URI查询参数，而不是使用URIEncoding。 此设置用于与Tomcat 4.1.x兼容，其中contentType中指定的编码或使用Request.setCharacterEncoding方法显式设置的编码也用于URL中的参数。 默认值是false。<br>&nbsp;&nbsp;18&gt; <font color=red><b>useIPVHosts</b></font>：将此属性设置为true可使Tomcat使用收到请求的IP地址来确定发送请求的主机。 默认值是false。<br>&nbsp;&nbsp;19&gt; <font color=red><b>xpoweredBy</b></font>：将此属性设置为true，以使Tomcat通过使用规范中建议的头部进行对Servlet规范的支持。 默认值是false。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">		...</span><br><span class="line">		<span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">"maxsoftThreadPool"</span> <span class="attr">namePrefix</span>=<span class="string">"maxsoft-exec-"</span>  <span class="attr">maxThreads</span>=<span class="string">"100"</span> <span class="attr">minSpareThreads</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">maxPostSize</span>=<span class="string">"5120000"</span>  <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span>/&gt;</span></span><br><span class="line">		...</span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>标准HTTP连接器（BIO，NIO和APR / native）除了上面列出的常见连接器属性外，还支持以下属性：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#Standard_Implementation" target="_blank" rel="noopener">标准HTTP连接器属性</a></p>
<p>除了上面列出的通用连接器和HTTP属性外，BIO和NIO实现还支持以下Java TCP套接字属性：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#Java_TCP_socket_attributes" target="_blank" rel="noopener">BIO和NIO实现支持属性</a></p>
<p>以下属性是特定于BIO连接器的：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#BIO_specific_configuration" target="_blank" rel="noopener">特定于BIO连接器属性</a></p>
<p>以下属性是特定于NIO连接器的：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#NIO_specific_configuration" target="_blank" rel="noopener">特定于NIO连接器属性</a></p>
<p>以下属性是特定于APR /本机连接器:<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#APR/native_specific_configuration" target="_blank" rel="noopener">特定于APR /本机连接器属性</a></p>
<p>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html" target="_blank" rel="noopener">HTTP连接器</a></p>
<h3 id="Connector标签之AJP协议"><a href="#Connector标签之AJP协议" class="headerlink" title="Connector标签之AJP协议"></a>Connector标签之AJP协议</h3><p><font color=red><b>AJP</b></font>连接器标签表示一个连接器组件，通过AJP协议与Web连接器进行通信。 这适用于将Tomcat无形集成到现有（或新的）Apache安装中的情况，并希望Apache处理Web应用程序中包含的静态内容和/或使用Apache的SSL处理。该连接器在与引擎的jvmRoute属性结合使用时支持负载平衡。<br>其配置属性基本和HTTP类似，详情可以移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/ajp.html" target="_blank" rel="noopener">AJP连接器</a></p>
<h3 id="Engine标签"><a href="#Engine标签" class="headerlink" title="Engine标签"></a>Engine标签</h3><p><font color=red><b>Engine</b></font>标签表示与特定的Catalina服务相关联的整个请求处理机器。 它接收并处理来自一个或多个连接器的所有请求，并将完成的响应返回给连接器，以便最终传输回客户端。一个引擎标签必须嵌套在一个Service标签内，跟随与这个Service相关的所有对应的Connector标签。</p>
<p>引擎的所有实现都支持以下属性：<br>&nbsp;&nbsp;1&gt; <font color=red><b>backgroundProcessorDelay</b></font>：该值表示调用该引擎上的backgroundProcess方法与其子容器（包括所有主机和上下文）之间的延迟（以秒为单位）。 如果子容器的延迟值不是负数（这意味着他们正在使用自己的处理线程），子容器将不会被调用。 将其设置为正值将导致线程产生。 等待指定的时间后，线程将调用该引擎及其所有子容器上的backgroundProcess方法。 默认值为10，表示延迟10秒。<br>&nbsp;&nbsp;2&gt; <font color=red><b>className</b></font>：值为Java实现类的名称。 这个类必须实现org.apache.catalina.Engine接口。默认是为标准实现类（Engine的标准实现是org.apache.catalina.core.StandardEngine）。<br>&nbsp;&nbsp;3&gt; <font color=red><b>defaultHost</b></font>：默认主机名，用于标识将处理指向该服务器上主机名称但未在此配置文件中配置的请求的主机。 这个名字必须匹配其中一个嵌套的主机元素的名字属性。<br>&nbsp;&nbsp;4&gt; <font color=red><b>jvmRoute</b></font>：必须在负载平衡场景中使用的标识符才能启用会话共享。 该标识符必须在参与群集的所有Tomcat服务器中唯一，它将被附加到生成的会话标识符中，因此允许前端代理始终将特定会话转发到同一个Tomcat实例。注意，jvmRoute也可以使用jvmRoute系统属性进行设置。 在<Engine>属性中设置的jvmRoute将覆盖任何jvmRoute系统属性。<br>&nbsp;&nbsp;5&gt; <font color=red><b>name</b></font>：该引擎的逻辑名称，用于日志和错误消息。 在同一服务器中使用多个服务标签时，每个引擎必须分配一个唯一的名称。<br>&nbsp;&nbsp;6&gt; <font color=red><b>startStopThreads</b></font>：该引擎将用于并行启动子主机标签的线程数，默认值是1。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">		... </span><br><span class="line">	  <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><a href="http://tomcat.apache.org/tomcat-7.0-doc/config/engine.html" target="_blank" rel="noopener">详细配置</a></p>
<h3 id="Host标签"><a href="#Host标签" class="headerlink" title="Host标签"></a>Host标签</h3><p>Host标签表示一个虚拟主机，它是一个服务器的网络名称（如“<a href="http://www.maxsoft.org”）与运行Tomcat的特定服务器的关联。" target="_blank" rel="noopener">www.maxsoft.org”）与运行Tomcat的特定服务器的关联。</a></p>
<p>主机的所有实现都支持以下属性：</p>
<p>&nbsp;&nbsp;1&gt; <font color=red><b>appBase</b></font>：该虚拟主机的应用程序根目录，默认值是webapps<br>&nbsp;&nbsp;2&gt; <font color=red><b>xmlBase</b></font>：该虚拟主机的XML的根目录，默认值是conf / <engine_name> / <host_name>的值。<br>&nbsp;&nbsp;3&gt; <font color=red><b>createDirs</b></font>：默认值是true。Tomcat尝试在启动阶段创建由属性appBase和xmlBase定义的目录。<br>&nbsp;&nbsp;4&gt; <font color=red><b>autoDeploy</b></font>：该值指示Tomcat是否应在Tomcat运行时定期检查新的或更新的Web应用程序。 默认值为true。<br>&nbsp;&nbsp;4&gt; <font color=red><b>backgroundProcessorDelay</b></font>：该值表示在该主机上调用backgroundProcess方法与其子容器（包括所有上下文）之间的延迟（以秒为单位）。默认值为-1<br>&nbsp;&nbsp;5&gt; <font color=red><b>className</b></font>：该值为Java实现类的名称，这个类必须实现org.apache.catalina.Host接口。默认值标准实现（org.apache.catalina.core.StandardHost）<br>&nbsp;&nbsp;6&gt; <font color=red><b>deployIgnore</b></font>：用于定义在设置autoDeploy和deployOnStartup时要忽略的路径<br>&nbsp;&nbsp;7&gt; <font color=red><b>deployOnStartup</b></font>：该值指示在Tomcat启动时是否应自动部署此主机的Web应用程序。默认为true<br>&nbsp;&nbsp;8&gt; <font color=red><b>failCtxIfServletStartFails</b></font>：每个子上下文可以覆盖这个属性，默认值为false<br>&nbsp;&nbsp;9&gt; <font color=red><b>name</b></font>：虚拟主机的网络名称。<br>&nbsp;&nbsp;10&gt; <font color=red><b>startStopThreads</b></font>：该主机将用于并行启动子上下文元素的线程数。默认值为1<br>&nbsp;&nbsp;11&gt; <font color=red><b>undeployOldVersions</b></font>：该值作为自动部署过程的一部分的Tomcat是否将检查使用并行部署部署的旧的，未使用的Web应用程序版本，如果找到，则将其删除。 该值仅适用于autoDeploy为true的情况，默认值false。</p>
<p><a href="http://tomcat.apache.org/tomcat-7.0-doc/config/host.html" target="_blank" rel="noopener">详细配置</a></p>
<p>More info: <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat Home</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/08/10/%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%20Java%20IO%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/08/10/%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%20Java%20IO%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">深入分析 Java I/O 的工作机制</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-08-10 20:01:11" itemprop="dateCreated datePublished" datetime="2014-08-10T20:01:11+08:00">2014-08-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%AC%E8%BD%BD/" itemprop="url" rel="index">
                    <span itemprop="name">转载</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Java-的-I-O-类库的基本架构"><a href="#Java-的-I-O-类库的基本架构" class="headerlink" title="Java 的 I/O 类库的基本架构"></a>Java 的 I/O 类库的基本架构</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I/O 问题是任何编程语言都无法回避的问题，可以说 I/O 问题是整个人机交互的核心问题，因为 I/O 是机器获取和交换信息的主要渠道。在当今这个数据大爆炸时代，I/O 问题尤其突出，很容易成为一个性能瓶颈。正因如此，所以 Java 在 I/O 上也一直在做持续的优化，如从 1.4 开始引入了 NIO，提升了 I/O 的性能。关于 NIO 我们将在后面详细介绍。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Java 的 I/O 操作类在包 java.io 下，大概有将近 80 个类，但是这些类大概可以分成四组，分别是：<br>1&sdot;&nbsp;基于字节操作的 I/O 接口：InputStream 和 OutputStream<br>2&sdot;&nbsp;基于字符操作的 I/O 接口：Writer 和 Reader<br>3&sdot;&nbsp;基于磁盘操作的 I/O 接口：File<br>4&sdot;&nbsp;基于网络操作的 I/O 接口：Socket<br>前两组主要是根据传输数据的数据格式，后两组主要是根据传输数据的方式，虽然 Socket 类并不在 java.io 包下，但是我仍然把它们划分在一起，因为我个人认为 I/O 的核心问题要么是数据格式影响 I/O 操作，要么是传输方式影响 I/O 操作，也就是将什么样的数据写到什么地方的问题，I/O 只是人与机器或者机器与机器交互的手段，除了在它们能够完成这个交互功能外，我们关注的就是如何提高它的运行效率了，而数据格式和传输方式是影响效率最关键的因素了。我们后面的分析也是基于这两个因素来展开的。</p>
<h2 id="基于字节的-I-O-操作接口"><a href="#基于字节的-I-O-操作接口" class="headerlink" title="基于字节的 I/O 操作接口"></a>基于字节的 I/O 操作接口</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基于字节的 I/O 操作接口输入和输出分别是：InputStream 和 OutputStream，InputStream 输入流的类继承层次如下图所示：<br>图 1. InputStream 相关类层次结构<br><img src='/uploads/ibm_2014-08-10-1.png'/>输入流根据数据类型和操作方式又被划分成若干个子类，每个子类分别处理不同操作类型，OutputStream 输出流的类层次结构也是类似，如下图所示：<br><img src='/uploads/ibm_2014-08-10-2.png'/>这里就不详细解释每个子类如何使用了，如果不清楚的话可以参考一下 JDK 的 API 说明文档，这里只想说明两点，一个是操作数据的方式是可以组合使用的，如这样组合使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutputStream out = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"fileName"</span>))</span><br></pre></td></tr></table></figure>
<p>还有一点是流最终写到什么地方必须要指定，要么是写到磁盘要么是写到网络中，其实从上面的类图中我们发现，写网络实际上也是写文件，只不过写网络还有一步需要处理就是底层操作系统再将数据传送到其它地方而不是本地磁盘。关于网络 I/O 和磁盘 I/O 我们将在后面详细介绍。</p>
<h2 id="基于字符的-I-O-操作接口"><a href="#基于字符的-I-O-操作接口" class="headerlink" title="基于字符的 I/O 操作接口"></a>基于字符的 I/O 操作接口</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不管是磁盘还是网络传输，最小的存储单元都是字节，而不是字符，所以 I/O 操作的都是字节而不是字符，但是为啥有操作字符的 I/O 接口呢？这是因为我们的程序中通常操作的数据都是以字符形式，为了操作方便当然要提供一个直接写字符的 I/O 接口，如此而已。我们知道字符到字节必须要经过编码转换，而这个编码又非常耗时，而且还会经常出现乱码问题，所以 I/O 的编码问题经常是让人头疼的问题。关于 I/O 编码问题请参考另一篇文章<a href="https://www.ibm.com/developerworks/cn/java/j-lo-chinesecoding/" target="_blank" rel="noopener">《深入分析Java中的中文编码问题》</a>。<br>下图是写字符的 I/O 操作接口涉及到的类，Writer 类提供了一个抽象方法 write(char cbuf[], int off, int len) 由子类去实现。<br>图 3. Writer 相关类层次结构<img src='/uploads/ibm_2014-08-10-3.png'/>读字符的操作接口也有类似的类结构，如下图所示：<br>图 4.Reader 类层次结构<img src='/uploads/ibm_2014-08-10-4.png'/>读字符的操作接口中也是 int read(char cbuf[], int off, int len)，返回读到的 n 个字节数，不管是 Writer 还是 Reader 类它们都只定义了读取或写入的数据字符的方式，也就是怎么写或读，但是并没有规定数据要写到哪去，写到哪去就是我们后面要讨论的基于磁盘和网络的工作机制。</p>
<h2 id="字节与字符的转化接口"><a href="#字节与字符的转化接口" class="headerlink" title="字节与字符的转化接口"></a>字节与字符的转化接口</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外数据持久化或网络传输都是以字节进行的，所以必须要有字符到字节或字节到字符的转化。字符到字节需要转化，其中读的转化过程如下图所示：<br>图 5. 字符解码相关类结构<img src='/uploads/ibm_2014-08-10-5.jpg'/>InputStreamReader 类是字节到字符的转化桥梁，InputStream 到 Reader 的过程要指定编码字符集，否则将采用操作系统默认字符集，很可能会出现乱码问题。StreamDecoder 正是完成字节到字符的解码的实现类。也就是当你用如下方式读取一个文件时：<br>清单 1.读取文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">           StringBuffer str = <span class="keyword">new</span> StringBuffer(); </span><br><span class="line">           <span class="keyword">char</span>[] buf = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">1024</span>]; </span><br><span class="line">           FileReader f = <span class="keyword">new</span> FileReader(<span class="string">"file"</span>); </span><br><span class="line">           <span class="keyword">while</span>(f.read(buf)&gt;<span class="number">0</span>)&#123; </span><br><span class="line">               str.append(buf); </span><br><span class="line">           &#125; </span><br><span class="line">           str.toString(); </span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>FileReader 类就是按照上面的工作方式读取文件的，FileReader 是继承了 InputStreamReader 类，实际上是读取文件流，然后通过 StreamDecoder 解码成 char，只不过这里的解码字符集是默认字符集。<br>写入也是类似的过程如下图所示：<br>图 6. 字符编码相关类结构<img src='/uploads/ibm_2014-08-10-6.jpg'/>通过 OutputStreamWriter 类完成，字符到字节的编码过程，由 StreamEncoder 完成编码过程</p>
<h2 id="磁盘-I-O-工作机制"><a href="#磁盘-I-O-工作机制" class="headerlink" title="磁盘 I/O 工作机制"></a>磁盘 I/O 工作机制</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前面介绍了基本的 Java I/O 的操作接口，这些接口主要定义了如何操作数据，以及介绍了操作两种数据结构：字节和字符的方式。还有一个关键问题就是数据写到何处，其中一个主要方式就是将数据持久化到物理磁盘，下面将介绍如何将数据持久化到物理磁盘的过程。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们知道数据在磁盘的唯一最小描述就是文件，也就是说上层应用程序只能通过文件来操作磁盘上的数据，文件也是操作系统和磁盘驱动器交互的一个最小单元。值得注意的是 Java 中通常的 File 并不代表一个真实存在的文件对象，当你通过指定一个路径描述符时，它就会返回一个代表这个路径相关联的一个虚拟对象，这个可能是一个真实存在的文件或者是一个包含多个文件的目录。为何要这样设计？因为大部分情况下，我们并不关心这个文件是否真的存在，而是关心这个文件到底如何操作。例如我们手机里通常存了几百个朋友的电话号码，但是我们通常关心的是我有没有这个朋友的电话号码，或者这个电话号码是什么，但是这个电话号码到底能不能打通，我们并不是时时刻刻都去检查，而只有在真正要给他打电话时才会看这个电话能不能用。也就是使用这个电话记录要比打这个电话的次数多很多。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;何时真正会要检查一个文件存不存？就是在真正要读取这个文件时，例如 FileInputStream 类都是操作一个文件的接口，注意到在创建一个 FileInputStream 对象时，会创建一个 FileDescriptor 对象，其实这个对象就是真正代表一个存在的文件对象的描述，当我们在操作一个文件对象时可以通过 getFD() 方法获取真正操作的与底层操作系统关联的文件描述。例如可以调用 FileDescriptor.sync() 方法将操作系统缓存中的数据强制刷新到物理磁盘中。<br>下面以清单 1 的程序为例，介绍下如何从磁盘读取一段文本字符。如下图所示：<br>图 7. 从磁盘读取文件<img src='/uploads/ibm_2014-08-10-7.jpg'/>当传入一个文件路径，将会根据这个路径创建一个 File 对象来标识这个文件，然后将会根据这个 File 对象创建真正读取文件的操作对象，这时将会真正创建一个关联真实存在的磁盘文件的文件描述符 FileDescriptor，通过这个对象可以直接控制这个磁盘文件。由于我们需要读取的是字符格式，所以需要 StreamDecoder 类将 byte 解码为 char 格式，至于如何从磁盘驱动器上读取一段数据，由操作系统帮我们完成。至于操作系统是如何将数据持久化到磁盘以及如何建立数据结构需要根据当前操作系统使用何种文件系统来回答，至于文件系统的相关细节可以参考另外的文章。</p>
<h2 id="Java-Socket-的工作机制"><a href="#Java-Socket-的工作机制" class="headerlink" title="Java Socket 的工作机制"></a>Java Socket 的工作机制</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Socket 这个概念没有对应到一个具体的实体，它是描述计算机之间完成相互通信一种抽象功能。打个比方，可以把 Socket 比作为两个城市之间的交通工具，有了它，就可以在城市之间来回穿梭了。交通工具有多种，每种交通工具也有相应的交通规则。Socket 也一样，也有多种。大部分情况下我们使用的都是基于 TCP/IP 的流套接字，它是一种稳定的通信协议。<br>下图是典型的基于 Socket 的通信的场景：<br>图 8.Socket 通信示例<img src='/uploads/ibm_2014-08-10-8.jpg'/>主机 A 的应用程序要能和主机 B 的应用程序通信，必须通过 Socket 建立连接，而建立 Socket 连接必须需要底层 TCP/IP 协议来建立 TCP 连接。建立 TCP 连接需要底层 IP 协议来寻址网络中的主机。我们知道网络层使用的 IP 协议可以帮助我们根据 IP 地址来找到目标主机，但是一台主机上可能运行着多个应用程序，如何才能与指定的应用程序通信就要通过 TCP 或 UPD 的地址也就是端口号来指定。这样就可以通过一个 Socket 实例唯一代表一个主机上的一个应用程序的通信链路了。</p>
<h2 id="建立通信链路"><a href="#建立通信链路" class="headerlink" title="建立通信链路"></a>建立通信链路</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当客户端要与服务端通信，客户端首先要创建一个 Socket 实例，操作系统将为这个 Socket 实例分配一个没有被使用的本地端口号，并创建一个包含本地和远程地址和端口号的套接字数据结构，这个数据结构将一直保存在系统中直到这个连接关闭。在创建 Socket 实例的构造函数正确返回之前，将要进行 TCP 的三次握手协议，TCP 握手协议完成后，Socket 实例对象将创建完成，否则将抛出 IOException 错误。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;与之对应的服务端将创建一个 ServerSocket 实例，ServerSocket 创建比较简单只要指定的端口号没有被占用，一般实例创建都会成功，同时操作系统也会为 ServerSocket 实例创建一个底层数据结构，这个数据结构中包含指定监听的端口号和包含监听地址的通配符，通常情况下都是“*”即监听所有地址。之后当调用 accept() 方法时，将进入阻塞状态，等待客户端的请求。当一个新的请求到来时，将为这个连接创建一个新的套接字数据结构，该套接字数据的信息包含的地址和端口信息正是请求源地址和端口。这个新创建的数据结构将会关联到 ServerSocket 实例的一个未完成的连接数据结构列表中，注意这时服务端与之对应的 Socket 实例并没有完成创建，而要等到与客户端的三次握手完成后，这个服务端的 Socket 实例才会返回，并将这个 Socket 实例对应的数据结构从未完成列表中移到已完成列表中。所以 ServerSocket 所关联的列表中每个数据结构，都代表与一个客户端的建立的 TCP 连接。</p>
<h2 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;传输数据是我们建立连接的主要目的，如何通过 Socket 传输数据，下面将详细介绍。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当连接已经建立成功，服务端和客户端都会拥有一个 Socket 实例，每个 Socket 实例都有一个 InputStream 和 OutputStream，正是通过这两个对象来交换数据。同时我们也知道网络 I/O 都是以字节流传输的。当 Socket 对象创建时，操作系统将会为 InputStream 和 OutputStream 分别分配一定大小的缓冲区，数据的写入和读取都是通过这个缓存区完成的。写入端将数据写到 OutputStream 对应的 SendQ 队列中，当队列填满时，数据将被发送到另一端 InputStream 的 RecvQ 队列中，如果这时 RecvQ 已经满了，那么 OutputStream 的 write 方法将会阻塞直到 RecvQ 队列有足够的空间容纳 SendQ 发送的数据。值得特别注意的是，这个缓存区的大小以及写入端的速度和读取端的速度非常影响这个连接的数据传输效率，由于可能会发生阻塞，所以网络 I/O 与磁盘 I/O 在数据的写入和读取还要有一个协调的过程，如果两边同时传送数据时可能会产生死锁，在后面 NIO 部分将介绍避免这种情况。</p>
<h2 id="NIO-的工作方式"><a href="#NIO-的工作方式" class="headerlink" title="NIO 的工作方式"></a>NIO 的工作方式</h2><h3 id="BIO-带来的挑战"><a href="#BIO-带来的挑战" class="headerlink" title="BIO 带来的挑战"></a>BIO 带来的挑战</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIO 即阻塞 I/O，不管是磁盘 I/O 还是网络 I/O，数据在写入 OutputStream 或者从 InputStream 读取时都有可能会阻塞。一旦有线程阻塞将会失去 CPU 的使用权，这在当前的大规模访问量和有性能要求情况下是不能接受的。虽然当前的网络 I/O 有一些解决办法，如一个客户端一个处理线程，出现阻塞时只是一个线程阻塞而不会影响其它线程工作，还有为了减少系统线程的开销，采用线程池的办法来减少线程创建和回收的成本，但是有一些使用场景仍然是无法解决的。如当前一些需要大量 HTTP 长连接的情况，像淘宝现在使用的 Web 旺旺项目，服务端需要同时保持几百万的 HTTP 连接，但是并不是每时每刻这些连接都在传输数据，这种情况下不可能同时创建这么多线程来保持连接。即使线程的数量不是问题，仍然有一些问题还是无法避免的。如这种情况，我们想给某些客户端更高的服务优先级，很难通过设计线程的优先级来完成，另外一种情况是，我们需要让每个客户端的请求在服务端可能需要访问一些竞争资源，由于这些客户端是在不同线程中，因此需要同步，而往往要实现这些同步操作要远远比用单线程复杂很多。以上这些情况都说明，我们需要另外一种新的 I/O 操作方式。</p>
<h3 id="NIO-的工作机制"><a href="#NIO-的工作机制" class="headerlink" title="NIO 的工作机制"></a>NIO 的工作机制</h3><p>我们先看一下 NIO 涉及到的关联类图，如下：<br>图 9.NIO 相关类图<img src='/uploads/ibm_2014-08-10-9.jpg'/><br>上图中有两个关键类：Channel 和 Selector，它们是 NIO 中两个核心概念。我们还用前面的城市交通工具来继续比喻 NIO 的工作方式，这里的 Channel 要比 Socket 更加具体，它可以比作为某种具体的交通工具，如汽车或是高铁等，而 Selector 可以比作为一个车站的车辆运行调度系统，它将负责监控每辆车的当前运行状态：是已经出战还是在路上等等，也就是它可以轮询每个 Channel 的状态。这里还有一个 Buffer 类，它也比 Stream 更加具体化，我们可以将它比作为车上的座位，Channel 是汽车的话就是汽车上的座位，高铁上就是高铁上的座位，它始终是一个具体的概念，与 Stream 不同。Stream 只能代表是一个座位，至于是什么座位由你自己去想象，也就是你在去上车之前并不知道，这个车上是否还有没有座位了，也不知道上的是什么车，因为你并不能选择，这些信息都已经被封装在了运输工具（Socket）里面了，对你是透明的。NIO 引入了 Channel、Buffer 和 Selector 就是想把这些信息具体化，让程序员有机会控制它们，如：当我们调用 write() 往 SendQ 写数据时，当一次写的数据超过 SendQ 长度是需要按照 SendQ 的长度进行分割，这个过程中需要有将用户空间数据和内核地址空间进行切换，而这个切换不是你可以控制的。而在 Buffer 中我们可以控制 Buffer 的 capacity，并且是否扩容以及如何扩容都可以控制。<br>理解了这些概念后我们看一下，实际上它们是如何工作的，下面是典型的一段 NIO 代码：<br>清单 2. NIO 工作代码示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selector</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        Selector selector = Selector.open();</span><br><span class="line">        ServerSocketChannel ssc = ServerSocketChannel.open();</span><br><span class="line">        ssc.configureBlocking(<span class="keyword">false</span>);<span class="comment">//设置为非阻塞方式</span></span><br><span class="line">        ssc.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8080</span>));</span><br><span class="line">        ssc.register(selector, SelectionKey.OP_ACCEPT);<span class="comment">//注册监听的事件</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Set selectedKeys = selector.selectedKeys();<span class="comment">//取得所有key集合</span></span><br><span class="line">            Iterator it = selectedKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                SelectionKey key = (SelectionKey) it.next();</span><br><span class="line">                <span class="keyword">if</span> ((key.readyOps() &amp; SelectionKey.OP_ACCEPT) == SelectionKey.OP_ACCEPT) &#123;</span><br><span class="line">                    ServerSocketChannel ssChannel = (ServerSocketChannel) key.channel();</span><br><span class="line">                 SocketChannel sc = ssChannel.accept();<span class="comment">//接受到服务端的请求</span></span><br><span class="line">                    sc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    sc.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> </span><br><span class="line">                ((key.readyOps() &amp; SelectionKey.OP_READ) == SelectionKey.OP_READ) &#123;</span><br><span class="line">                    SocketChannel sc = (SocketChannel) key.channel();</span><br><span class="line">                    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                        buffer.clear();</span><br><span class="line">                        <span class="keyword">int</span> n = sc.read(buffer);<span class="comment">//读取数据</span></span><br><span class="line">                        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        buffer.flip();</span><br><span class="line">                    &#125;</span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 Selector 的静态工厂创建一个选择器，创建一个服务端的 Channel 绑定到一个 Socket 对象，并把这个通信信道注册到选择器上，把这个通信信道设置为非阻塞模式。然后就可以调用 Selector 的 selectedKeys 方法来检查已经注册在这个选择器上的所有通信信道是否有需要的事件发生，如果有某个事件发生时，将会返回所有的 SelectionKey，通过这个对象 Channel 方法就可以取得这个通信信道对象从而可以读取通信的数据，而这里读取的数据是 Buffer，这个 Buffer 是我们可以控制的缓冲器。<br>在上面的这段程序中，是将 Server 端的监听连接请求的事件和处理请求的事件放在一个线程中，但是在实际应用中，我们通常会把它们放在两个线程中，一个线程专门负责监听客户端的连接请求，而且是阻塞方式执行的；另外一个线程专门来处理请求，这个专门处理请求的线程才会真正采用 NIO 的方式，像 Web 服务器 Tomcat 和 Jetty 都是这个处理方式，关于 Tomcat 和 Jetty 的 NIO 处理方式可以参考文章《 Jetty 的工作原理和与 Tomcat 的比较》。<br>下图是描述了基于 NIO 工作方式的 Socket 请求的处理过程：<br>图 10. 基于 NIO 的 Socket 请求的处理过程<img src='/uploads/ibm_2014-08-10-10.jpg'/><br>上图中的 Selector 可以同时监听一组通信信道（Channel）上的 I/O 状态，前提是这个 Selector 要已经注册到这些通信信道中。选择器 Selector 可以调用 select() 方法检查已经注册的通信信道上的是否有 I/O 已经准备好，如果没有至少一个信道 I/O 状态有变化，那么 select 方法会阻塞等待或在超时时间后会返回 0。上图中如果有多个信道有数据，那么将会将这些数据分配到对应的数据 Buffer 中。所以关键的地方是有一个线程来处理所有连接的数据交互，每个连接的数据交互都不是阻塞方式，所以可以同时处理大量的连接请求。</p>
<h3 id="Buffer-的工作方式"><a href="#Buffer-的工作方式" class="headerlink" title="Buffer 的工作方式"></a>Buffer 的工作方式</h3><p>上面介绍了 Selector 将检测到有通信信道 I/O 有数据传输时，通过 selelct() 取得 SocketChannel，将数据读取或写入 Buffer 缓冲区。下面讨论一下 Buffer 如何接受和写出数据？<br>Buffer 可以简单的理解为一组基本数据类型的元素列表，它通过几个变量来保存这个数据的当前位置状态，也就是有四个索引。如下表所示：<br>表 1.Buffer 中的参数项<img src='/uploads/ibm_2014-08-10-11.png'/>在实际操作数据时它们有如下关系图：<img src='/uploads/ibm_2014-08-10-12.jpg'/><br>我们通过 ByteBuffer.allocate(11) 方法创建一个 11 个 byte 的数组缓冲区，初始状态如上图所示，position 的位置为 0，capacity 和 limit 默认都是数组长度。当我们写入 5 个字节时位置变化如下图所示：<img src='/uploads/ibm_2014-08-10-13.jpg'/><br>这时我们需要将缓冲区的 5 个字节数据写入 Channel 通信信道，所以我们需要调用 byteBuffer.flip() 方法，数组的状态又发生如下变化：<img src='/uploads/ibm_2014-08-10-14.jpg'/><br>这时底层操作系统就可以从缓冲区中正确读取这 5 个字节数据发送出去了。在下一次写数据之前我们在调一下 clear() 方法。缓冲区的索引状态又回到初始位置。<br>这里还要说明一下 mark，当我们调用 mark() 时，它将记录当前 position 的前一个位置，当我们调用 reset 时，position 将恢复 mark 记录下来的值。<br>还有一点需要说明，通过 Channel 获取的 I/O 数据首先要经过操作系统的 Socket 缓冲区再将数据复制到 Buffer 中，这个的操作系统缓冲区就是底层的 TCP 协议关联的 RecvQ 或者 SendQ 队列，从操作系统缓冲区到用户缓冲区复制数据比较耗性能，Buffer 提供了另外一种直接操作操作系统缓冲区的的方式即 ByteBuffer.allocateDirector(size)，这个方法返回的 byteBuffer 就是与底层存储空间关联的缓冲区，它的操作方式与 linux2.4 内核的 sendfile 操作方式类似。</p>
<h2 id="I-O-调优"><a href="#I-O-调优" class="headerlink" title="I/O 调优"></a>I/O 调优</h2><p>下面就磁盘 I/O 和网络 I/O 的一些常用的优化技巧进行总结如下：</p>
<h3 id="磁盘-I-O-优化"><a href="#磁盘-I-O-优化" class="headerlink" title="磁盘 I/O 优化"></a>磁盘 I/O 优化</h3><h4 id="性能检测"><a href="#性能检测" class="headerlink" title="性能检测"></a>性能检测</h4><p>我们的应用程序通常都需要访问磁盘读取数据，而磁盘 I/O 通常都很耗时，我们要判断 I/O 是否是一个瓶颈，我们有一些参数指标可以参考：<br>如我们可以压力测试应用程序看系统的 I/O wait 指标是否正常，例如测试机器有 4 个 CPU，那么理想的 I/O wait 参数不应该超过 25%，如果超过 25% 的话，I/O 很可能成为应用程序的性能瓶颈。Linux 操作系统下可以通过 iostat 命令查看。<br>通常我们在判断 I/O 性能时还会看另外一个参数就是 IOPS，我们应用程序需要最低的 IOPS 是多少，而我们的磁盘的 IOPS 能不能达到我们的要求。每个磁盘的 IOPS 通常是在一个范围内，这和存储在磁盘的数据块的大小和访问方式也有关。但是主要是由磁盘的转速决定的，磁盘的转速越高磁盘的 IOPS 也越高。<br>现在为了提高磁盘 I/O 的性能，通常采用一种叫 RAID 的技术，就是将不同的磁盘组合起来来提高 I/O 性能，目前有多种 RAID 技术，每种 RAID 技术对 I/O 性能提升会有不同，可以用一个 RAID 因子来代表，磁盘的读写吞吐量可以通过 iostat 命令来获取，于是我们可以计算出一个理论的 IOPS 值，计算公式如下所以：<br>( 磁盘数 * 每块磁盘的 IOPS)/( 磁盘读的吞吐量 +RAID 因子 * 磁盘写的吞吐量 )=IOPS<br>这个公式的详细信息请查阅参考资料 Understanding Disk I/O。</p>
<h4 id="提升-I-O-性能"><a href="#提升-I-O-性能" class="headerlink" title="提升 I/O 性能"></a>提升 I/O 性能</h4><p>提升磁盘 I/O 性能通常的方法有：<br>1&sdot;&nbsp;增加缓存，减少磁盘访问次数<br>2&sdot;&nbsp;优化磁盘的管理系统，设计最优的磁盘访问策略，以及磁盘的寻址策略，这里是在底层操作系统层面考虑的。<br>3&sdot;&nbsp;设计合理的磁盘存储数据块，以及访问这些数据块的策略，这里是在应用层面考虑的。如我们可以给存放的数据设计索引，通过寻址索引来加快和减少磁盘的访问，还有可以采用异步和非阻塞的方式加快磁盘的访问效率。<br>4&sdot;&nbsp;应用合理的 RAID 策略提升磁盘 IO，每种 RAID 的区别我们可以用下表所示：<img src='/uploads/ibm_2014-08-10-15.jpg'/></p>
<h3 id="网络-I-O-优化"><a href="#网络-I-O-优化" class="headerlink" title="网络 I/O 优化"></a>网络 I/O 优化</h3><p>网络 I/O 优化通常有一些基本处理原则：<br>1&sdot;&nbsp;一个是减少网络交互的次数：要减少网络交互的次数通常我们在需要网络交互的两端会设置缓存，比如 Oracle 的 JDBC 驱动程序，就提供了对查询的 SQL 结果的缓存，在客户端和数据库端都有，可以有效的减少对数据库的访问。关于 Oracle JDBC 的内存管理可以参考《 Oracle JDBC 内存管理》。除了设置缓存还有一个办法是，合并访问请求：如在查询数据库时，我们要查 10 个 id，我可以每次查一个 id，也可以一次查 10 个 id。再比如在访问一个页面时通过会有多个 js 或 css 的文件，我们可以将多个 js 文件合并在一个 HTTP 链接中，每个文件用逗号隔开，然后发送到后端 Web 服务器根据这个 URL 链接，再拆分出各个文件，然后打包再一并发回给前端浏览器。这些都是常用的减少网络 I/O 的办法。<br>2&sdot;&nbsp;减少网络传输数据量的大小：减少网络数据量的办法通常是将数据压缩后再传输，如 HTTP 请求中，通常 Web 服务器将请求的 Web 页面 gzip 压缩后在传输给浏览器。还有就是通过设计简单的协议，尽量通过读取协议头来获取有用的价值信息。比如在代理程序设计时，有 4 层代理和 7 层代理都是来尽量避免要读取整个通信数据来取得需要的信息。<br>3&sdot;&nbsp;尽量减少编码：通常在网络 I/O 中数据传输都是以字节形式的，也就是通常要序列化。但是我们发送要传输的数据都是字符形式的，从字符到字节必须编码。但是这个编码过程是比较耗时的，所以在要经过网络 I/O 传输时，尽量直接以字节形式发送。也就是尽量提前将字符转化为字节，或者减少字符到字节的转化过程。<br>4&sdot;&nbsp;根据应用场景设计合适的交互方式：所谓的交互场景主要包括同步与异步阻塞与非阻塞方式，下面将详细介绍。</p>
<h4 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h4><p>所谓同步就是一个任务的完成需要依赖另外一个任务时，只有等待被依赖的任务完成后，依赖的任务才能算完成，这是一种可靠的任务序列。要么成功都成功，失败都失败，两个任务的状态可以保持一致。而异步是不需要等待被依赖的任务完成，只是通知被依赖的任务要完成什么工作，依赖的任务也立即执行，只要自己完成了整个任务就算完成了。至于被依赖的任务最终是否真正完成，依赖它的任务无法确定，所以它是不可靠的任务序列。我们可以用打电话和发短信来很好的比喻同步与异步操作。<br>在设计到 IO 处理时通常都会遇到一个是同步还是异步的处理方式的选择问题。因为同步与异步的 I/O 处理方式对调用者的影响很大，在数据库产品中都会遇到这个问题。因为 I/O 操作通常是一个非常耗时的操作，在一个任务序列中 I/O 通常都是性能瓶颈。但是同步与异步的处理方式对程序的可靠性影响非常大，同步能够保证程序的可靠性，而异步可以提升程序的性能，必须在可靠性和性能之间做个平衡，没有完美的解决办法。</p>
<h4 id="阻塞与非阻塞"><a href="#阻塞与非阻塞" class="headerlink" title="阻塞与非阻塞"></a>阻塞与非阻塞</h4><p>阻塞与非阻塞主要是从 CPU 的消耗上来说的，阻塞就是 CPU 停下来等待一个慢的操作完成 CPU 才接着完成其它的事。非阻塞就是在这个慢的操作在执行时 CPU 去干其它别的事，等这个慢的操作完成时，CPU 再接着完成后续的操作。虽然表面上看非阻塞的方式可以明显的提高 CPU 的利用率，但是也带了另外一种后果就是系统的线程切换增加。增加的 CPU 使用时间能不能补偿系统的切换成本需要好好评估。</p>
<h4 id="两种的方式的组合"><a href="#两种的方式的组合" class="headerlink" title="两种的方式的组合"></a>两种的方式的组合</h4><p>组合的方式可以由四种，分别是：同步阻塞、同步非阻塞、异步阻塞、异步非阻塞，这四种方式都对 I/O 性能有影响。下面给出分析，并有一些常用的设计用例参考。<br>表 3. 四种组合方式<img src='/uploads/ibm_2014-08-10-16.jpg'/><br>虽然异步和非阻塞能够提升 I/O 的性能，但是也会带来一些额外的性能成本，例如会增加线程数量从而增加 CPU 的消耗，同时也会导致程序设计的复杂度上升。如果设计的不合理的话反而会导致性能下降。在实际设计时要根据应用场景综合评估一下。<br>下面举一些异步和阻塞的操作实例：<br>在 Cassandra 中要查询数据通常会往多个数据节点发送查询命令，但是要检查每个节点返回数据的完整性，所以需要一个异步查询同步结果的应用场景，部分代码如下：<br>清单 3.异步查询同步结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncResult</span> <span class="keyword">implements</span> <span class="title">IAsyncResult</span></span>&#123; </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">byte</span>[] result_; </span><br><span class="line">   <span class="keyword">private</span> AtomicBoolean done_ = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>); </span><br><span class="line">   <span class="keyword">private</span> Lock lock_ = <span class="keyword">new</span> ReentrantLock(); </span><br><span class="line">   <span class="keyword">private</span> Condition condition_; </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">long</span> startTime_; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AsyncResult</span><span class="params">()</span></span>&#123;        </span><br><span class="line">       condition_ = lock_.newCondition();<span class="comment">// 创建一个锁</span></span><br><span class="line">       startTime_ = System.currentTimeMillis(); </span><br><span class="line">   &#125;    </span><br><span class="line"><span class="comment">/*** 检查需要的数据是否已经返回，如果没有返回阻塞 */</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] get()&#123; </span><br><span class="line">       lock_.lock(); </span><br><span class="line">       <span class="keyword">try</span>&#123; </span><br><span class="line">           <span class="keyword">if</span> (!done_.get())&#123;condition_.await();&#125; </span><br><span class="line">       &#125;<span class="keyword">catch</span> (InterruptedException ex)&#123; </span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(ex); </span><br><span class="line">       &#125;<span class="keyword">finally</span>&#123;lock_.unlock();&#125; </span><br><span class="line">       <span class="keyword">return</span> result_; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/*** 检查需要的数据是否已经返回 */</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> done_.get();&#125; </span><br><span class="line"><span class="comment">/*** 检查在指定的时间内需要的数据是否已经返回，如果没有返回抛出超时异常 */</span> </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">byte</span>[] get(<span class="keyword">long</span> timeout, TimeUnit tu) <span class="keyword">throws</span> TimeoutException&#123; </span><br><span class="line">       lock_.lock(); </span><br><span class="line">       <span class="keyword">try</span>&#123;            <span class="keyword">boolean</span> bVal = <span class="keyword">true</span>; </span><br><span class="line">           <span class="keyword">try</span>&#123; </span><br><span class="line">               <span class="keyword">if</span> ( !done_.get() )&#123; </span><br><span class="line">          <span class="keyword">long</span> overall_timeout = timeout - (System.currentTimeMillis() - startTime_); </span><br><span class="line">                   <span class="keyword">if</span>(overall_timeout &gt; <span class="number">0</span>)<span class="comment">// 设置等待超时的时间</span></span><br><span class="line">                       bVal = condition_.await(overall_timeout, TimeUnit.MILLISECONDS); </span><br><span class="line">                   <span class="keyword">else</span> bVal = <span class="keyword">false</span>; </span><br><span class="line">               &#125; </span><br><span class="line">           &#125;<span class="keyword">catch</span> (InterruptedException ex)&#123; </span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(ex); </span><br><span class="line">           &#125; </span><br><span class="line">           <span class="keyword">if</span> ( !bVal &amp;&amp; !done_.get() )&#123;<span class="comment">// 抛出超时异常</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">"Operation timed out."</span>); </span><br><span class="line">           &#125; </span><br><span class="line">       &#125;<span class="keyword">finally</span>&#123;lock_.unlock();      &#125; </span><br><span class="line">       <span class="keyword">return</span> result_; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/*** 该函数拱另外一个线程设置要返回的数据，并唤醒在阻塞的线程 */</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">result</span><span class="params">(Message response)</span></span>&#123;        </span><br><span class="line">       <span class="keyword">try</span>&#123; </span><br><span class="line">           lock_.lock(); </span><br><span class="line">           <span class="keyword">if</span> ( !done_.get() )&#123;                </span><br><span class="line">               result_ = response.getMessageBody();<span class="comment">// 设置返回的数据</span></span><br><span class="line">               done_.set(<span class="keyword">true</span>); </span><br><span class="line">               condition_.signal();<span class="comment">// 唤醒阻塞的线程</span></span><br><span class="line">           &#125; </span><br><span class="line">       &#125;<span class="keyword">finally</span>&#123;lock_.unlock();&#125;        </span><br><span class="line">   &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文阐述的内容较多，从 Java 基本 I/O 类库结构开始说起，主要介绍了磁盘 I/O 和网络 I/O 的基本工作方式，最后介绍了关于 I/O 调优的一些方法。</p>
<p>转载自: <a href="https://www.ibm.com/developerworks/cn/java/j-lo-javaio/" target="_blank" rel="noopener">深入分析 Java I/O 的工作机制</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/04/01/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BHandlerMapping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/04/01/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BHandlerMapping/" class="post-title-link" itemprop="url">SpringMVC组件之HandlerMapping—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-04-01 12:45:30" itemprop="dateCreated datePublished" datetime="2014-04-01T12:45:30+08:00">2014-04-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="HandlerMapping简介"><a href="#HandlerMapping简介" class="headerlink" title="HandlerMapping简介"></a>HandlerMapping简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HandlerMapping是SpringMVC中相对较重要的一个接口类，<font color=red>主要功能是将请求映射到处理程序以及拦截器列表以进行预处理和后处理</font>。在Spring MVC中提供了该接口的内置实现，当然我们也可以定制，扩展或替换它们。今天主要分析 RequestMappingHandlerMapping (支持@RequestMapping注解方法) 实现类。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DispatcherServlet在启动时会读取相关的配置文件并创建HandlerMapping实例，并且放到一个集合中，由于HandlerMapping实例都实现了Order接口，则会根据order对HandlerMapping进行排序。那么在DispatcherServlet接受请求时会循环遍历存有HandlerMapping实例的有序集合。由于，RequestMappingHandlerMapping的order值是0，则最先开始接收请求。</p>
<h3 id="RequestMappingHandlerMapping初始化过程"><a href="#RequestMappingHandlerMapping初始化过程" class="headerlink" title="RequestMappingHandlerMapping初始化过程"></a>RequestMappingHandlerMapping初始化过程</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在RequestMappingHandlerMapping类中直接继承了RequestMappingInfoHandlerMapping类以及实现了EmbeddedValueResolverAware接口。其中RequestMappingInfoHandlerMapping也是一个抽象类，其继承了AbstractHandlerMethodMapping<RequestMappingInfo>抽象类，而AbstractHandlerMethodMapping抽象类实现了InitializingBean类，并且定义了整个流程初始化的逻辑，在其实例化后对调用了afterPropertiesSet(…)方法，在该方法的实现中完成对Method Handler的注册逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMappingHandlerMapping</span> <span class="keyword">extends</span> <span class="title">RequestMappingInfoHandlerMapping</span> <span class="keyword">implements</span> <span class="title">EmbeddedValueResolverAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useSuffixPatternMatch = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useRegisteredSuffixPatternMatch = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useTrailingSlashMatch = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ContentNegotiationManager contentNegotiationManager = <span class="keyword">new</span> ContentNegotiationManager();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; fileExtensions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> StringValueResolver embeddedValueResolver;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmbeddedValueResolver</span><span class="params">(StringValueResolver resolver)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.embeddedValueResolver  = resolver;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 判断是否对指定的路径匹配规则进行路径注册</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.useRegisteredSuffixPatternMatch) &#123;</span><br><span class="line">			<span class="keyword">this</span>.fileExtensions.addAll(<span class="keyword">this</span>.contentNegotiationManager.getAllFileExtensions());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">super</span>.afterPropertiesSet(); <span class="comment">//进行初始化操作</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHandler</span><span class="params">(Class&lt;?&gt; beanType)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 检查Class是否为@Controller或@RequestMapping注解类型</span></span><br><span class="line">		<span class="keyword">return</span> ((AnnotationUtils.findAnnotation(beanType, Controller<span class="class">.<span class="keyword">class</span>) !</span>= <span class="keyword">null</span>) || (AnnotationUtils.findAnnotation(beanType, RequestMapping<span class="class">.<span class="keyword">class</span>) !</span>= <span class="keyword">null</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RequestMappingInfo <span class="title">getMappingForMethod</span><span class="params">(Method method, Class&lt;?&gt; handlerType)</span> </span>&#123;</span><br><span class="line">		RequestMappingInfo info = <span class="keyword">null</span>;</span><br><span class="line">		RequestMapping methodAnnotation = AnnotationUtils.findAnnotation(method, RequestMapping<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (methodAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			RequestCondition&lt;?&gt; methodCondition = getCustomMethodCondition(method);</span><br><span class="line">			info = createRequestMappingInfo(methodAnnotation, methodCondition);</span><br><span class="line">			RequestMapping typeAnnotation = AnnotationUtils.findAnnotation(handlerType, RequestMapping<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			<span class="keyword">if</span> (typeAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">				RequestCondition&lt;?&gt; typeCondition = getCustomTypeCondition(handlerType);</span><br><span class="line">				info = createRequestMappingInfo(typeAnnotation, typeCondition).combine(info);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> info;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RequestMappingInfo <span class="title">createRequestMappingInfo</span><span class="params">(RequestMapping annotation, RequestCondition&lt;?&gt; customCondition)</span> </span>&#123;</span><br><span class="line">		String[] patterns = resolveEmbeddedValuesInPatterns(annotation.value());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RequestMappingInfo(</span><br><span class="line">				<span class="keyword">new</span> PatternsRequestCondition(patterns, getUrlPathHelper(), getPathMatcher(), <span class="keyword">this</span>.useSuffixPatternMatch, <span class="keyword">this</span>.useTrailingSlashMatch, <span class="keyword">this</span>.fileExtensions),</span><br><span class="line">				<span class="keyword">new</span> RequestMethodsRequestCondition(annotation.method()),</span><br><span class="line">				<span class="keyword">new</span> ParamsRequestCondition(annotation.params()),</span><br><span class="line">				<span class="keyword">new</span> HeadersRequestCondition(annotation.headers()),</span><br><span class="line">				<span class="keyword">new</span> ConsumesRequestCondition(annotation.consumes(), annotation.headers()),</span><br><span class="line">				<span class="keyword">new</span> ProducesRequestCondition(annotation.produces(), annotation.headers(), getContentNegotiationManager()),</span><br><span class="line">				customCondition);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> String[] resolveEmbeddedValuesInPatterns(String[] patterns) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.embeddedValueResolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> patterns;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			String[] resolvedPatterns = <span class="keyword">new</span> String[patterns.length];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; patterns.length; i++) &#123;</span><br><span class="line">				resolvedPatterns[i] = <span class="keyword">this</span>.embeddedValueResolver.resolveStringValue(patterns[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> resolvedPatterns;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在以上源码中看到其实现并重写了afterPropertiesSet()方法,并且在方法结束时调用了父级的afterPropertiesSet(),其方法体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandlerMethodMapping</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractHandlerMapping</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		initHandlerMethods(); <span class="comment">//初始化HandlerMethods</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initHandlerMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 省略部分代码</span></span><br><span class="line">		String[] beanNames = (<span class="keyword">this</span>.detectHandlerMethodsInAncestorContexts ?</span><br><span class="line">				BeanFactoryUtils.beanNamesForTypeIncludingAncestors(getApplicationContext(), Object.class) :</span><br><span class="line">				getApplicationContext().getBeanNamesForType(Object<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">			<span class="keyword">if</span> (isHandler(getApplicationContext().getType(beanName)))&#123; <span class="comment">//开始检查是否为指定注解的类型（具体功能由子类提供实现）</span></span><br><span class="line">				detectHandlerMethods(beanName); <span class="comment">//在句柄方法集里面查找对应的句柄（处理器）</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		handlerMethodsInitialized(getHandlerMethods()); <span class="comment">//开始初始化句柄方法集（HandlerMethods）</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">detectHandlerMethods</span><span class="params">(<span class="keyword">final</span> Object handler)</span> </span>&#123;</span><br><span class="line">		Class&lt;?&gt; handlerType = (handler <span class="keyword">instanceof</span> String) ? getApplicationContext().getType((String) handler) : handler.getClass();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</span><br><span class="line"></span><br><span class="line">		Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, <span class="keyword">new</span> MethodFilter() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> getMappingForMethod(method, userType) != <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">			T mapping = getMappingForMethod(method, userType);</span><br><span class="line">			registerHandlerMethod(handler, method, mapping);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 开始注册相关的句柄以及处理其唯一的映射关系</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandlerMethod</span><span class="params">(Object handler, Method method, T mapping)</span> </span>&#123;</span><br><span class="line">		HandlerMethod newHandlerMethod = createHandlerMethod(handler, method);</span><br><span class="line">		HandlerMethod oldHandlerMethod = handlerMethods.get(mapping);</span><br><span class="line">		<span class="keyword">if</span> (oldHandlerMethod != <span class="keyword">null</span> &amp;&amp; !oldHandlerMethod.equals(newHandlerMethod)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Ambiguous mapping found. Cannot map '"</span> + newHandlerMethod.getBean()</span><br><span class="line">					+ <span class="string">"' bean method \n"</span> + newHandlerMethod + <span class="string">"\nto "</span> + mapping + <span class="string">": There is already '"</span></span><br><span class="line">					+ oldHandlerMethod.getBean() + <span class="string">"' bean method\n"</span> + oldHandlerMethod + <span class="string">" mapped."</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.handlerMethods.put(mapping, newHandlerMethod);</span><br><span class="line">		</span><br><span class="line">		Set&lt;String&gt; patterns = getMappingPathPatterns(mapping);</span><br><span class="line">		<span class="keyword">for</span> (String pattern : patterns) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!getPathMatcher().isPattern(pattern)) &#123;</span><br><span class="line">				<span class="keyword">this</span>.urlMap.add(pattern, mapping);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/personal"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">personal</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"user/personal"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/employee_panel"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hr_employee_panel</span><span class="params">(<span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(flag==<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"user/hr_employee_panel_accordion"</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"user/hr_employee_panel"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/27/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BViewResolver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/27/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BViewResolver/" class="post-title-link" itemprop="url">SpringMVC组件之ViewResolver—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-27 12:45:30" itemprop="dateCreated datePublished" datetime="2014-03-27T12:45:30+08:00">2014-03-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SpringMVC组件之ViewResolver"><a href="#SpringMVC组件之ViewResolver" class="headerlink" title="SpringMVC组件之ViewResolver"></a>SpringMVC组件之ViewResolver</h2><p>SpringMVC中通过配置可以支持多种视图的解析，并且可以非常和谐的工作，这个功能主要归功于其中的ViewResolver接口。ViewResolver解析器的作用就是把一个视图的逻辑名称解析为一个能展示图形文本的视图对象。通过View接口对象进行视图渲染并响应给客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line">	<span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到该接口的源码中只提供了一个解析视图的功能；<br><font color=red>该接口的直接子类实现有如下几类：</font></p>
<pre><code>1&gt; org.springframework.web.servlet.view.AbstractCachingViewResolver
2&gt; org.springframework.web.servlet.view.BeanNameViewResolver
3&gt; org.springframework.web.servlet.view.ContentNegotiatingViewResolver</code></pre><h3 id="AbstractCachingViewResolver"><a href="#AbstractCachingViewResolver" class="headerlink" title="AbstractCachingViewResolver"></a>AbstractCachingViewResolver</h3><p>该抽象类主要提供了视图缓冲的功能，也就该解析器解析过的视图，会被存储起来，等到下次请求过来需要解析视图时，首先会判断该视图是否被解析过，如果被解析过了，那么就在缓冲中获取该视图，否则重新解析并存储到缓冲里面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCachingViewResolver</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CACHE_LIMIT = <span class="number">1024</span>;<span class="comment">//这里的默认是缓冲视图数量为 1024</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> View UNRESOLVED_VIEW = <span class="keyword">new</span> View() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cacheLimit = DEFAULT_CACHE_LIMIT; </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> cacheUnresolved = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*线程安全的基础上并发能力相对较好*/</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, View&gt; viewAccessCache = <span class="keyword">new</span> ConcurrentHashMap&lt;Object, View&gt;(DEFAULT_CACHE_LIMIT);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*能够保持缓冲数据的有序性，操作相对便捷*/</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, View&gt; viewCreationCache =</span><br><span class="line">			<span class="keyword">new</span> LinkedHashMap&lt;Object, View&gt;(DEFAULT_CACHE_LIMIT, <span class="number">0.75f</span>, <span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Object, View&gt; eldest)</span> </span>&#123;</span><br><span class="line">					<span class="keyword">if</span> (size() &gt; getCacheLimit()) &#123;</span><br><span class="line">						viewAccessCache.remove(eldest.getKey());</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCacheLimit</span><span class="params">(<span class="keyword">int</span> cacheLimit)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cacheLimit = cacheLimit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCacheLimit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.cacheLimit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCache</span><span class="params">(<span class="keyword">boolean</span> cache)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cacheLimit = (cache ? DEFAULT_CACHE_LIMIT : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">this</span>.cacheLimit &gt; <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCacheUnresolved</span><span class="params">(<span class="keyword">boolean</span> cacheUnresolved)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cacheUnresolved = cacheUnresolved;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCacheUnresolved</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.cacheUnresolved;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isCache()) &#123; <span class="comment">// 是否缓冲了视图信息</span></span><br><span class="line">			<span class="keyword">return</span> createView(viewName, locale);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			Object cacheKey = getCacheKey(viewName, locale);</span><br><span class="line">			View view = <span class="keyword">this</span>.viewAccessCache.get(cacheKey);</span><br><span class="line">			<span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">synchronized</span> (<span class="keyword">this</span>.viewCreationCache) &#123;</span><br><span class="line">					view = <span class="keyword">this</span>.viewCreationCache.get(cacheKey);</span><br><span class="line">					<span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="comment">// 重新出创建视图对象</span></span><br><span class="line">						view = createView(viewName, locale);</span><br><span class="line">						<span class="keyword">if</span> (view == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.cacheUnresolved) &#123; <span class="comment">// 如果没有查询到该视图，同事也没有缓冲该视图，则启用默认视图</span></span><br><span class="line">							view = UNRESOLVED_VIEW;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">							<span class="keyword">this</span>.viewAccessCache.put(cacheKey, view);</span><br><span class="line">							<span class="keyword">this</span>.viewCreationCache.put(cacheKey, view);</span><br><span class="line">							<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">								logger.trace(<span class="string">"Cached view ["</span> + cacheKey + <span class="string">"]"</span>);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> (view != UNRESOLVED_VIEW ? view : <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">getCacheKey</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> viewName + <span class="string">"_"</span> + locale;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeFromCache</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isCache()) &#123;</span><br><span class="line">			logger.warn(<span class="string">"View caching is SWITCHED OFF -- removal not necessary"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			Object cacheKey = getCacheKey(viewName, locale);</span><br><span class="line">			Object cachedView;</span><br><span class="line">			<span class="keyword">synchronized</span> (<span class="keyword">this</span>.viewCreationCache) &#123;</span><br><span class="line">				<span class="keyword">this</span>.viewAccessCache.remove(cacheKey);</span><br><span class="line">				cachedView = <span class="keyword">this</span>.viewCreationCache.remove(cacheKey);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.viewCreationCache) &#123;</span><br><span class="line">			<span class="keyword">this</span>.viewAccessCache.clear();</span><br><span class="line">			<span class="keyword">this</span>.viewCreationCache.clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">createView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> loadView(viewName, locale);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们看到AbstractCachingViewResolver接口中使用了两个Map用于缓存View视图对象，分别如下：</p>
<pre><code>1&gt; ConcurrentHashMap：在线程安全的条件下提供了较好的并发访问能力，效率较高
2&gt; LinkedHashMap：保证了值的有序性，同时它有方法是删除最前保存的值</code></pre><p>其中removeEldestEntry()方法返回true时，表示达到了最大空间，删除值；返回false时，表示没有达到上线。通常使用ConcurrentHashMap来获取缓存数据，同时结合LinkedHashMap来操作缓冲会更加方便。<br><font color=red>该抽象类的直接实现类有如下几个：</font></p>
<pre><code>1&gt;  org.springframework.web.servlet.view.ResourceBundleViewResolver
2&gt;  org.springframework.web.servlet.view.UrlBasedViewResolver
3&gt;  org.springframework.web.servlet.view.XmlViewResolver</code></pre><h4 id="ResourceBundleViewResolver"><a href="#ResourceBundleViewResolver" class="headerlink" title="ResourceBundleViewResolver"></a>ResourceBundleViewResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceBundleViewResolver</span> <span class="keyword">extends</span> <span class="title">AbstractCachingViewResolver</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">Ordered</span>, <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_BASENAME = <span class="string">"views"</span>; <span class="comment">/*默认的基（根）名称*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;<span class="comment">/*默认排序值为1024*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String[] basenames = <span class="keyword">new</span> String[] &#123;DEFAULT_BASENAME&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ClassLoader bundleClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String defaultParentView;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Locale[] localesToInitialize;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Locale, BeanFactory&gt; localeCache = <span class="keyword">new</span> HashMap&lt;Locale, BeanFactory&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;List&lt;ResourceBundle&gt;, ConfigurableApplicationContext&gt; bundleCache = <span class="keyword">new</span> HashMap&lt;List&lt;ResourceBundle&gt;, ConfigurableApplicationContext&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		BeanFactory factory = initFactory(locale);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> factory.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">			<span class="comment">// to allow for ViewResolver chaining</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> BeanFactory <span class="title">initFactory</span><span class="params">(Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			BeanFactory cachedFactory = <span class="keyword">this</span>.localeCache.get(locale);</span><br><span class="line">			<span class="keyword">if</span> (cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> cachedFactory;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		List&lt;ResourceBundle&gt; bundles = <span class="keyword">new</span> LinkedList&lt;ResourceBundle&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String basename : <span class="keyword">this</span>.basenames) &#123;</span><br><span class="line">			ResourceBundle bundle = getBundle(basename, locale);</span><br><span class="line">			bundles.add(bundle);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			BeanFactory cachedFactory = <span class="keyword">this</span>.bundleCache.get(bundles);</span><br><span class="line">			<span class="keyword">if</span> (cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">this</span>.localeCache.put(locale, cachedFactory);</span><br><span class="line">				<span class="keyword">return</span> cachedFactory;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 为视图创建一个子应用程序上下文对象</span></span><br><span class="line">		GenericWebApplicationContext factory = <span class="keyword">new</span> GenericWebApplicationContext();</span><br><span class="line">		factory.setParent(getApplicationContext());</span><br><span class="line">		factory.setServletContext(getServletContext());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从资源包加载定义的解析器</span></span><br><span class="line">		PropertiesBeanDefinitionReader reader = <span class="keyword">new</span> PropertiesBeanDefinitionReader(factory);</span><br><span class="line">		reader.setDefaultParentBean(<span class="keyword">this</span>.defaultParentView);</span><br><span class="line">		<span class="keyword">for</span> (ResourceBundle bundle : bundles) &#123;</span><br><span class="line">			reader.registerBeanDefinitions(bundle);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		factory.refresh();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 这里缓冲了解析器实例和多语实例</span></span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.localeCache.put(locale, factory);</span><br><span class="line">			<span class="keyword">this</span>.bundleCache.put(bundles, factory);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> factory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ResourceBundle <span class="title">getBundle</span><span class="params">(String basename, Locale locale)</span> <span class="keyword">throws</span> MissingResourceException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ResourceBundle.getBundle(basename, locale, getBundleClassLoader());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (ConfigurableApplicationContext factory : <span class="keyword">this</span>.bundleCache.values()) &#123;</span><br><span class="line">			factory.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.localeCache.clear();</span><br><span class="line">		<span class="keyword">this</span>.bundleCache.clear();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们可以理解该解析器是通过配置资源属性文件（默认文件为views.properties）来进行获取每一个请求相对应的解析器逻辑名称和地址，然后进行视图的处理。<br>配置文件示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.ResourceBundleViewResolver"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basename"</span> <span class="attr">value</span>=<span class="string">"maxsoft-views"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>maxsoft-views.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">main.(class)</span>=<span class="string">org.springframework.web.servlet.view.InternalResourceView    </span></span><br><span class="line"><span class="meta">mian.url</span>=<span class="string">/main.jsp    </span></span><br><span class="line"><span class="meta">news.(class)</span>=<span class="string">org.springframework.web.servlet.view.InternalResourceView    </span></span><br><span class="line"><span class="meta">news.url</span>=<span class="string">/news.jsp</span></span><br></pre></td></tr></table></figure>

<h4 id="UrlBasedViewResolver"><a href="#UrlBasedViewResolver" class="headerlink" title="UrlBasedViewResolver"></a>UrlBasedViewResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlBasedViewResolver</span> <span class="keyword">extends</span> <span class="title">AbstractCachingViewResolver</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REDIRECT_URL_PREFIX = <span class="string">"redirect:"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FORWARD_URL_PREFIX = <span class="string">"forward:"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class viewClass;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String prefix = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String suffix = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String[] viewNames = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String contentType;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> redirectContextRelative = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> redirectHttp10Compatible = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String requestContextAttribute;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Map of static attributes, keyed by attribute name (String) */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; staticAttributes = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Boolean exposePathVariables;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewClass</span><span class="params">(Class viewClass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (viewClass == <span class="keyword">null</span> || !requiredViewClass().isAssignableFrom(viewClass)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">					<span class="string">"Given view class ["</span> + (viewClass != <span class="keyword">null</span> ? viewClass.getName() : <span class="keyword">null</span>) +</span><br><span class="line">					<span class="string">"] is not of type ["</span> + requiredViewClass().getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.viewClass = viewClass;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.initApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (getViewClass() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Property 'viewClass' is required"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">createView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//是否处理给定的视图</span></span><br><span class="line">		<span class="keyword">if</span> (!canHandle(viewName, locale)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 检查是否为重定向指令</span></span><br><span class="line">		<span class="keyword">if</span> (viewName.startsWith(REDIRECT_URL_PREFIX)) &#123;</span><br><span class="line">			String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length()); <span class="comment">//过滤前缀</span></span><br><span class="line">			RedirectView view = <span class="keyword">new</span> RedirectView(redirectUrl, isRedirectContextRelative(), isRedirectHttp10Compatible());</span><br><span class="line">			<span class="keyword">return</span> applyLifecycleMethods(viewName, view);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 检查是否为转发指令</span></span><br><span class="line">		<span class="keyword">if</span> (viewName.startsWith(FORWARD_URL_PREFIX)) &#123;</span><br><span class="line">			String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length()); <span class="comment">//过滤前缀</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> InternalResourceView(forwardUrl);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//否则调用基类loadView()获取视图。</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.createView(viewName, locale);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">canHandle</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		String[] viewNames = getViewNames();</span><br><span class="line">		<span class="keyword">return</span> (viewNames == <span class="keyword">null</span> || PatternMatchUtils.simpleMatch(viewNames, viewName));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		AbstractUrlBasedView view = buildView(viewName);</span><br><span class="line">		View result = applyLifecycleMethods(viewName, view);</span><br><span class="line">		<span class="keyword">return</span> (view.checkResource(locale) ? result : <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> View <span class="title">applyLifecycleMethods</span><span class="params">(String viewName, AbstractView view)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (View) getApplicationContext().getAutowireCapableBeanFactory().initializeBean(view, viewName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AbstractUrlBasedView <span class="title">buildView</span><span class="params">(String viewName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		AbstractUrlBasedView view = (AbstractUrlBasedView) BeanUtils.instantiateClass(getViewClass());</span><br><span class="line">		view.setUrl(getPrefix() + viewName + getSuffix());</span><br><span class="line">		String contentType = getContentType();</span><br><span class="line">		<span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">			view.setContentType(contentType);</span><br><span class="line">		&#125;</span><br><span class="line">		view.setRequestContextAttribute(getRequestContextAttribute());</span><br><span class="line">		view.setAttributesMap(getAttributesMap());</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.exposePathVariables != <span class="keyword">null</span>) &#123;</span><br><span class="line">			view.setExposePathVariables(exposePathVariables);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> view;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们可以理解，UrlBasedViewResolver是对ViewResolver接口的一种简单实现，并且继承了AbstractCachingViewResolver抽象类。<br>UrlBasedViewResolver主要通过「prefix属性 + 逻辑视图名称 + suffix属性 」拼接字符方式来解析视图。如prefix=/WEB-INF/jsp/，suffix=.jsp，返回的视图名称viewName=maxsoft/main，则其解析出来的视图URL就是/WEB-INF/jsp/maxsoft/main.jsp。<br>prefix ：默认是空字符串；<br>suffix：默认是空字符串；<br>URLBasedViewResolver解析器也支持返回的视图名称中包含（重定向）<font color=red>「redirect:前缀 」</font>，通过前缀过滤组成一个RedirectView，在RedirectView中将把请求返回的模型数据组装为查询参数的形式拼接到redirect的URL后面，然后通过HttpServletResponse对象的sendRedirect方法进行重定向。<br>同样URLBasedViewResolver还支持<font color=red>「forword:前缀 」</font>，通过前缀过滤后会被封装成一个InternalResourceView对象，然后在服务器端利用RequestDispatcher的forword方式跳转到指定的地址。<br>配置文件示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.UrlBasedViewResolver"</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp"</span> /&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span>/&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font color=red>注意：使用UrlBasedViewResolver的时候必须指定视图类名（viewClass），即告诉解析器解析成哪种视图，通常使用较多的是org.springframework.web.servlet.view.InternalResourceView，利用它来展现jsp，如果我们使用JSTL的时候则需要使用org.springframework.web.servlet.view.JstlView</font></p>
<p>通过源码继承关系可以发现，在某种角度上看UrlBasedViewResolver也是如下几类视图解析器的「基类」：</p>
<pre><code>1&gt; org.springframework.web.servlet.view.AbstractTemplateViewResolver
2&gt; org.springframework.web.servlet.view.InternalResourceViewResolver
3&gt; org.springframework.web.servlet.view.jasperreports.JasperReportsViewResolver
4&gt; org.springframework.web.servlet.view.tiles3.TilesViewResolver
5&gt; org.springframework.web.servlet.view.tiles2.TilesViewResolver
6&gt; org.springframework.web.servlet.view.xslt.XsltViewResolver</code></pre><h4 id="XmlViewResolver"><a href="#XmlViewResolver" class="headerlink" title="XmlViewResolver"></a>XmlViewResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlViewResolver</span> <span class="keyword">extends</span> <span class="title">AbstractCachingViewResolver</span> <span class="keyword">implements</span> <span class="title">Ordered</span>, <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认的视图解析器配置文件路径</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_LOCATION = <span class="string">"/WEB-INF/views.xml"</span>;</span><br><span class="line">	<span class="comment">// 默认的排序值</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Resource location;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ConfigurableApplicationContext cachedFactory;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocation</span><span class="params">(Resource location)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.location = location;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			initFactory();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">getCacheKey</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> viewName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		BeanFactory factory = initFactory();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> factory.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> BeanFactory <span class="title">initFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.cachedFactory;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Resource actualLocation = <span class="keyword">this</span>.location;</span><br><span class="line">		<span class="keyword">if</span> (actualLocation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actualLocation = getApplicationContext().getResource(DEFAULT_LOCATION);</span><br><span class="line">		&#125;</span><br><span class="line">		GenericWebApplicationContext factory = <span class="keyword">new</span> GenericWebApplicationContext();</span><br><span class="line">		factory.setParent(getApplicationContext());</span><br><span class="line">		factory.setServletContext(getServletContext());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 加载XML资源文件</span></span><br><span class="line">		XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">		reader.setEnvironment(getApplicationContext().getEnvironment());</span><br><span class="line">		reader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(getApplicationContext()));</span><br><span class="line">		reader.loadBeanDefinitions(actualLocation);</span><br><span class="line"></span><br><span class="line">		factory.refresh();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.cachedFactory = factory;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> factory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.cachedFactory.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述源码中我们发现，该XmlViewResolver解析器也是通过资源配置文件进行对请求视图的解析。资源文件的默认是地址是”/WEB-INF/views.xml”，我们也可以通过在Spring容器中注册实例时重新的定义其路径，例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.XmlViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"location"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/WEB-INF/resource/xml/spring-views.xml<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>spring-views.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/main.jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"user"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.JstlView"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/user.jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>工作原理：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;控制器返回逻辑视图名称，XmlViewResolver解析器将会在spring-views.xml资源配置文件中查找该逻辑视图名称相对应的视图解析实例，并返回其视图地址给DispatcherServlet，进行渲染响应给客户端。</p>
<h3 id="BeanNameViewResolver"><a href="#BeanNameViewResolver" class="headerlink" title="BeanNameViewResolver"></a>BeanNameViewResolver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanNameViewResolver</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;  <span class="comment">//默认最大的排序值</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.order = order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		ApplicationContext context = getApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (!context.containsBean(viewName)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> context.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码分析我们可以理解，BeanNameViewResolver是通过视图的逻辑名称在Spring容器中获取注入的视图解析实例（不进行实例的缓冲），进行对视图的解析处理。<br>配置文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.BeanNameViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"maxsoft"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"/main.jsp"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ContentNegotiatingViewResolver"><a href="#ContentNegotiatingViewResolver" class="headerlink" title="ContentNegotiatingViewResolver"></a>ContentNegotiatingViewResolver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentNegotiatingViewResolver</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span>, <span class="title">Ordered</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(ContentNegotiatingViewResolver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Ordered.HIGHEST_PRECEDENCE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ContentNegotiationManager contentNegotiationManager;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ContentNegotiationManagerFactoryBean cnManagerFactoryBean = <span class="keyword">new</span> ContentNegotiationManagerFactoryBean();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useNotAcceptableStatusCode = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;View&gt; defaultViews;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.order = order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentNegotiationManager</span><span class="params">(ContentNegotiationManager contentNegotiationManager)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.contentNegotiationManager = contentNegotiationManager;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFavorPathExtension</span><span class="params">(<span class="keyword">boolean</span> favorPathExtension)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setFavorPathExtension(favorPathExtension);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUseJaf</span><span class="params">(<span class="keyword">boolean</span> useJaf)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setUseJaf(useJaf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFavorParameter</span><span class="params">(<span class="keyword">boolean</span> favorParameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setFavorParameter(favorParameter);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameterName</span><span class="params">(String parameterName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setParameterName(parameterName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIgnoreAcceptHeader</span><span class="params">(<span class="keyword">boolean</span> ignoreAcceptHeader)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setIgnoreAcceptHeader(ignoreAcceptHeader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMediaTypes</span><span class="params">(Map&lt;String, String&gt; mediaTypes)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mediaTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">			Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">			props.putAll(mediaTypes);</span><br><span class="line">			<span class="keyword">this</span>.cnManagerFactoryBean.setMediaTypes(props);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultContentType</span><span class="params">(MediaType defaultContentType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setDefaultContentType(defaultContentType);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUseNotAcceptableStatusCode</span><span class="params">(<span class="keyword">boolean</span> useNotAcceptableStatusCode)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.useNotAcceptableStatusCode = useNotAcceptableStatusCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultViews</span><span class="params">(List&lt;View&gt; defaultViews)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.defaultViews = defaultViews;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewResolvers</span><span class="params">(List&lt;ViewResolver&gt; viewResolvers)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.viewResolvers = viewResolvers;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initServletContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">		Collection&lt;ViewResolver&gt; matchingBeans = BeanFactoryUtils.beansOfTypeIncludingAncestors(getApplicationContext(), ViewResolver<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>()</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.viewResolvers = <span class="keyword">new</span> ArrayList&lt;ViewResolver&gt;(matchingBeans.size());</span><br><span class="line">			<span class="keyword">for</span> (ViewResolver viewResolver : matchingBeans) &#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span> != viewResolver) &#123;</span><br><span class="line">					<span class="keyword">this</span>.viewResolvers.add(viewResolver);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; viewResolvers.size(); i++) &#123;</span><br><span class="line">				<span class="keyword">if</span> (matchingBeans.contains(viewResolvers.get(i))) &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				String name = viewResolvers.get(i).getClass().getName() + i;</span><br><span class="line">				getApplicationContext().getAutowireCapableBeanFactory().initializeBean(viewResolvers.get(i), name);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers.isEmpty()) &#123;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">		&#125;</span><br><span class="line">		OrderComparator.sort(<span class="keyword">this</span>.viewResolvers);</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setServletContext(servletContext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.contentNegotiationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.cnManagerFactoryBean.afterPropertiesSet();</span><br><span class="line">			<span class="keyword">this</span>.contentNegotiationManager = <span class="keyword">this</span>.cnManagerFactoryBean.getObject();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		RequestAttributes attrs = RequestContextHolder.getRequestAttributes();</span><br><span class="line">		Assert.isInstanceOf(ServletRequestAttributes<span class="class">.<span class="keyword">class</span>, <span class="title">attrs</span>)</span>;</span><br><span class="line">		List&lt;MediaType&gt; requestedMediaTypes = getMediaTypes(((ServletRequestAttributes) attrs).getRequest());</span><br><span class="line">		<span class="keyword">if</span> (requestedMediaTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">			List&lt;View&gt; candidateViews = getCandidateViews(viewName, locale, requestedMediaTypes);</span><br><span class="line">			View bestView = getBestView(candidateViews, requestedMediaTypes, attrs);</span><br><span class="line">			<span class="keyword">if</span> (bestView != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> bestView;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.useNotAcceptableStatusCode) &#123;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">			<span class="keyword">return</span> NOT_ACCEPTABLE_VIEW;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> List&lt;MediaType&gt; <span class="title">getMediaTypes</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request);</span><br><span class="line">			List&lt;MediaType&gt; acceptableMediaTypes = <span class="keyword">this</span>.contentNegotiationManager.resolveMediaTypes(webRequest);</span><br><span class="line">			acceptableMediaTypes = acceptableMediaTypes.isEmpty() ? Collections.singletonList(MediaType.ALL) : acceptableMediaTypes;</span><br><span class="line">			List&lt;MediaType&gt; producibleMediaTypes = getProducibleMediaTypes(request);</span><br><span class="line">			Set&lt;MediaType&gt; compatibleMediaTypes = <span class="keyword">new</span> LinkedHashSet&lt;MediaType&gt;();</span><br><span class="line">			<span class="keyword">for</span> (MediaType acceptable : acceptableMediaTypes) &#123;</span><br><span class="line">				<span class="keyword">for</span> (MediaType producible : producibleMediaTypes) &#123;</span><br><span class="line">					<span class="keyword">if</span> (acceptable.isCompatibleWith(producible)) &#123;</span><br><span class="line">						compatibleMediaTypes.add(getMostSpecificMediaType(acceptable, producible));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			List&lt;MediaType&gt; selectedMediaTypes = <span class="keyword">new</span> ArrayList&lt;MediaType&gt;(compatibleMediaTypes);</span><br><span class="line">			MediaType.sortBySpecificityAndQuality(selectedMediaTypes);</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">			<span class="keyword">return</span> selectedMediaTypes;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (HttpMediaTypeNotAcceptableException ex) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">private</span> List&lt;MediaType&gt; <span class="title">getProducibleMediaTypes</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		Set&lt;MediaType&gt; mediaTypes = (Set&lt;MediaType&gt;) request.getAttribute(HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(mediaTypes)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;MediaType&gt;(mediaTypes);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.singletonList(MediaType.ALL);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> MediaType <span class="title">getMostSpecificMediaType</span><span class="params">(MediaType acceptType, MediaType produceType)</span> </span>&#123;</span><br><span class="line">		produceType = produceType.copyQualityValue(acceptType);</span><br><span class="line">		<span class="keyword">return</span> MediaType.SPECIFICITY_COMPARATOR.compare(acceptType, produceType) &lt; <span class="number">0</span> ? acceptType : produceType;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> List&lt;View&gt; <span class="title">getCandidateViews</span><span class="params">(String viewName, Locale locale, List&lt;MediaType&gt; requestedMediaTypes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		List&lt;View&gt; candidateViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">		<span class="keyword">for</span> (ViewResolver viewResolver : <span class="keyword">this</span>.viewResolvers) &#123;</span><br><span class="line">			View view = viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">				candidateViews.add(view);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> (MediaType requestedMediaType : requestedMediaTypes) &#123;</span><br><span class="line">				List&lt;String&gt; extensions = <span class="keyword">this</span>.contentNegotiationManager.resolveFileExtensions(requestedMediaType);</span><br><span class="line">				<span class="keyword">for</span> (String extension : extensions) &#123;</span><br><span class="line">					String viewNameWithExtension = viewName + <span class="string">"."</span> + extension;</span><br><span class="line">					view = viewResolver.resolveViewName(viewNameWithExtension, locale);</span><br><span class="line">					<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">						candidateViews.add(view);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(<span class="keyword">this</span>.defaultViews)) &#123;</span><br><span class="line">			candidateViews.addAll(<span class="keyword">this</span>.defaultViews);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> candidateViews;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> View <span class="title">getBestView</span><span class="params">(List&lt;View&gt; candidateViews, List&lt;MediaType&gt; requestedMediaTypes, RequestAttributes attrs)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (View candidateView : candidateViews) &#123;</span><br><span class="line">			<span class="keyword">if</span> (candidateView <span class="keyword">instanceof</span> SmartView) &#123;</span><br><span class="line">				SmartView smartView = (SmartView) candidateView;</span><br><span class="line">				<span class="keyword">if</span> (smartView.isRedirectView()) &#123;</span><br><span class="line">					<span class="comment">// 省略部分代码</span></span><br><span class="line">					<span class="keyword">return</span> candidateView;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (MediaType mediaType : requestedMediaTypes) &#123;</span><br><span class="line">			<span class="keyword">for</span> (View candidateView : candidateViews) &#123;</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.hasText(candidateView.getContentType())) &#123;</span><br><span class="line">					MediaType candidateContentType = MediaType.parseMediaType(candidateView.getContentType());</span><br><span class="line">					<span class="keyword">if</span> (mediaType.isCompatibleWith(candidateContentType)) &#123;</span><br><span class="line">						<span class="comment">// 省略部分代码</span></span><br><span class="line">						attrs.setAttribute(View.SELECTED_CONTENT_TYPE, mediaType, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">						<span class="keyword">return</span> candidateView;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> View NOT_ACCEPTABLE_VIEW = <span class="keyword">new</span> View() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">			response.setStatus(HttpServletResponse.SC_NOT_ACCEPTABLE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过源码分析我们可以得知，ContentNegotiatingViewResolver本身不解析视图，而是委托给其他ViewResolver<font color=red>「resolveViewName() –&gt;getCandidateViews(), getBestView()」</font>。 默认情况下，这些其他类别的视图解析器是从应用容器中获取的，尽管它们也可以通过使用viewResolvers属性来显式设置。 但是，为了使该视图解析器能够正常工作，需要将order属性设置为比其他更高的优先级（默认值是Ordered.HIGHEST_PRECEDENCE）<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;该视图解析器使用所请求的媒体类型来为请求选择合适的视图，请求的媒体类型是通过配置的ContentNegotiationManager确定的<font color=red>「getMediaTypes()」</font>。 一旦确定了所请求的媒体类型，该解析器查询每个委托视图解析器以查看并确定所请求的媒体类型是否与视图的内容类型兼容）。 最兼容的视图被返回。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时，该视图解析器显式的增加了defaultViews属性，允许我们覆盖视图解析器提供的视图。 当然，这些默认视图以candicates的形式提供，并且需要具有请求的内容类型（通过文件扩展名，参数或Accept头，如上所述）。 我们也可以直接设置默认的内容类型，当其他机制（Accept头，文件扩展名或参数）导致不匹配时，将返回默认的内容类型。<br>例如，如果请求路径是/view.html，则此视图解析器将查找具有文本/ html内容类型（基于html文件扩展名）的视图。 使用text / html请求Accept头的请求/查看具有相同的结果。<br>配置文件示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.ContentNegotiatingViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"favorParameter"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"ignoreAcceptHeader"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultViews"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.json.MappingJacksonJsonView"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.xml.MarshallingView"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.oxm.jaxb.Jaxb2Marshaller"</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"classesToBeBound"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.maxsoft.User<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mediaTypes"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"xml"</span> <span class="attr">value</span>=<span class="string">"application/xml"</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"json"</span> <span class="attr">value</span>=<span class="string">"application/json"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 如果在order值为1的视图解析器中没有匹配到则会使用该视图解析器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/24/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BThemeResolver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/24/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BThemeResolver/" class="post-title-link" itemprop="url">SpringMVC组件之ThemeResolver—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-24 21:22:20" itemprop="dateCreated datePublished" datetime="2014-03-24T21:22:20+08:00">2014-03-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SpringMVC组件之ThemeResolver"><a href="#SpringMVC组件之ThemeResolver" class="headerlink" title="SpringMVC组件之ThemeResolver"></a>SpringMVC组件之ThemeResolver</h2><p>SpringMVC中的主题组件是通过ThemeResolver接口来进行设置完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ThemeResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">resolveThemeName</span><span class="params">(HttpServletRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setThemeName</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String themeName)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在源码中我看到接口ThemeResolver提供了俩个方法分别是：<br>1&gt;resolveThemeName(…) 解析主题信息，并返回其名称；<br>2&gt;setThemeName(…)设置主题名称；</p>
<p>在SpringMVC中直接实现ThemeResolver接口的子类有如下2个：<br>    1&gt; org.springframework.web.servlet.theme.AbstractThemeResolver<br>    2&gt; org.springframework.web.servlet.theme.CookieThemeResolver</p>
<h3 id="AbstractThemeResolver"><a href="#AbstractThemeResolver" class="headerlink" title="AbstractThemeResolver"></a>AbstractThemeResolver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractThemeResolver</span> <span class="keyword">implements</span> <span class="title">ThemeResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String ORIGINAL_DEFAULT_THEME_NAME = <span class="string">"theme"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String defaultThemeName = ORIGINAL_DEFAULT_THEME_NAME;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultThemeName</span><span class="params">(String defaultThemeName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.defaultThemeName = defaultThemeName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getDefaultThemeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.defaultThemeName;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码分析我们看到了，在抽象实现类AbstractThemeResolver中提供了设置默认主题的属性以及方法，以备子类共用使用；<br>其子类分别有以下2个：<br>    1&gt; org.springframework.web.servlet.theme.FixedThemeResolver<br>    2&gt; org.springframework.web.servlet.theme.SessionThemeResolver</p>
<h4 id="FixedThemeResolver"><a href="#FixedThemeResolver" class="headerlink" title="FixedThemeResolver"></a>FixedThemeResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FixedThemeResolver</span> <span class="keyword">extends</span> <span class="title">AbstractThemeResolver</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">resolveThemeName</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getDefaultThemeName();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThemeName</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String themeName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot change theme - use a different theme resolution strategy"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们看到，FixedThemeResolver解析器只解析默认的主题，不支持主题切换。</p>
<h4 id="SessionThemeResolver"><a href="#SessionThemeResolver" class="headerlink" title="SessionThemeResolver"></a>SessionThemeResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionThemeResolver</span> <span class="keyword">extends</span> <span class="title">AbstractThemeResolver</span> </span>&#123;</span><br><span class="line">	public static final String THEME_SESSION_ATTRIBUTE_NAME = SessionThemeResolver.class.getName() + ".THEME";</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">resolveThemeName</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		String themeName = (String) WebUtils.getSessionAttribute(request, THEME_SESSION_ATTRIBUTE_NAME);</span><br><span class="line">		<span class="keyword">return</span> (themeName != <span class="keyword">null</span> ? themeName : getDefaultThemeName());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThemeName</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String themeName)</span> </span>&#123;</span><br><span class="line">		WebUtils.setSessionAttribute(request, THEME_SESSION_ATTRIBUTE_NAME,</span><br><span class="line">				(StringUtils.hasText(themeName) ? themeName : <span class="keyword">null</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们可以理解SessionThemeResolver解析器的工作原理是通过在Session中动态的获取前端用户设置的主题信息来动态改变当前请求的Web网站系统的主题；如果获取到的主题名称为空，则显示系统的默认主题；</p>
<h3 id="CookieThemeResolver"><a href="#CookieThemeResolver" class="headerlink" title="CookieThemeResolver"></a>CookieThemeResolver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CookieThemeResolver</span> <span class="keyword">extends</span> <span class="title">CookieGenerator</span> <span class="keyword">implements</span> <span class="title">ThemeResolver</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">resolveThemeName</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//检查当前请求对象中是否存在主题名称，如果不存在则继续后面的操作。</span></span><br><span class="line">		String themeName = (String) request.getAttribute(THEME_REQUEST_ATTRIBUTE_NAME);</span><br><span class="line">		<span class="keyword">if</span> (themeName != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> themeName;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//在当前的请求体中获取Cookie信息中存储的主题名称值来动态的设置主题</span></span><br><span class="line">		Cookie cookie = WebUtils.getCookie(request, getCookieName());</span><br><span class="line">		<span class="keyword">if</span> (cookie != <span class="keyword">null</span>) &#123;</span><br><span class="line">			String value = cookie.getValue();</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasText(value)) &#123;</span><br><span class="line">				themeName = value;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取默认的主题信息</span></span><br><span class="line">		<span class="keyword">if</span> (themeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">			themeName = getDefaultThemeName();</span><br><span class="line">		&#125;</span><br><span class="line">		request.setAttribute(THEME_REQUEST_ATTRIBUTE_NAME, themeName);</span><br><span class="line">		<span class="keyword">return</span> themeName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThemeName</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String themeName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(themeName)) &#123;</span><br><span class="line">			<span class="comment">// 在当前请求体重设置主题名称，同时在Cookie中将对应的值存储到客户端</span></span><br><span class="line">			request.setAttribute(THEME_REQUEST_ATTRIBUTE_NAME, themeName);</span><br><span class="line">			addCookie(response, themeName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//获取默认的主题信息设置到当前请求对象中，同时移除响应对象中Cookie值</span></span><br><span class="line">			request.setAttribute(THEME_REQUEST_ATTRIBUTE_NAME, getDefaultThemeName());</span><br><span class="line">			removeCookie(response);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析源码我们可以理解CookieThemeResolver的工作原理主要是使用了Cookie的工作方式进行动态的切换当前请求的Web网站系统的主题；</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">"themeResolver"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.springframework.web.servlet.theme.SessionThemeResolver"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>如果在我们的SpringMVC配置文件中不设置主题解析器，则系统默认主题为FixedThemeResolver；</p>
<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/22/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BLocaleResolver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/22/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BLocaleResolver/" class="post-title-link" itemprop="url">SpringMVC组件之LocaleResolver—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-22 19:42:21" itemprop="dateCreated datePublished" datetime="2014-03-22T19:42:21+08:00">2014-03-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SpringMVC组件之LocaleResolver"><a href="#SpringMVC组件之LocaleResolver" class="headerlink" title="SpringMVC组件之LocaleResolver"></a>SpringMVC组件之LocaleResolver</h2><p>LocaleResolver是SpringMVC中提供的对国际化语言的支持的组件，也就是我们经常说的多语化，通过这个组件我们可以使系统运行指定语言的Web页面。</p>
<p>该组件在Web容器中初始化的过程和MultipartResolver类似，我们这里就不再赘述。</p>
<h3 id="LocaleResolver的功能分析"><a href="#LocaleResolver的功能分析" class="headerlink" title="LocaleResolver的功能分析"></a>LocaleResolver的功能分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line">	<span class="function">Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上述源码我们可以看到其接口的功能只有俩个：<br>    1&gt; setLocale()一个是设置国际化语言；<br>    2&gt; resolveLocale()一个解析国际化语言；</p>
<p>以下是直接实现该接口的子类，总共有3个实现类，分别如下：</p>
<pre><code>1&gt; org.springframework.web.servlet.i18n.AbstractLocaleResolver
2&gt; org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver
3&gt; org.springframework.web.servlet.i18n.CookieLocaleResolver</code></pre><p>其中AcceptHeaderLocaleResolver是SpringMVC中默认的多语解析器</p>
<h4 id="AbstractLocaleResolver"><a href="#AbstractLocaleResolver" class="headerlink" title="AbstractLocaleResolver"></a>AbstractLocaleResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLocaleResolver</span> <span class="keyword">implements</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Locale defaultLocale;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultLocale</span><span class="params">(Locale defaultLocale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.defaultLocale = defaultLocale;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Locale <span class="title">getDefaultLocale</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.defaultLocale;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过源码看到AbstractLocaleResolver是一个抽象实现类，其中只是定义了一个国际化语言的对象以备后面的子类公用。<br>具体是实现子类有俩个：<br>    1&gt; org.springframework.web.servlet.i18n.FixedLocaleResolver<br>    2&gt; org.springframework.web.servlet.i18n.SessionLocaleResolver</p>
<h5 id="FixedLocaleResolver"><a href="#FixedLocaleResolver" class="headerlink" title="FixedLocaleResolver"></a>FixedLocaleResolver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FixedLocaleResolver</span> <span class="keyword">extends</span> <span class="title">AbstractLocaleResolver</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FixedLocaleResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FixedLocaleResolver</span><span class="params">(Locale locale)</span> </span>&#123;</span><br><span class="line">		setDefaultLocale(locale);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		Locale locale = getDefaultLocale();</span><br><span class="line">		<span class="keyword">if</span> (locale == <span class="keyword">null</span>) &#123;</span><br><span class="line">			locale = Locale.getDefault();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> locale;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(</span><br><span class="line">				<span class="string">"Cannot change fixed locale - use a different locale resolution strategy"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过具体的实现逻辑我们可以理解其是设置默认的国际化语言，并不支持多语的设置过程，其作用不是太大。</p>
<h5 id="SessionLocaleResolver"><a href="#SessionLocaleResolver" class="headerlink" title="SessionLocaleResolver"></a>SessionLocaleResolver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionLocaleResolver</span> <span class="keyword">extends</span> <span class="title">AbstractLocaleResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	public static final String LOCALE_SESSION_ATTRIBUTE_NAME = SessionLocaleResolver.class.getName() + ".LOCALE";</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		Locale locale = (Locale) WebUtils.getSessionAttribute(request, LOCALE_SESSION_ATTRIBUTE_NAME);</span><br><span class="line">		<span class="keyword">if</span> (locale == <span class="keyword">null</span>) &#123;</span><br><span class="line">			locale = determineDefaultLocale(request);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> locale;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Locale <span class="title">determineDefaultLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		Locale defaultLocale = getDefaultLocale();</span><br><span class="line">		<span class="keyword">if</span> (defaultLocale == <span class="keyword">null</span>) &#123;</span><br><span class="line">			defaultLocale = request.getLocale();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> defaultLocale;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span> </span>&#123;</span><br><span class="line">		WebUtils.setSessionAttribute(request, LOCALE_SESSION_ATTRIBUTE_NAME, locale);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上源码分析我们可以理解SessionLocaleResolver是通过在session中动态的设置语言类别来指定系统的运行语言。也就是当我们不同语种的用户在浏览支持国际化语言的同一个网站系统，多都是通过多语切换按钮 「<font color=red>主要功能就是请求系统在当前用户的Session中设置多语语种</font>」来实现我们不同语种的用户需求。当然，这种方式的一个弊端就是如果当前用户长时间没有访问系统的话，则session的超时处理会清空当前的多语类别，再次访问需要重新设置。</p>
<h4 id="AcceptHeaderLocaleResolver"><a href="#AcceptHeaderLocaleResolver" class="headerlink" title="AcceptHeaderLocaleResolver"></a>AcceptHeaderLocaleResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptHeaderLocaleResolver</span> <span class="keyword">implements</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> request.getLocale();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot change HTTP accept header - use a different locale resolution strategy"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上源码分析我们可以看到其只能通过客户端的语言环境来改变Web网站系统的显示语言，这种方式使用的过程对用户而言相对比较人性化「<font color=red>因为当我们浏览器访问请求头部Accept-Language为空时，就显示Web网站系统默认的语种了，这个时候对于不熟悉计算机的用户就显得有点蹩脚了</font>」，不需要其他过多的设置就可以浏览自己语种的需求的页面。</p>
<h4 id="CookieLocaleResolver"><a href="#CookieLocaleResolver" class="headerlink" title="CookieLocaleResolver"></a>CookieLocaleResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CookieLocaleResolver</span> <span class="keyword">extends</span> <span class="title">CookieGenerator</span> <span class="keyword">implements</span> <span class="title">LocaleResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	public static final String LOCALE_REQUEST_ATTRIBUTE_NAME = CookieLocaleResolver.class.getName() + ".LOCALE";</span><br><span class="line"></span><br><span class="line">	public static final String DEFAULT_COOKIE_NAME = CookieLocaleResolver.class.getName() + ".LOCALE";</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Locale defaultLocale;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CookieLocaleResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		setCookieName(DEFAULT_COOKIE_NAME);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultLocale</span><span class="params">(Locale defaultLocale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.defaultLocale = defaultLocale;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Locale <span class="title">getDefaultLocale</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.defaultLocale;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Locale <span class="title">resolveLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//检查请求对象是否有设置多语</span></span><br><span class="line">		Locale locale = (Locale) request.getAttribute(LOCALE_REQUEST_ATTRIBUTE_NAME);</span><br><span class="line">		<span class="keyword">if</span> (locale != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> locale;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//解析Cookie数据并获取多语信息</span></span><br><span class="line">		Cookie cookie = WebUtils.getCookie(request, getCookieName());</span><br><span class="line">		<span class="keyword">if</span> (cookie != <span class="keyword">null</span>) &#123;</span><br><span class="line">			locale = StringUtils.parseLocaleString(cookie.getValue());</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">"Parsed cookie value ["</span> + cookie.getValue() + <span class="string">"] into locale '"</span> + locale + <span class="string">"'"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (locale != <span class="keyword">null</span>) &#123;</span><br><span class="line">				request.setAttribute(LOCALE_REQUEST_ATTRIBUTE_NAME, locale);</span><br><span class="line">				<span class="keyword">return</span> locale;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> determineDefaultLocale(request);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (locale != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// 设置请求多语属性值并在Cookie中增加相对应的信息</span></span><br><span class="line">			request.setAttribute(LOCALE_REQUEST_ATTRIBUTE_NAME, locale);</span><br><span class="line">			addCookie(response, locale.toString());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 设置默认的多语属性值并清除Cookie中的信息</span></span><br><span class="line">			request.setAttribute(LOCALE_REQUEST_ATTRIBUTE_NAME, determineDefaultLocale(request));</span><br><span class="line">			removeCookie(response);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Locale <span class="title">determineDefaultLocale</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		Locale defaultLocale = getDefaultLocale();</span><br><span class="line">		<span class="keyword">if</span> (defaultLocale == <span class="keyword">null</span>) &#123;</span><br><span class="line">			defaultLocale = request.getLocale();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> defaultLocale;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上源码分析我们可以理解CookieLocaleResolver的方式是从我们请求对象中的Cookie信息来设置多语信息，这种方式类似于SessionLocaleResolver的方式，唯一的区别那就是「<font color=red>用户只要第一次访问时设置了多语，以后再请求该Web网站系统，就会一直是第一次设置的语种，除非把本地存储的对应的该站点的Cookie清除掉或过期后才需要重新设置</font>」</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"localeResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.i18n.SessionLocaleResolver"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果我们在SpringMVC的配置文件中不注入localeResolver的值，则默认使用AcceptHeaderLocaleResolver解析器。</p>
<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/20/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BMultipartResolver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/20/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BMultipartResolver/" class="post-title-link" itemprop="url">SpringMVC组件之MultipartResolver—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-20 17:02:19" itemprop="dateCreated datePublished" datetime="2014-03-20T17:02:19+08:00">2014-03-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SpringMVC组件之MultipartResolver"><a href="#SpringMVC组件之MultipartResolver" class="headerlink" title="SpringMVC组件之MultipartResolver"></a>SpringMVC组件之MultipartResolver</h2><p>MultipartResolver是一个文件上传相关的解析器，当我们的Web容器启动的时候SpringMVC的会在DispatchServlet中先初始化这个解析器（整个生命周期只初始化一次），初始化源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 省略部分代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MULTIPART_RESOLVER_BEAN_NAME = <span class="string">"multipartResolver"</span>;</span><br><span class="line"><span class="keyword">private</span> MultipartResolver multipartResolver;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMultipartResolver</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 这里是在容器中来获取MultipartResolver的实例</span></span><br><span class="line">		<span class="keyword">this</span>.multipartResolver = context.getBean(MULTIPART_RESOLVER_BEAN_NAME, MultipartResolver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 省略部分代码</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">		<span class="keyword">this</span>.multipartResolver = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">// 省略部分代码</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 省略部分代码</span></span><br></pre></td></tr></table></figure>
<p>通过以上源码我们看到在DispatchServlet中的初始化过程。<br>当我们每次对Web容器发起满足SpringMVC的映射地址规则的时候，都会在DispatchServlet中进行文件上传解析的检查，过程代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="comment">// 省略其他代码</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		processedRequest = checkMultipart(request);</span><br><span class="line">		multipartRequestParsed = processedRequest != request;</span><br><span class="line">	<span class="comment">// 省略其他代码</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="comment">// 省略部分代码</span></span><br><span class="line">		<span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">			<span class="comment">//清除文件上传相关的临时资源</span></span><br><span class="line">			cleanupMultipart(processedRequest);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这个是整个文件上传的检查方法</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> HttpServletRequest <span class="title">checkMultipart</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.multipartResolver != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.multipartResolver.isMultipart(request)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (request <span class="keyword">instanceof</span> MultipartHttpServletRequest) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Request is already a MultipartHttpServletRequest - if not in a forward, "</span> +</span><br><span class="line">					<span class="string">"this typically results from an additional MultipartFilter in web.xml"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.multipartResolver.resolveMultipart(request);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If not returned before: return original request.</span></span><br><span class="line">	<span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个是文件上传后清除相关的临时资源</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">cleanupMultipart</span><span class="params">(HttpServletRequest servletRequest)</span> </span>&#123;</span><br><span class="line">	MultipartHttpServletRequest req = WebUtils.getNativeRequest(servletRequest, MultipartHttpServletRequest<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="keyword">if</span> (req != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">this</span>.multipartResolver.cleanupMultipart(req);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是MultipartResolver在DispatchServlet中的使用过程，接下来我们一起看MultipartResolver的真面目，&gt;&amp;&lt;……</p>
<h3 id="MultipartResolver的功能分析"><a href="#MultipartResolver的功能分析" class="headerlink" title="MultipartResolver的功能分析"></a>MultipartResolver的功能分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartResolver</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isMultipart</span><span class="params">(HttpServletRequest request)</span></span>;</span><br><span class="line">	<span class="function">MultipartHttpServletRequest <span class="title">resolveMultipart</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cleanupMultipart</span><span class="params">(MultipartHttpServletRequest request)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过源码可以看到MultipartResolver是一个接口，其中提供了三个方法供子类来实现。</p>
<ol>
<li>isMultipart(…)是用来检查我们当前的请求是否是MultipartHttpServletRequest</li>
<li>resolveMultipart(…)就是最核心的方法，及解析器。</li>
<li>cleanupMultipart(…)就是清除文件上传相关的临时资源。</li>
</ol>
<p>通过开发环境我们可以看到具体实现了MultipartResolver接口的类有如下几个类：</p>
<h4 id="CommonsMultipartResolver"><a href="#CommonsMultipartResolver" class="headerlink" title="CommonsMultipartResolver"></a>CommonsMultipartResolver</h4><h5 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsMultipartResolver</span> <span class="keyword">extends</span> <span class="title">CommonsFileUploadSupport</span> <span class="keyword">implements</span> <span class="title">MultipartResolver</span>, <span class="title">ServletContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> resolveLazily = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CommonsMultipartResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CommonsMultipartResolver</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>();</span><br><span class="line">		setServletContext(servletContext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResolveLazily</span><span class="params">(<span class="keyword">boolean</span> resolveLazily)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.resolveLazily = resolveLazily;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> FileUpload <span class="title">newFileUpload</span><span class="params">(FileItemFactory fileItemFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ServletFileUpload(fileItemFactory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServletContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isUploadTempDirSpecified()) &#123;</span><br><span class="line">			getFileItemFactory().setRepository(WebUtils.getTempDir(servletContext));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMultipart</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (request != <span class="keyword">null</span> &amp;&amp; ServletFileUpload.isMultipartContent(request));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MultipartHttpServletRequest <span class="title">resolveMultipart</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException </span>&#123;</span><br><span class="line">		Assert.notNull(request, <span class="string">"Request must not be null"</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.resolveLazily) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> DefaultMultipartHttpServletRequest(request) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeMultipart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					MultipartParsingResult parsingResult = parseRequest(request);</span><br><span class="line">					setMultipartFiles(parsingResult.getMultipartFiles());</span><br><span class="line">					setMultipartParameters(parsingResult.getMultipartParameters());</span><br><span class="line">					setMultipartParameterContentTypes(parsingResult.getMultipartParameterContentTypes());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			MultipartParsingResult parsingResult = parseRequest(request);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> DefaultMultipartHttpServletRequest(request, parsingResult.getMultipartFiles(),</span><br><span class="line">					parsingResult.getMultipartParameters(), parsingResult.getMultipartParameterContentTypes());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> MultipartParsingResult <span class="title">parseRequest</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException </span>&#123;</span><br><span class="line">		String encoding = determineEncoding(request);</span><br><span class="line">		FileUpload fileUpload = prepareFileUpload(encoding);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			List&lt;FileItem&gt; fileItems = ((ServletFileUpload) fileUpload).parseRequest(request);</span><br><span class="line">			<span class="keyword">return</span> parseFileItems(fileItems, encoding);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (FileUploadBase.SizeLimitExceededException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MaxUploadSizeExceededException(fileUpload.getSizeMax(), ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (FileUploadException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MultipartException(<span class="string">"Could not parse multipart servlet request"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">determineEncoding</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		String encoding = request.getCharacterEncoding();</span><br><span class="line">		<span class="keyword">if</span> (encoding == <span class="keyword">null</span>) &#123;</span><br><span class="line">			encoding = getDefaultEncoding();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> encoding;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanupMultipart</span><span class="params">(MultipartHttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				cleanupFileItems(request.getMultiFileMap());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">				logger.warn(<span class="string">"Failed to perform multipart cleanup for servlet request"</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上述的源码分析在使用CommonsMultipartResolver解析器的时候是需要其他的jar包的支持（commons-fileupload.jar 和 common-io.jar）;</p>
<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义文件上传解析器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"multipartResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设定默认编码 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultEncoding"</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设定文件上传的最大值为2MB，2*1024*1024 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxUploadSize"</span> <span class="attr">value</span>=<span class="string">"2097152"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设定文件上传时写入内存的最大值，如果小于这个参数不会生成临时文件，默认为10240 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxInMemorySize"</span> <span class="attr">value</span>=<span class="string">"10240"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置上传文件的临时路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"uploadTempDir"</span> <span class="attr">value</span>=<span class="string">"fileUpload/maxsoft-temp"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 是否延迟文件解析 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"resolveLazily"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="表单的代码"><a href="#表单的代码" class="headerlink" title="表单的代码"></a>表单的代码</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"maxsoft/upload"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">     &lt;input type=<span class="string">"maxsoft_file"</span> name=<span class="string">"maxsoft_file"</span>&gt;</span><br><span class="line">     &lt;input type=<span class="string">"submit"</span> value=<span class="string">"提交"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>注意：在上传文件的表单中一定要设置表单类型 enctype=”multipart/form-data”，否则服务器不会执行文件上传逻辑。</p>
<h5 id="服务端逻辑"><a href="#服务端逻辑" class="headerlink" title="服务端逻辑"></a>服务端逻辑</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">HttpServletRequest request;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">HttpSession session;</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/upload"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">upload</span><span class="params">(@RequestParam(value = <span class="string">"maxsoft_file"</span>, required = <span class="keyword">false</span>)</span> MultipartFile maxsoft_file) </span>&#123;</span><br><span class="line">    <span class="comment">// 非空校验</span></span><br><span class="line">    <span class="keyword">if</span>(!maxsoft_file.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 定义文件路径</span></span><br><span class="line">        String path = request.getServletContext().getRealPath(<span class="string">"/"</span>);</span><br><span class="line">        <span class="comment">// 定义文件名称</span></span><br><span class="line">        String name = String.valueOf(<span class="keyword">new</span> Date().getTime()+<span class="string">"_"</span> + maxsoft_file.getOriginalFilename());</span><br><span class="line">        File destFile = <span class="keyword">new</span> File(path,name);</span><br><span class="line">        <span class="comment">// 存储文件文件</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            maxsoft_file.transferTo(destFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalStateException | IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;        </span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.setViewName(<span class="string">"maxsoft/main"</span>);</span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="StandardServletMultipartResolver"><a href="#StandardServletMultipartResolver" class="headerlink" title="StandardServletMultipartResolver"></a>StandardServletMultipartResolver</h4><h5 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardServletMultipartResolver</span> <span class="keyword">implements</span> <span class="title">MultipartResolver</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMultipart</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 检查请求对象的方法类型</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="string">"post"</span>.equals(request.getMethod().toLowerCase())) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		String contentType = request.getContentType();</span><br><span class="line">		<span class="keyword">return</span> (contentType != <span class="keyword">null</span> &amp;&amp; contentType.toLowerCase().startsWith(<span class="string">"multipart/"</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MultipartHttpServletRequest <span class="title">resolveMultipart</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> StandardMultipartHttpServletRequest(request);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanupMultipart</span><span class="params">(MultipartHttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (Part part : request.getParts()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (request.getFile(part.getName()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">					part.delete();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			LogFactory.getLog(getClass()).warn(<span class="string">"Failed to perform cleanup of multipart items"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上源码分析可以看出在StandardServletMultipartResolver解析器中不需要任何其他的jar包，只要容器的Servlet版本为高版本（3.0+）的ServletAPI即可运行，笔者使用了Tomcat7.0。</p>
<h5 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h5><p>首先我们在Spring容器中将该解析器注入其中，过程如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"multipartResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.multipart.support.StandardServletMultipartResolver"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>web.xml上传文件属性属性配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">multipart-config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 存储文件的临时目录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>d:/<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 文件大小限制2MB --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">max-file-size</span>&gt;</span>2097152<span class="tag">&lt;/<span class="name">max-file-size</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 上传文件整个请求对象大小限制 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">max-request-size</span>&gt;</span>4194304<span class="tag">&lt;/<span class="name">max-request-size</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">multipart-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="表单代码-amp-服务端逻辑"><a href="#表单代码-amp-服务端逻辑" class="headerlink" title="表单代码 &amp; 服务端逻辑"></a>表单代码 &amp; 服务端逻辑</h5><p>表单代码和服务端逻辑基本和第一模一样，这里就不在赘述了。<br>在服务端接收文件的时候可以使用 MultipartHttpServletRequest , 也可以使用 MultipartFile，<br>当使用我们MultipartHttpServletRequest来接收文件数据时，只要在服务器获取这个对象的实例，通过其getFile(‘表单文件名’)或getFiles(‘表单文件名’),获取即可。<br>以下是解析文件的最核心的代码，器使用 servlet3.0 的 request.getParts() 方法获取上传文件，并将其封装到 MultipartFile 对象中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardMultipartHttpServletRequest</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(request);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Collection&lt;Part&gt; parts = request.getParts();</span><br><span class="line">		MultiValueMap&lt;String, MultipartFile&gt; files = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, MultipartFile&gt;(parts.size());</span><br><span class="line">		<span class="keyword">for</span> (Part part : parts) &#123;</span><br><span class="line">			String filename = extractFilename(part.getHeader(CONTENT_DISPOSITION));</span><br><span class="line">			<span class="keyword">if</span> (filename != <span class="keyword">null</span>) &#123;</span><br><span class="line">				files.add(part.getName(), <span class="keyword">new</span> StandardMultipartFile(part, filename));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		setMultipartFiles(files);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> MultipartException(<span class="string">"Could not parse multipart servlet request"</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="相关源码"><a href="#相关源码" class="headerlink" title="相关源码"></a>相关源码</h5><h6 id="MultipartHttpServletRequest"><a href="#MultipartHttpServletRequest" class="headerlink" title="MultipartHttpServletRequest"></a>MultipartHttpServletRequest</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartHttpServletRequest</span> <span class="keyword">extends</span> <span class="title">HttpServletRequest</span>, <span class="title">MultipartRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">HttpMethod <span class="title">getRequestMethod</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">HttpHeaders <span class="title">getRequestHeaders</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">HttpHeaders <span class="title">getMultipartHeaders</span><span class="params">(String paramOrFileName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="MultipartRequest"><a href="#MultipartRequest" class="headerlink" title="MultipartRequest"></a>MultipartRequest</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MultipartRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">Iterator&lt;String&gt; <span class="title">getFileNames</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">MultipartFile <span class="title">getFile</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">List&lt;MultipartFile&gt; <span class="title">getFiles</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">Map&lt;String, MultipartFile&gt; <span class="title">getFileMap</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">MultiValueMap&lt;String, MultipartFile&gt; <span class="title">getMultiFileMap</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">getMultipartContentType</span><span class="params">(String paramOrFileName)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#####</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardMultipartHttpServletRequest</span> <span class="keyword">extends</span> <span class="title">AbstractMultipartHttpServletRequest</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_DISPOSITION = <span class="string">"content-disposition"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILENAME_KEY = <span class="string">"filename="</span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">StandardMultipartHttpServletRequest</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> MultipartException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(request);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Collection&lt;Part&gt; parts = request.getParts();</span><br><span class="line">			MultiValueMap&lt;String, MultipartFile&gt; files = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, MultipartFile&gt;(parts.size());</span><br><span class="line">			<span class="keyword">for</span> (Part part : parts) &#123;</span><br><span class="line">				String filename = extractFilename(part.getHeader(CONTENT_DISPOSITION));</span><br><span class="line">				<span class="keyword">if</span> (filename != <span class="keyword">null</span>) &#123;</span><br><span class="line">					files.add(part.getName(), <span class="keyword">new</span> StandardMultipartFile(part, filename));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			setMultipartFiles(files);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MultipartException(<span class="string">"Could not parse multipart servlet request"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">extractFilename</span><span class="params">(String contentDisposition)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (contentDisposition == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> can only handle the typical case at the moment</span></span><br><span class="line">		<span class="keyword">int</span> startIndex = contentDisposition.indexOf(FILENAME_KEY);</span><br><span class="line">		<span class="keyword">if</span> (startIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		String filename = contentDisposition.substring(startIndex + FILENAME_KEY.length());</span><br><span class="line">		<span class="keyword">if</span> (filename.startsWith(<span class="string">"\""</span>)) &#123;</span><br><span class="line">			<span class="keyword">int</span> endIndex = filename.indexOf(<span class="string">"\""</span>, <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span> (endIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> filename.substring(<span class="number">1</span>, endIndex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> endIndex = filename.indexOf(<span class="string">";"</span>);</span><br><span class="line">			<span class="keyword">if</span> (endIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> filename.substring(<span class="number">0</span>, endIndex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> filename;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getMultipartContentType</span><span class="params">(String paramOrFileName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Part part = getPart(paramOrFileName);</span><br><span class="line">			<span class="keyword">return</span> (part != <span class="keyword">null</span> ? part.getContentType() : <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MultipartException(<span class="string">"Could not access multipart servlet request"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HttpHeaders <span class="title">getMultipartHeaders</span><span class="params">(String paramOrFileName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Part part = getPart(paramOrFileName);</span><br><span class="line">			<span class="keyword">if</span> (part != <span class="keyword">null</span>) &#123;</span><br><span class="line">				HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">				<span class="keyword">for</span> (String headerName : part.getHeaderNames()) &#123;</span><br><span class="line">					headers.put(headerName, <span class="keyword">new</span> ArrayList&lt;String&gt;(part.getHeaders(headerName)));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> headers;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> MultipartException(<span class="string">"Could not access multipart servlet request"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardMultipartFile</span> <span class="keyword">implements</span> <span class="title">MultipartFile</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 省略部分代码</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/18/SpringMVC%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/18/SpringMVC%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0/" class="post-title-link" itemprop="url">SpringMVC的工作原理概述—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-18 23:42:49" itemprop="dateCreated datePublished" datetime="2014-03-18T23:42:49+08:00">2014-03-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SpringMVC的工作原理"><a href="#SpringMVC的工作原理" class="headerlink" title="SpringMVC的工作原理"></a>SpringMVC的工作原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Spring Web MVC是原始的WebFramework在Servlet API 的基础之上建立的MVC框架。当时，Spring Web MVC是被包含在了Spring Framework体系中。它的标准名称就是“Spring Web MVC”，这个名字来自于Spring体系源码模块spring-webmvc。但是它也通常被称为“Spring MVC”。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringMVC组件灵活多样，支持多种工作流程。</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SpringMVC也是一个请求驱动的框架，使用了前端控制器模式来设计实现。我们通过配置文件也可以理解，其核心就是一个Servlet（DispatcherServlet）。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span><br><span class="line">    xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">    xsi:schemaLocation=<span class="string">"</span></span><br><span class="line"><span class="string">            http://java.sun.com/xml/ns/javaee</span></span><br><span class="line"><span class="string">            http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span><br><span class="line">    version=<span class="string">"3.0"</span>&gt;</span><br><span class="line">	...</span><br><span class="line">	&lt;servlet&gt;</span><br><span class="line">		&lt;servlet-name&gt;DispatcherServlet&lt;/servlet-name&gt;</span><br><span class="line">		&lt;servlet-<span class="class"><span class="keyword">class</span>&gt;<span class="title">org</span>.<span class="title">springframework</span>.<span class="title">web</span>.<span class="title">servlet</span>.<span class="title">DispatcherServlet</span>&lt;/<span class="title">servlet</span>-<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">		&lt;<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">			&lt;<span class="title">param</span>-<span class="title">name</span>&gt;<span class="title">contextConfigLocation</span>&lt;/<span class="title">param</span>-<span class="title">name</span>&gt;</span></span><br><span class="line">			&lt;param-value&gt;classpath:spring/spring-*.xml&lt;/param-value&gt;</span><br><span class="line">		&lt;/init-param&gt;</span><br><span class="line">		&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">	&lt;/servlet&gt;</span><br><span class="line">	&lt;servlet-mapping&gt;</span><br><span class="line">		&lt;servlet-name&gt;DispatcherServlet&lt;/servlet-name&gt;</span><br><span class="line">		&lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">	&lt;/servlet-mapping&gt;</span><br><span class="line">	...</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>
<p>在配置文件中我可以看到，客户端对Web容器发起请求，如果请求地址满足指定的地址规则，则容器就会转发到SpringMVC的前端控制器（DispatcherServlet），进行相对应的地址映射查找以及执行对应的后端控制器，业务层，数据模型等。具体过程我们可以分析以下源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title">FrameworkServlet</span> </span>&#123;</span><br><span class="line">	<span class="comment">//省略部分代码</span></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		<span class="comment">// 这里在程序初始化的时候就加载SpringMVC的相关配置文件</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(DEFAULT_STRATEGIES_PATH, DispatcherServlet<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			defaultStrategies = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Could not load 'DispatcherServlet.properties': "</span> + ex.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line">	<span class="comment">// 开始初始化SpringMVC相关组件信息</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initStrategies</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">		initMultipartResolver(context);  <span class="comment">// 多媒体文件解析器</span></span><br><span class="line">		initLocaleResolver(context); <span class="comment">// 多语解析器</span></span><br><span class="line">		initThemeResolver(context); <span class="comment">// 主题解析器</span></span><br><span class="line">		initHandlerMappings(context); <span class="comment">// 控制器句柄映射集合</span></span><br><span class="line">		initHandlerAdapters(context); <span class="comment">//控制器句柄适配器</span></span><br><span class="line">		initHandlerExceptionResolvers(context); <span class="comment">//句柄异常解析器</span></span><br><span class="line">		initRequestToViewNameTranslator(context); <span class="comment">//请求视图名称转换器</span></span><br><span class="line">		initViewResolvers(context); <span class="comment">//视图解析器</span></span><br><span class="line">		initFlashMapManager(context); <span class="comment">//flash映射管理器</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 记录请求参数快照</span></span><br><span class="line">		Map&lt;String, Object&gt; attributesSnapshot = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Taking snapshot of request attributes before include"</span>);</span><br><span class="line">			attributesSnapshot = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">			Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">			<span class="keyword">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class="line">				String attrName = (String) attrNames.nextElement();</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.cleanupAfterInclude || attrName.startsWith(<span class="string">"org.springframework.web.servlet"</span>)) &#123;</span><br><span class="line">					attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 开始添加框架中使用的相关Request参数对象值</span></span><br><span class="line">		request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">		request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.localeResolver);</span><br><span class="line">		request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.themeResolver);</span><br><span class="line">		request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line"></span><br><span class="line">		FlashMap inputFlashMap = <span class="keyword">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">		<span class="keyword">if</span> (inputFlashMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">			request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">		&#125;</span><br><span class="line">		request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="keyword">new</span> FlashMap());</span><br><span class="line">		request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="keyword">this</span>.flashMapManager);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//开始控制器分发</span></span><br><span class="line">			doDispatch(request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//将初始的请求参数快照，重新存储到当前请求对象中</span></span><br><span class="line">			<span class="keyword">if</span> (attributesSnapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">				restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 控制器分发</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		HttpServletRequest processedRequest = request;</span><br><span class="line">		HandlerExecutionChain mappedHandler = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">boolean</span> multipartRequestParsed = <span class="keyword">false</span>;</span><br><span class="line">		<span class="comment">// 初始化异步请求管理器</span></span><br><span class="line">		WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ModelAndView mv = <span class="keyword">null</span>;</span><br><span class="line">			Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// 检查是否有多媒体文件上传，如果有多媒体文件上传，则进行MultipartResolver解析器的相关解析操作；</span></span><br><span class="line">				processedRequest = checkMultipart(request);</span><br><span class="line">				multipartRequestParsed = processedRequest != request;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//获取当前请求的控制器句柄</span></span><br><span class="line">				mappedHandler = getHandler(processedRequest, <span class="keyword">false</span>);</span><br><span class="line">				<span class="keyword">if</span> (mappedHandler == <span class="keyword">null</span> || mappedHandler.getHandler() == <span class="keyword">null</span>) &#123;</span><br><span class="line">					noHandlerFound(processedRequest, response);</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 将控制器句柄组装为通用的适配器对象</span></span><br><span class="line">				HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 省略部分代码 </span></span><br><span class="line"></span><br><span class="line">				<span class="comment">// 执行控制器相关的拦截器预处理逻辑</span></span><br><span class="line">				<span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">// 通过适配器执行控制器的相关逻辑,并返回模型视图</span></span><br><span class="line">					mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//省略部分代码</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				dispatchException = ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 处理异常、请求状态及触发请求完成事件以及视图渲染等</span></span><br><span class="line">			processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">			triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">				<span class="comment">//执行控制器的相关拦截器执行完成的逻辑</span></span><br><span class="line">				mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//清除多媒体文件上传过程中使用的相关资源</span></span><br><span class="line">			<span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">				cleanupMultipart(processedRequest);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行原理图"><a href="#运行原理图" class="headerlink" title="运行原理图"></a>运行原理图</h3><p>通过以上代码分析后，下面这张图片可以更加直观的展现出SpringMVC的工作原理（网络配图）。<br><img src="/uploads/SpringMVC.jpg" /></p>
<h3 id="运行过程总结"><a href="#运行过程总结" class="headerlink" title="运行过程总结"></a>运行过程总结</h3><p>第一步：客户端向Web容器发起请求后，容器会通过配置文件检查URL是否满足SpringMVC的Url规则，如果满足则请求进入DispatchServlet控制器。</p>
<p>第二步：在DispatchServlet中首先通过请求地址查询对应的控制器；</p>
<p>第三步：通过查询到的控制器进行组装适配器，进而通过其执行控制器的相关逻辑（业务层，数据访问层）；</p>
<p>第四步：适配器执行后返回ModelAndView，</p>
<p>第五步：控制器请求视图解析器（ViewResolver）去进行视图解析，渲染等操作后将向用户响应结果</p>
<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/11/JavaWeb%E4%B9%8BServlet%EF%BC%8C%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%8C%E7%9B%91%E5%90%AC%E5%99%A8%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/11/JavaWeb%E4%B9%8BServlet%EF%BC%8C%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%8C%E7%9B%91%E5%90%AC%E5%99%A8%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">JavaWeb之Servlet，过滤器，监听器总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-11 21:21:09" itemprop="dateCreated datePublished" datetime="2014-03-11T21:21:09+08:00">2014-03-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaWeb/" itemprop="url" rel="index">
                    <span itemprop="name">JavaWeb</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最近的所有独立功能模块都是基于单纯的 Servlet 技术来实现完成，并没有借助其他的第三方技术框架，所以今天有必要来总结一下这些使用的关键技术（ Servlet，Filter，Listener ），以加深记忆和理解。同时，也为今后的工作中熟练使用这些技术而夯实基础。</p>
<h2 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Java Servlet （Server Applet）是运行在 Web 服务器或应用服务器上的程序，它是作为来自 Web 浏览器或其他 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。使用 Servlet，可以收集来自网页表单的用户输入信息，以及呈现来自数据库或者其他源的记录并动态创建网页。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color=red>Java Servlet 生命周期可被定义为从创建直到销毁的整个过程</font>。如下：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1· 通过调用 init () 方法进行初始化（容器启动时执行）。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2· 通过调用 service() 方法来处理客户端的请求。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3· 通过调用 destroy() 方法终止（容器停止时执行）。<br>Java Servlet 所有的子类实现都是基于顶层 Servlet 的接口规范。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException</span>; <span class="comment">//初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span></span>; <span class="comment">//获取Servlet配置信息</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException</span>; <span class="comment">//Servlet服务</span></span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span></span>; <span class="comment">//获取Servlet相关的信息</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>; <span class="comment">//Servlet销毁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下为一个完整的 Servlet 应用实现过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.summary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		response.getWriter().print(<span class="string">"Hello MaxSoft ! This is get method."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		response.getWriter().print(<span class="string">"Hello MaxSoft ! This is post method."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPut</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		response.getWriter().print(<span class="string">"Hello MaxSoft ! This is put method."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDelete</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		response.getWriter().print(<span class="string">"Hello MaxSoft ! This is delete method."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		response.addHeader(<span class="string">"Author-Info"</span>, <span class="string">"MaxSoft"</span>);</span><br><span class="line">		<span class="comment">//这里可以实现所有方法共同的逻辑，如编码转换，响应头的信息添加等</span></span><br><span class="line">		<span class="keyword">super</span>.service(request, response);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册以上 Servlet （TestServlet.java）到Web容器中web.xml（Tomcat）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span> <span class="meta-string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">display-name</span>&gt;</span>FlexEngagementRing<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  	<span class="comment">&lt;!-- 省略其他配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>testServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.maxsoft.summary.TestServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 省略其他配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>testServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/testServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Servlet API 中提供了一个 Filter 接口，开发 Web 应用时可以借助这个接口来实现对 Web 请求的过滤操作（请求或响应），则该实现类就被称为「过滤器」。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color=red>Filter 生命周期和 Servlet 类似也被定义为从创建直到销毁的整个过程</font>。如下：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1· 通过调用 init () 方法进行初始化（容器启动时执行）。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2· 通过调用 doFilter() 方法来处理客户端的请求。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3· 通过调用 destroy() 方法终止（容器停止时执行）。<br>Filter 所有的子类实现都是基于顶层 Filter 的接口规范。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span> <span class="params">( ServletRequest request, ServletResponse response, FilterChain chain )</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下为一个完整的 Filter 应用实现过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.summary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Filter destroy ！"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">		response.getWriter().println(<span class="string">"[Befor] This is Filter ...... "</span>);</span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">		response.getWriter().println(<span class="string">"[After] This is Filter ...... "</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Filter init ！"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册以上 Filter （TestFilter.java）到Web容器中web.xml（Tomcat）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">display-name</span>&gt;</span>FlexEngagementRing<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>TestFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">description</span>&gt;</span>test<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.maxsoft.summary.TestFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>TestFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 省略其他配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>testServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.maxsoft.summary.TestServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 省略其他配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>testServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/testServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上运行效果如下：<img src="/uploads/filter_0.png" /></p>
<h2 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Servlet API 中定提供了多种类型的监听器，它们分别对 ServletContext、 HttpSession、ServletRequest 数据域对象创建销毁和内部数据状态的改变进行监听。<br/><font color=red>ServletContext 相关的监听器如下：</font><br>1· javax.servlet.ServletContextAttributeListener<br>2· javax.servlet.ServletContextListener<br/><font color=red>ServletRequest 相关的监听器如下（servlet-api-2.3中貌似没有提供这俩监听器）：</font><br>1· javax.servlet.ServletRequestAttributeListener.class<br>2· javax.servlet.ServletRequestListener.class<br/><font color=red>HttpSession 相关的监听器如下：</font><br>1· javax.servlet.http.HttpSessionActivationListener<br>2· javax.servlet.http.HttpSessionAttributeListener<br>3· javax.servlet.http.HttpSessionBindingListener<br>4· javax.servlet.http.HttpSessionListener<br>以上监听器都是基于 JDK 中提供的 EventListener 接口规范而进行个差异化实现。<br>它们大致可以分为三种类型的事件：<br>1· 数据域对象创建和销毁的事件监听器<br>2· 数据域对象的相关属性变更事件监听器<br>3· 绑定到Session中数据对象本身状态变更的事件监听器<br><font color=red>Listener 生命周期伴随着Web容器的整个生命过程</font>。<br>EventListener 接口规范如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.util;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">	<span class="comment">//TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当我们在 Web 开发过程中需要哪种类型的监听器只要实现其对应的接口即可进行相对应的事件逻辑处理。我们现在以 HttpSession 的初始化与销毁为例进行监听器的实现，代码逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.summary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSessionEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSessionListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.maxsoft.session.listener.SessionConstant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestHttpSessionListener</span> <span class="keyword">implements</span> <span class="title">HttpSessionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCreated</span><span class="params">(HttpSessionEvent event)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//Session创建时执行的事件逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionDestroyed</span><span class="params">(HttpSessionEvent event)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//Session销毁时执行的事件逻辑</span></span><br><span class="line">    	HttpSession session = event.getSession();</span><br><span class="line">		Object user = session.getAttribute(SessionConstant.USER_VO);</span><br><span class="line">		Object userName = session.getAttribute(SessionConstant.USER_NAME);</span><br><span class="line">		Object userCode = session.getAttribute(SessionConstant.USER_CODE);</span><br><span class="line">		System.out.println( <span class="string">"User:"</span> + user + <span class="string">"  Name:"</span> + userName + <span class="string">"  Code:"</span> + userCode);</span><br><span class="line">		ServletContext context = session.getServletContext();</span><br><span class="line">		String user_uuid = (String)session.getAttribute(SessionConstant.USER_UUID);</span><br><span class="line">		context.removeAttribute(user_uuid);</span><br><span class="line">		</span><br><span class="line">		System.out.print(<span class="string">"Session登录信息超时销毁。。。。。。"</span>);</span><br><span class="line">		</span><br><span class="line">		System.out.print(<span class="string">"这里也可以通过数据库进行数据持久操作。。。。。。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册以上监听器到Web容器中web.xml ( Tomcat )：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">display-name</span>&gt;</span>FlexEngagementRing<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>TestFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">description</span>&gt;</span>test<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.maxsoft.summary.TestFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>TestFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span> </span><br><span class="line">  	<span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.maxsoft.summary.TestHttpSessionListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 省略其他配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>testServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.maxsoft.summary.TestServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 省略其他配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>testServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/testServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>10<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上示例的运行结果为，如果用户登录系统后进行退出系统时或者Session达到了系统的超时时间，则会触发Session销毁的事件，进而执行事件体中相关的代码逻辑。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在Web容器中它们三者的启动顺序大致为：Listener → Filter → Servlet；我们在开发 Web 应用程序时，可以通过不同的使用场景进行选择使用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/09/JavaWeb%E5%85%B3%E4%BA%8E%E9%80%80%E5%87%BA%E7%B3%BB%E7%BB%9F%E6%97%B6%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/09/JavaWeb%E5%85%B3%E4%BA%8E%E9%80%80%E5%87%BA%E7%B3%BB%E7%BB%9F%E6%97%B6%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">JavaWeb关于退出系统时的日志记录</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-09 19:51:32" itemprop="dateCreated datePublished" datetime="2014-03-09T19:51:32+08:00">2014-03-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaWeb/" itemprop="url" rel="index">
                    <span itemprop="name">JavaWeb</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过这俩周的时间，终于把相关的独立模块功能都悉数完成了，接下来的工作就是和第三方框架（ Spring ， Struts2.0，Hibernate  ）来进行集成开发了。在前天和教导老师沟通后，又新增了几个相对较小，但是比较适用的新功能。分别有「登录退出日志记录」,「是否已登录的校验并剔除登录功能」,「防重复提交功能」。<br>由于「防重复提交功能」需要用到Spring中相关的拦截器功能需要集成开发时进行记录总结，而「登录退出日志记录」,「是否已登录的校验并剔除登录功能」可以通过重写 Session 销毁事件进行统一处理，所以今天就统一介绍关于「登录退出日志记录」,「是否已登录的校验并剔除登录功能」的实现过程。「防重复提交功能」放到后面的集成开发中来做详细的记录总结。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先登录日志记录可以通过登录事件后添加相关的日志记录逻辑进行登录日志的记录，相对比较简单，这里就不做过多的介绍了。我们主要来实现退出系统时的日志记录，退出系统主要有如下几种场景：<br>1· 登录系统后做完相关业务操作，点击退出按钮进行退出操作。<br>2· 登录系统后做完相关业务直接关闭浏览器<br>3· 登录后网络中断（边界场景）。<br/><font color=red><b>注意：</b>以上2,3 这种情况是相对不好处理，只能等到Session自动销毁后做相关日志信息记录以及其他的操作。</font><br>通过分析后我们可以得知用户不论以哪种场景做退出操作，都最终体现在了 Session 的销毁方面，所以我们为能够全面的覆盖以上这几种场景，可以直接将日志记录逻辑写入到Session销毁的方法中，进而完美的达到了我们预期的功能结果。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接下来我们分析「是否已登录的校验并剔除登录功能」，这个功能乍一看感觉相对比较复杂，其实当我们理解了 Session ，Appalachian（ ServletContext ）的生命周期后就会变得相对容易了。<br><b style="color:red;">Session</b>：从用户发起登录请求并进入系统后到用户点击退出操作或者长时间没有操作达到了系统中设定的 Session 销毁时间，为一个生命周期。<br><b style="color:red;">Application（ServletContext）</b>：从系统启动到系统停止，为一个生命周期。<br>首先我们可以在用户登录系统后将其唯一信息（UUID等）做为键写入到 Application（ ServletContext ）中（以备登录系统后用来校验该用户是否已经登录系统），并且在 Session 销毁时将 UUID 从 Application（ ServletContext ）中移除。如果用户在A电脑登录系统后，没有做退出操作，又在B电脑进行了登陆操作，这时可以通过校验逻辑在  Application（ ServletContext ）中获取该用户的 UUID ，如果有值，则表示用户已登录系统，这时可以进行合适的提示处理。如果没有值，则可以直接登陆。</p>
<h2 id="代码逻辑"><a href="#代码逻辑" class="headerlink" title="代码逻辑"></a>代码逻辑</h2><p>1· 相关的Java大致代码逻辑如下（ SessionTimeoutListener.java ），主要实现了 HttpSessionListener ，HttpSessionAttributeListener 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.session.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSessionAttributeListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSessionBindingEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSessionEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSessionListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionTimeoutListener</span> <span class="keyword">implements</span> <span class="title">HttpSessionListener</span>, <span class="title">HttpSessionAttributeListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCreated</span><span class="params">(HttpSessionEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//Session创建是触发事件</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionDestroyed</span><span class="params">(HttpSessionEvent event)</span> </span>&#123;</span><br><span class="line">		HttpSession session = event.getSession();</span><br><span class="line">		Object user = session.getAttribute(SessionConstant.USER_VO);</span><br><span class="line">		Object userName = session.getAttribute(SessionConstant.USER_NAME);</span><br><span class="line">		Object userCode = session.getAttribute(SessionConstant.USER_CODE);</span><br><span class="line">		</span><br><span class="line">		System.out.println( <span class="string">"User:"</span> + user + <span class="string">"  Name:"</span> + userName + <span class="string">"  Code:"</span> + userCode);</span><br><span class="line">		ServletContext context = session.getServletContext();</span><br><span class="line">		String user_uuid = (String)session.getAttribute(SessionConstant.USER_UUID);</span><br><span class="line">		context.removeAttribute(user_uuid);</span><br><span class="line">		</span><br><span class="line">		System.out.print(<span class="string">"Session登录信息超时销毁......"</span>);</span><br><span class="line">		System.out.print(<span class="string">"这里切入日志记录逻辑，进行日志信息的处理......"</span>);</span><br><span class="line">		System.out.print(<span class="string">"这里也可以进行数据持久操作......"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeAdded</span><span class="params">(HttpSessionBindingEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//Session增加属性时触发事件</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeRemoved</span><span class="params">(HttpSessionBindingEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//Session移除属性时触发事件</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attributeReplaced</span><span class="params">(HttpSessionBindingEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//Session替换属性值时触发事件</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2· 注册监听器如下代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">display-name</span>&gt;</span>FlexEngagementRing<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 省略其他代码 --&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.maxsoft.session.listener.SessionTimeoutListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>5<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3· 校验是否已登录，如果已登录，则进行柔性提示并执行相关的操作。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.login;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckController</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span><span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.doGet(request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		String jsonStr = <span class="keyword">null</span>;</span><br><span class="line">		response.setContentType(<span class="string">"application/json;charset=utf-8"</span>);<span class="comment">//指定返回的格式为JSON格式  </span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			request.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//这里可以通过用户名和密码进行查询用户，然后通过用户的UUID来进行校验。</span></span><br><span class="line">		String uuid = <span class="string">"MaxSoft_000000000000000000001"</span>;</span><br><span class="line">		<span class="comment">//这里获取内容的前提是必须要在登录成功注册 Session 后，</span></span><br><span class="line">		<span class="comment">//进行对相应的信息执行属性（req.getSession().getServletContext().setAttribute(uuid, "MaxSoft");）</span></span><br><span class="line">		String msg = (String)request.getSession().getServletContext().getAttribute(uuid);</span><br><span class="line">		<span class="keyword">if</span>(msg != <span class="keyword">null</span> &amp;&amp; msg.length() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">			jsonStr =<span class="string">"&#123;\"state\":\"true\",\"msg\":\"当前用户已登录，是否踢出？\"&#125;"</span>;  </span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			jsonStr =<span class="string">"&#123;\"state\":\"false\",\"msg\":\"\"&#125;"</span>;  </span><br><span class="line">		&#125;</span><br><span class="line">		PrintWriter out =<span class="keyword">null</span> ;  </span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			out =response.getWriter() ;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;  </span><br><span class="line">		out.write(jsonStr);  </span><br><span class="line">		out.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过 Ajax 技术在登录验证通过后调用该请求，然后执行是否已经在线的验证逻辑，如果已经在线则进行柔性提示，否则直接进行 Session 注册并进入系统。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/06/JavaWeb%E9%A1%B9%E7%9B%AE%E7%AE%80%E5%8D%95%E7%9A%84%E7%88%AC%E8%99%AB%E6%A1%88%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/06/JavaWeb%E9%A1%B9%E7%9B%AE%E7%AE%80%E5%8D%95%E7%9A%84%E7%88%AC%E8%99%AB%E6%A1%88%E4%BE%8B/" class="post-title-link" itemprop="url">JavaWeb项目简单的爬虫案例</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-06 20:21:12" itemprop="dateCreated datePublished" datetime="2014-03-06T20:21:12+08:00">2014-03-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;今天继续总结关于我本次的毕设中的一个独立功能模块的设计实现过程。该功能主要使用爬虫来获取目标网站的有效数据供所属站点使用，逻辑相对比较简单。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分析目标网站的数据结构或者页面的层级结构，来制定对应的数据获取逻辑。本次毕设主要是通过 Google Chrome 浏览器中的「开发者模式」来分析目标网站的页面层级结构以及数据结构，从而来确定获取数据的逻辑结构。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次案例获取的数据是金拓网站关于黄金，铂金，巴金，白银的相关实时市价。供毕设中的实时交易价格功能的数据来源。</p>
<ol>
<li>通过浏览器的开发者模式进行页面结构以及数据结构的分析（主要分析数据区域的HTML代码层级以及通过url请求的数据结构）；</li>
<li>通过分析结果来制定获取数据的逻辑结构（KitcoGoldInfoProxyService.java），代码逻辑如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.maxsoft.constant.Constant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KitcoGoldInfoProxyService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String result_info;	<span class="comment">//结果信息</span></span><br><span class="line">	<span class="keyword">private</span> String[] div_id;	<span class="comment">//参数信息</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDiv_id</span><span class="params">(String[] div_id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.div_id = div_id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">crawl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; div_id.length; i++) &#123;</span><br><span class="line">				StringBuffer is = <span class="keyword">new</span> StringBuffer(Constant.ReceptionConfigurationConstant.KITCO_PRE_URL).append(div_id[i]);</span><br><span class="line">				URL myUrl = <span class="keyword">new</span> URL(is.toString());</span><br><span class="line">				is = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">				BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(myUrl.openStream()));</span><br><span class="line">				<span class="keyword">while</span> ((result_info = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">					is.append(result_info);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (is.indexOf(<span class="string">"height=\"24\""</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">					result_info = is.toString().replaceFirst(<span class="string">"height=\"24\""</span>,<span class="string">""</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (is.indexOf(<span class="string">"images/"</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">					result_info = result_info.replaceAll(<span class="string">"images/"</span>,<span class="string">"http://www.kitco.cn/images/"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				list.add(result_info);</span><br><span class="line">			&#125;</span><br><span class="line">			URL url = <span class="keyword">new</span> URL(<span class="string">"http://www.kitco.cn/KitcoDynamicSite/RequestHandler?requestName=getFileContent&amp;AttributeId=ShangHaiPrices"</span>);</span><br><span class="line">			StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">			BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(url.openStream()));</span><br><span class="line">			<span class="keyword">while</span> ((result_info = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">				buffer.append(result_info);</span><br><span class="line">			&#125;</span><br><span class="line">			list.add(buffer.toString().replace(<span class="string">" width=\"568\""</span>, <span class="string">""</span>).replace(<span class="string">"&lt;table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"&gt;"</span>,<span class="string">"&lt;table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\"&gt;&lt;tr&gt;&lt;td class=\"fcolor_gray\" colspan=\"9\" align=\"center\" style=\"background-color:#e3effb; \"&gt;上海黄金交易所行情&lt;/td&gt;&lt;/tr&gt;"</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>编写 Servlet 代码供前端通过 Ajax 来请求数据（KitcoGoldInfoProxyServlet.java, InternationaleGoldPrice.java），代码如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KitcoGoldInfoProxyServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">	<span class="keyword">private</span> KitcoGoldInfoProxyService service = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		service = <span class="keyword">new</span> KitcoGoldInfoProxyService();</span><br><span class="line">		service.setDiv_id(<span class="keyword">new</span> String[]&#123;<span class="string">"PreciousMetalsSpotPricesCNY"</span>, <span class="string">"PreciousMetalsSpotPrices"</span>&#125;);</span><br><span class="line">		List&lt;String&gt; list = service.crawl();</span><br><span class="line">		Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">		String json = gson.toJson(list);</span><br><span class="line">		response.setHeader(<span class="string">"content-type"</span>, <span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line">		response.getWriter().print(json);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InternationaleGoldPrice</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">		req.getRequestDispatcher(<span class="string">"internationalegoldprice.jsp"</span>).forward(req, resp);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>配置相关 Servlet 的映射关系 web.xml，如下：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>KitcoGoldInfoProxyServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.maxsoft.proxy.KitcoGoldInfoProxyServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>InternationaleGoldPrice<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.maxsoft.proxy.InternationaleGoldPrice<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 省略其他代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>KitcoGoldInfoProxyServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/kitcogoldinfo<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>InternationaleGoldPrice<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/internationalegoldprice<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>编写 Ajax 代码逻辑来获取服务端数据，代码逻辑如下（com.maxsoft.base.js, com.maxsoft.proxy.js）：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@function </span>基础组件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">MaxSoft</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2014-0-04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version </span>0.0.1 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> MaxSoftAjax = &#123;</span><br><span class="line">	_xhr : <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> xhr;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123;<span class="comment">//兼容非IE低版本浏览器</span></span><br><span class="line">			xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;<span class="comment">//兼容IE低版本浏览器</span></span><br><span class="line">			xhr = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">//事件监听请求执行到哪一步</span></span><br><span class="line">			<span class="keyword">if</span> (xhr.readyState === <span class="number">4</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (xhr.status === <span class="number">200</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">typeof</span> (fn) == <span class="string">'function'</span>) &#123;</span><br><span class="line">						fn(xhr.responseText);</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						alert(<span class="string">"参数无效，请检查！"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="built_in">console</span>.log(<span class="string">"请求异常，"</span> + xhr.status);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (e) &#123; &#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">return</span> xhr;</span><br><span class="line">	&#125;,</span><br><span class="line">	AjaxGet:<span class="function"><span class="keyword">function</span>(<span class="params">url,fn</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> xhr = <span class="keyword">this</span>._xhr(fn);</span><br><span class="line">		xhr.open(<span class="string">"get"</span>, url, <span class="literal">true</span>);</span><br><span class="line">		xhr.send(<span class="literal">null</span>);</span><br><span class="line">	&#125;,</span><br><span class="line">	AjaxPost:<span class="function"><span class="keyword">function</span>(<span class="params">url,params,fn</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> xhr = <span class="keyword">this</span>._xhr(fn);</span><br><span class="line">		xhr.open(<span class="string">"post"</span>, url, <span class="literal">true</span>);</span><br><span class="line">		xhr.send(params);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@function </span>代理信息处理组件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">MaxSoft</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date </span>2014-03-04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version </span>0.0.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> MaxSoftPlugins = &#123;</span><br><span class="line">	KitcoProxyInfo : <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> json = <span class="built_in">JSON</span>.parse(res);</span><br><span class="line">			<span class="built_in">document</span>.getElementById(<span class="string">"DIV__PRECIOUS_SPOT_PRICES_CNY"</span>).innerHTML = <span class="string">'&lt;div align="center" class="tabtitle" style="height:24px;line-height:24px;"&gt;以人民币/克计价&lt;/div&gt;'</span></span><br><span class="line">					+ json[<span class="number">0</span>];</span><br><span class="line">			<span class="built_in">document</span>.getElementById(<span class="string">"DIV__PRECIOUS_SPOT_PRICES"</span>).innerHTML = <span class="string">'&lt;div align="center" class="tabtitle" style="height:24px;line-height:24px;"&gt;以美元/盎司计价&lt;/div&gt;'</span></span><br><span class="line">					+ json[<span class="number">1</span>];</span><br><span class="line">			json[<span class="number">2</span>] = json[<span class="number">2</span>].replace(<span class="string">"width=\"550\""</span>, <span class="string">"width=\"795\""</span>)</span><br><span class="line">					.replace(<span class="string">"#e3effb;"</span>, <span class="string">"#dab66a; height='30' "</span>);</span><br><span class="line">			<span class="built_in">document</span>.getElementById(<span class="string">"DIV__SHANGHAI_PRICES"</span>).innerHTML = json[<span class="number">2</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		MaxSoftAjax.AjaxGet(url, fn);</span><br><span class="line">	&#125;,</span><br><span class="line">	CapitalCheckProxy : <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">		MaxSoftAjax.AjaxGet(url, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">			<span class="comment">//TODO</span></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>编写前端页面代码，如下：<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">language</span>=<span class="string">"java"</span> <span class="attr">contentType</span>=<span class="string">"text/html; charset=utf-8"</span> <span class="attr">pageEncoding</span>=<span class="string">"utf-8"</span>%&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="meta-string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=ISO-8859-1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>国际金价行情<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">media</span>=<span class="string">"all"</span> <span class="attr">href</span>=<span class="string">"assets/css/proxy.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"assets/js/com.maxsoft.base.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"assets/js/com.maxsoft.proxy.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"margin: 0px 0px 0px 0px;"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width: 809px; height: 1150px; margin-left: 13px;"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- Kitco Proxy Info --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">style</span>=<span class="string">"border: 0px; width: 100%;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">colspan</span>=<span class="string">"2"</span> <span class="attr">height</span>=<span class="string">"30px"</span> <span class="attr">style</span>=<span class="string">"font-size: 16px; color: #926129; letter-spacing: 4px; font-weight: bold;"</span>&gt;</span>国际贵金属实时交易行情<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"100%"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"DIV__SHANGHAI_PRICES"</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"100%"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"DIV__PRECIOUS_SPOT_PRICES_CNY"</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"100%"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"DIV__PRECIOUS_SPOT_PRICES"</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">		MaxSoftPlugins.KitcoProxyInfo(<span class="string">"kitcogoldinfo"</span>);</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
以上代码运行效果如下图所示：<img src='/uploads/proxy_01.png' />通过上述示例我们发现只要分析出数据展现的规律或者某一个URL的数据结构就可以通过这种方式可以非常便捷的来获取大量我们需要的数据（微博相关数据，QQ空间数据等）。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/01/%E5%8E%9F%E7%94%9FAjax%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/01/%E5%8E%9F%E7%94%9FAjax%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">原生Ajax请求数据过程总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-01 21:11:12" itemprop="dateCreated datePublished" datetime="2014-03-01T21:11:12+08:00">2014-03-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ajax 是 Asynchronous Javascript And XML 的缩写，即异步的 JavaScript 和 XML，是一种创建交互式网页应用的网页开发技术。通过在后台与服务器进行少量数据交换，Ajax 可以使网页实现异步更新，增加用户的体验度。</p>
<h2 id="使用过程"><a href="#使用过程" class="headerlink" title="使用过程"></a>使用过程</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本次使用示例是通过Google Chrome浏览器为基础进行。<br/>1. 首先我们来创建可扩展超文本传输请求对象即（ XMLHttpRequest ），如下示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123;<span class="comment">//兼容非IE低版本浏览器</span></span><br><span class="line">  xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;<span class="comment">//兼容IE低版本浏览器</span></span><br><span class="line">  xhr = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于不同浏览器的内核的 XMLHttpRequest 对象创建方式不同（IE低版本，IE高版本，Google Chrome ，火狐浏览器等），所以我们要满足不同浏览器的 Ajax 请求平稳运行，就要区分不同浏览器进行兼容处理；<br><font>2. 其次设置请求请求响应回调事件，如下示例：</font></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">xhr.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  <span class="comment">//事件监听请求执行到哪一步</span></span><br><span class="line">   <span class="keyword">if</span>(xhr.readyState === <span class="number">4</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(xhr.status === <span class="number">200</span>)&#123;</span><br><span class="line">         <span class="keyword">var</span> header = xhr.getAllResponseHeaders();  <span class="comment">//获得所有响应头</span></span><br><span class="line">	 <span class="built_in">console</span>.log(<span class="string">"请求成功!"</span> + xhr.responseText);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         <span class="built_in">console</span>.log(<span class="string">"请求异常，"</span> + xhr.status);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 xhr.readyState 的值有如下含义：</p>
<ol>
<li><font color=red>&nbsp;&nbsp;0&nbsp;(未初始化)</font>：(XMLHttpRequest)对象已经创建，但还没有调用open()方法；</li>
<li><font color=red>&nbsp;&nbsp;1&nbsp;(载入)</font>：已经调用open() 方法，但尚未发送请求；</li>
<li><font color=red>&nbsp;&nbsp;2&nbsp;(载入完成)</font>：请求已经发送完成；</li>
<li><font color=red>&nbsp;&nbsp;3&nbsp;(交互)</font>：可以接收到部分响应数据；</li>
<li><font color=red>&nbsp;&nbsp;4&nbsp;(完成)</font>：已经接收到了全部数据，并且连接已经关闭；</li>
</ol>
<p>xhr.status 主要用来辅助判断服务器的响应状态，有如下几类，：</p>
<ol>
<li><font color=red>&nbsp;&nbsp;1xx&nbsp;(信息类)</font>：表示收到Web浏览器请求，正在进一步的处理中。如，100：客户必须继续发出请求；101：客户要求服务器根据请求转换HTTP协议版本；</li>
<li><font color=red>&nbsp;&nbsp;2xx&nbsp;(成功)</font>：表示用户请求被正确接收，理解和处理。例如，200：OK；201：提示知道新文件的URL；</li>
<li><font color=red>&nbsp;&nbsp;3xx&nbsp;(重定向)</font>：表示请求没有成功，客户必须采取进一步的动作。如，300：请求的资源可在多处得到；301：删除请求数据；</li>
<li><font color=red>&nbsp;&nbsp;4xx&nbsp;(客户端错误)</font>：表示客户端提交的请求有错误。如，404：NOT Found，意味着请求中所引用的文档不存在；</li>
<li><font color=red>&nbsp;&nbsp;5xx&nbsp;(服务器错误)</font>：表示服务器不能完成对请求的处理。如，500，服务器产生内部错误；</li>
</ol>
<p><font>3. 最后设置相关请求参数并发送请求，如下示例：</font></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(<span class="string">"post"</span>,<span class="string">"/maxsoft/user/add"</span>,<span class="literal">true</span>); <span class="comment">//设置请求方法（[方法名][post/get], [请求地址], [异步标识][true/false]）</span></span><br><span class="line">xhr.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"text/html; charset=utf-8"</span>); <span class="comment">//设置请头相关的参数</span></span><br><span class="line">xhr.send(&#123;<span class="attr">name</span>:<span class="string">'MaxSoft'</span>,<span class="attr">sex</span>:<span class="string">'1'</span>,<span class="attr">id</span>:<span class="string">'10000000001'</span>&#125;); <span class="comment">//设置请求参数</span></span><br></pre></td></tr></table></figure>
<p>在这一步中主要是发送请求以及请求参数等，其中 xhr.open() 方法参数依次为：请求方法（POST/GET），以及请求地址，是否异步（true/false）；xhr.send() 方法为发送请求的过程中的请求参数，主要用于 POST 方法，如果没有参数则为 null;</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过以上三步操作即可完成一次 Ajax 请求操作，我们可以在第二部中增加 Ajax 请求成功（xhr.readyState === 4 并且 xhr.status === 200 ）后的相关执行逻辑；在我当前的毕设中主要用在前端页面无感知刷新以及门店数据分布位置的请求；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/02/27/JavaWeb%E9%A1%B9%E7%9B%AE%E5%B5%8C%E5%85%A5%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E5%8A%9F%E8%83%BD%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/02/27/JavaWeb%E9%A1%B9%E7%9B%AE%E5%B5%8C%E5%85%A5%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E5%8A%9F%E8%83%BD%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">JavaWeb项目嵌入百度地图功能流程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-02-27 19:51:12" itemprop="dateCreated datePublished" datetime="2014-02-27T19:51:12+08:00">2014-02-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最近俩天终于梳理清楚了毕设中的单独功能模块，首先就是关于企业加盟店的地图动态显示功能模块。由于服务端的功能相对比较简单只是单纯的录入分店地址后，将其转换为对应的GPS坐标返回给前端即可，所以这里不做过多的记录。今天主要记录在前端页面中嵌入百度地图并根据服务端提供的数据来动态的标记在地图中以便用户可以清晰的看到企业的各加盟分店分布情况。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>开始该功能之前主要准备的工作如下：</p>
<ol>
<li><p>申请百度开发者账号；</p>
</li>
<li><p>通过申请到的百度开发者账号在控制台建立一个提供Web服务的应用实例；</p>
</li>
<li><p>获取Web应用实例中提供的访问应用秘钥AK；</p>
</li>
</ol>
<p>以上操作的地址【<a href="https://passport.baidu.com/v2/?login&u=http%3A%2F%2Flbsyun.baidu.com%2Fapiconsole%2Fkey" target="_blank" rel="noopener">百度开发者</a>】，这里就不再演示了。</p>
<h2 id="嵌入流程"><a href="#嵌入流程" class="headerlink" title="嵌入流程"></a>嵌入流程</h2><ol>
<li>首先通过申请的百度开发者账号来获取访问应用AK，并嵌入到页面中，如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 省略其他代码 --&gt;</span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"http://api.map.baidu.com/api?v=2.0&amp;ak=xxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></li>
<li>参考百度地图API进行地图嵌入代码的编写( MaxSoftPlugins.js )，以下为粗略的封装代码：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">$MaxSoftMapPlugin</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> _map_div = <span class="built_in">document</span>.getElementById(id);</span><br><span class="line">	<span class="keyword">if</span>(_map_div == <span class="literal">null</span> || <span class="keyword">typeof</span>(_map_div)==<span class="string">'undefined'</span>)&#123;</span><br><span class="line">		alert(<span class="string">"请输入有效的ID值"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &#123;</span><br><span class="line">		BaiduMap : <span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">var</span> _args = <span class="built_in">arguments</span>;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">typeof</span>(options)==<span class="string">'object'</span>)&#123;</span><br><span class="line">				<span class="comment">/***********************************************************************************************/</span></span><br><span class="line">				<span class="keyword">var</span> _data = options.data;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//通过指定容器的ID创建百度地图</span></span><br><span class="line">				<span class="keyword">var</span> _map = <span class="keyword">new</span> BMap.Map(id);</span><br><span class="line">				<span class="comment">//定义一个中心点坐标</span></span><br><span class="line">				<span class="keyword">var</span> _point = <span class="keyword">new</span> BMap.Point(<span class="number">116.609973</span> , <span class="number">39.930236</span>); </span><br><span class="line">				<span class="comment">//设定地图的中心点和坐标并将地图显示在地图容器中</span></span><br><span class="line">				_map.centerAndZoom(_point, <span class="number">14</span>);</span><br><span class="line">				<span class="comment">//window.map = _map; //将map变量存储在全局</span></span><br><span class="line">				<span class="comment">//启用地图拖拽事件，默认启用(可不写)</span></span><br><span class="line">				_map.enableDragging(); </span><br><span class="line">				<span class="comment">//启用地图滚轮放大缩小</span></span><br><span class="line">				_map.enableScrollWheelZoom();</span><br><span class="line">				<span class="comment">//启用鼠标双击放大，默认启用(可不写)</span></span><br><span class="line">				_map.enableDoubleClickZoom(); </span><br><span class="line">				<span class="comment">//启用键盘上下左右键移动地图</span></span><br><span class="line">				_map.enableKeyboard(); </span><br><span class="line">				<span class="built_in">window</span>.mapobj = _map;</span><br><span class="line">				<span class="comment">//向地图中添加缩放控件</span></span><br><span class="line">				<span class="keyword">var</span> _ctrl_nav = <span class="keyword">new</span> BMap.NavigationControl(&#123; <span class="attr">anchor</span>: BMAP_ANCHOR_TOP_LEFT, <span class="attr">type</span>: BMAP_NAVIGATION_CONTROL_LARGE &#125;);</span><br><span class="line">				_map.addControl(_ctrl_nav);</span><br><span class="line">				<span class="comment">//向地图中添加缩略图控件</span></span><br><span class="line">				<span class="keyword">var</span> _ctrl_ove = <span class="keyword">new</span> BMap.OverviewMapControl(&#123; <span class="attr">anchor</span>: BMAP_ANCHOR_BOTTOM_RIGHT, <span class="attr">isOpen</span>: <span class="number">1</span> &#125;);</span><br><span class="line">				_map.addControl(_ctrl_ove);</span><br><span class="line">				<span class="comment">//向地图中添加比例尺控件</span></span><br><span class="line">				<span class="keyword">var</span> _ctrl_sca = <span class="keyword">new</span> BMap.ScaleControl(&#123; <span class="attr">anchor</span>: BMAP_ANCHOR_BOTTOM_LEFT&#125;);</span><br><span class="line">				_map.addControl(_ctrl_sca);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">var</span> _markerData = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;_data.length;i++)&#123;</span><br><span class="line">					_markerData[i]=&#123; </span><br><span class="line">						title:<span class="string">'&lt;table cellspacing=0 cellpadding=0 border=0 height=20 width=450px style="font-size:14px; color:#b48d40;font-weight:bold;"&gt;&lt;tr&gt;&lt;td width=20px align=left valign=middle&gt;&lt;img src="http://api.map.baidu.com/lbsapi/getpoint/Images/logo.gif" height=20px width=20px/&gt;&lt;/td&gt;&lt;td align=left valign=middle &gt;&amp;nbsp;'</span>+_data[i].FName+<span class="string">'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;'</span>, </span><br><span class="line">						content: <span class="string">"&lt;b style='font-size:12px; color:#b48d40;'&gt;电话："</span>+_data[i].FConnPhone+<span class="string">"&lt;br/&gt;地址："</span>+_data[i].FAddress, </span><br><span class="line">						point:_data[i].FIntroduce, </span><br><span class="line">						isOpen: <span class="number">0</span>, </span><br><span class="line">						icon: &#123; <span class="attr">w</span>: <span class="number">20</span>, <span class="attr">h</span>: <span class="number">24</span>, <span class="attr">l</span>: <span class="number">46</span>, <span class="attr">t</span>: <span class="number">22</span>, <span class="attr">x</span>: <span class="number">6</span>, <span class="attr">lb</span>: <span class="number">10</span>&#125; </span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _markerData.length; i++) &#123;</span><br><span class="line">					<span class="keyword">var</span> _marker_data = _markerData[i];</span><br><span class="line">					<span class="keyword">var</span> _p0 = _marker_data.point.split(<span class="string">"|"</span>)[<span class="number">0</span>];</span><br><span class="line">					<span class="keyword">var</span> _p1 = _marker_data.point.split(<span class="string">"|"</span>)[<span class="number">1</span>];</span><br><span class="line">					<span class="keyword">var</span> _point = <span class="keyword">new</span> BMap.Point(_p0, _p1);</span><br><span class="line">					<span class="keyword">var</span> _iconImg = createIcon(_marker_data.icon);</span><br><span class="line">					<span class="keyword">var</span> _marker = <span class="keyword">new</span> BMap.Marker(_point, &#123; <span class="attr">icon</span>: _iconImg &#125;);</span><br><span class="line">					<span class="keyword">var</span> _label = <span class="keyword">new</span> BMap.Label(_marker_data.title, &#123; <span class="string">"offset"</span>: <span class="keyword">new</span> BMap.Size(_marker_data.icon.lb - _marker_data.icon.x + <span class="number">10</span>, <span class="number">-20</span>) &#125;);</span><br><span class="line">					_label.setStyle(&#123;<span class="attr">border</span>:<span class="string">"#eabc3c solid 1px"</span>&#125;);</span><br><span class="line">					_marker.setLabel(_label);</span><br><span class="line">					_map.addOverlay(_marker);</span><br><span class="line">					_label.setStyle(&#123;</span><br><span class="line">						borderColor: <span class="string">"#eabc3c"</span>,</span><br><span class="line">						color: <span class="string">"#333"</span>,</span><br><span class="line">						cursor: <span class="string">"pointer"</span></span><br><span class="line">					&#125;);</span><br><span class="line">					(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">						<span class="keyword">var</span> _iw = createInfoWindow(i);</span><br><span class="line">						<span class="keyword">var</span> _marker_obj = _marker;</span><br><span class="line">						_marker_obj.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">						<span class="keyword">this</span>.openInfoWindow(_iw);</span><br><span class="line">						&#125;);</span><br><span class="line">						_iw.addEventListener(<span class="string">"open"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">						_marker_obj.getLabel().hide();</span><br><span class="line">						&#125;)</span><br><span class="line">						_iw.addEventListener(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">						_marker_obj.getLabel().show();</span><br><span class="line">						&#125;)</span><br><span class="line">						_label.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">						_marker_obj.openInfoWindow(_iw);</span><br><span class="line">						&#125;)</span><br><span class="line">						<span class="keyword">if</span> (!!_marker_data.isOpen) &#123;</span><br><span class="line">						_label.hide();</span><br><span class="line">						_marker_obj.openInfoWindow(_iw);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;)()</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//创建InfoWindow</span></span><br><span class="line">				<span class="function"><span class="keyword">function</span> <span class="title">createInfoWindow</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> md = _markerData[i];</span><br><span class="line">				<span class="keyword">var</span> iw = <span class="keyword">new</span> BMap.InfoWindow(<span class="string">"&lt;b class='iw_poi_title' title='"</span> + md.title + <span class="string">"'&gt;"</span> + md.title + <span class="string">"&lt;/b&gt;&lt;div class='iw_poi_content'&gt;"</span> + md.content + <span class="string">"&lt;/div&gt;"</span>);</span><br><span class="line">				<span class="keyword">return</span> iw;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//创建一个Icon</span></span><br><span class="line">				<span class="function"><span class="keyword">function</span> <span class="title">createIcon</span>(<span class="params">md</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> icon = <span class="keyword">new</span> BMap.Icon(<span class="string">"http://app.baidu.com/map/images/us_mk_icon.png"</span>, <span class="keyword">new</span> BMap.Size(md.w, md.h), &#123; <span class="attr">imageOffset</span>: <span class="keyword">new</span> BMap.Size(-md.l, -md.t), <span class="attr">infoWindowOffset</span>: <span class="keyword">new</span> BMap.Size(md.lb + <span class="number">5</span>, <span class="number">1</span>), <span class="attr">offset</span>: <span class="keyword">new</span> BMap.Size(md.x, md.h) &#125;)</span><br><span class="line">				<span class="keyword">return</span> icon;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(<span class="keyword">typeof</span>(options.callback)==<span class="string">'function'</span>)&#123;</span><br><span class="line">					options.callback();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span>(options)==<span class="string">'string'</span>)&#123;</span><br><span class="line">				<span class="keyword">var</span> method = &#123;</span><br><span class="line">					test : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">						<span class="built_in">console</span>.log(<span class="string">"This is test method."</span>);</span><br><span class="line">					&#125;,</span><br><span class="line">					addMarker:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">						<span class="keyword">var</span> point = <span class="keyword">new</span> BMap.Point(_args[<span class="number">1</span>].x,_args[<span class="number">1</span>].y);</span><br><span class="line">						<span class="comment">// 创建点坐标</span></span><br><span class="line">						mapobj.centerAndZoom(point,_args[<span class="number">1</span>].grade);</span><br><span class="line">						<span class="comment">// 初始化地图， 设置中心点坐标和地图级别</span></span><br><span class="line">						<span class="keyword">var</span> marker = <span class="keyword">new</span> BMap.Marker(point);</span><br><span class="line">						marker.title=<span class="string">'&lt;table cellspacing=0 cellpadding=0 border=0 height=20 width=250px style="font-size:14px; color:#b48d40;font-weight:bold;"&gt;&lt;tr&gt;&lt;td width=20px align=left valign=middle&gt;&lt;img src="'</span>+_args[<span class="number">1</span>].icon+<span class="string">'" height=20px width=20px/&gt;&lt;/td&gt;&lt;td align=left valign=middle &gt;&amp;nbsp;'</span>+_args[<span class="number">1</span>].name+<span class="string">'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;'</span>;</span><br><span class="line">						marker.content= <span class="string">"&lt;b style='font-size:12px; color:#b48d40;'&gt;电话："</span>+_args[<span class="number">1</span>].phone+<span class="string">"&lt;br/&gt;地址："</span>+_args[<span class="number">1</span>].address; </span><br><span class="line">						marker.isOpen=<span class="number">0</span>;</span><br><span class="line">						marker.icon= &#123; <span class="attr">w</span>: <span class="number">20</span>, <span class="attr">h</span>: <span class="number">24</span>, <span class="attr">l</span>: <span class="number">46</span>, <span class="attr">t</span>: <span class="number">22</span>, <span class="attr">x</span>: <span class="number">6</span>, <span class="attr">lb</span>: <span class="number">10</span>&#125; ;</span><br><span class="line">						mapobj.addOverlay(marker);</span><br><span class="line">						<span class="keyword">var</span> label = <span class="keyword">new</span> BMap.Label(marker.title, &#123; <span class="string">"offset"</span>: <span class="keyword">new</span> BMap.Size(marker.icon.lb - marker.icon.x + <span class="number">10</span>, <span class="number">-20</span>) &#125;);</span><br><span class="line">						label.setStyle(&#123;<span class="attr">border</span>:<span class="string">"#eabc3c solid 1px"</span>,<span class="attr">background</span>:<span class="string">"#cecece"</span>&#125;);</span><br><span class="line">						marker.setLabel(label);</span><br><span class="line">						label.setStyle(&#123;</span><br><span class="line">							borderColor: <span class="string">"#eabc3c"</span>,</span><br><span class="line">							color: <span class="string">"#333"</span>,</span><br><span class="line">							cursor: <span class="string">"pointer"</span></span><br><span class="line">						&#125;);</span><br><span class="line">						label.hide();</span><br><span class="line">						<span class="keyword">var</span> iw = <span class="keyword">new</span> BMap.InfoWindow(<span class="string">"&lt;b class='iw_poi_title' title='"</span>+marker.title+<span class="string">"'&gt;"</span>+marker.title+<span class="string">"&lt;/b&gt;&lt;div class='iw_poi_content'&gt;"</span>+marker.content+<span class="string">"&lt;/div&gt;"</span>);</span><br><span class="line">						marker.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">							 <span class="keyword">this</span>.openInfoWindow(iw);</span><br><span class="line">						&#125;);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> method[options]();</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="comment">//TODO</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>页面调用代码以及效果图如下：<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">   	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"window-target"</span> <span class="attr">content</span>=<span class="string">"_top"</span>&gt;</span></span><br><span class="line">   	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"pragma"</span> <span class="attr">content</span>=<span class="string">"no-cache"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"cache-control"</span> <span class="attr">content</span>=<span class="string">"no-cache"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"date"</span> <span class="attr">content</span>=<span class="string">"2014-02-26"</span> /&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"/logo.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"/logo.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://api.map.baidu.com/api?v=2.0&amp;ak=uFr65XlDBuvhvGYxw3UddQ7N"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"MaxSoftPlugins.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"margin: 0px 0px 0px 0px;"</span> <span class="attr">align</span>=<span class="string">'center'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"map_content_div"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:600px;height:400px;border:#eabc3c solid 1px;"</span> <span class="attr">id</span>=<span class="string">"map_content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">	<span class="keyword">var</span> data = [&#123;FConnPhone : <span class="string">"13602058888"</span>, FName : <span class="string">"MaxSoft Telecom Network Technology Co., Ltd"</span>, FAddress : <span class="string">"北京市朝阳区 XXXX  "</span>, FIntroduce : <span class="string">"116.609973|39.930236"</span> &#125;];</span></span><br><span class="line"><span class="actionscript">	$MaxSoftMapPlugin(<span class="string">"map_content"</span>).BaiduMap(&#123;data:data,callback:<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript">		<span class="built_in">console</span>.log(<span class="string">'Hello MaxSoft, 我要居中处理'</span>);</span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> left  = (<span class="built_in">window</span>.screen.availWidth - <span class="built_in">parseInt</span>(<span class="built_in">document</span>.getElementById(<span class="string">"map_content"</span>).style.width) ) / <span class="number">2</span>;</span></span><br><span class="line"><span class="javascript">		<span class="built_in">document</span>.getElementById(<span class="string">"map_content_div"</span>).style[<span class="string">'padding-left'</span>] = left;</span></span><br><span class="line">	&#125;&#125;);</span><br><span class="line"><span class="actionscript">	$MaxSoftMapPlugin(<span class="string">"map_content"</span>).BaiduMap(<span class="string">'addMarker'</span>,&#123;grade:<span class="number">9</span>, </span></span><br><span class="line">		x:116.404, </span><br><span class="line">		y:39.915, </span><br><span class="line"><span class="actionscript">		name:<span class="string">"XXXXX西单分店"</span>,</span></span><br><span class="line"><span class="actionscript">		phone:<span class="string">'13602058888'</span>, </span></span><br><span class="line"><span class="actionscript">		address:<span class="string">"北京市西城区西单大悦城XXXX号"</span>, </span></span><br><span class="line"><span class="actionscript">		icon:<span class="string">'http://img.zcool.cn/community/018ac455ba317d32f87528a1dbc0e5.jpg'</span>&#125;);</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<img src="/uploads/map_0001.png" /><img src="/uploads/map_0002.png" /><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以上就是本次关于分店展示的功能模块的锥形，后面会进行详细的需求整理并设计。关于动态数据准备使用原生的 Ajax 来进行服务端数据的异步加载以满足我们在后台对分店的动态信息的可可编辑需求。</li>
</ol>
<p>参考信息 : <a href="http://lbsyun.baidu.com/index.php?title=jspopular" target="_blank" rel="noopener">百度地图API</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/11/23/J2EE%E4%B9%8BJSP%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2013/11/23/J2EE%E4%B9%8BJSP%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">J2EE之JSP技术学习总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2013-11-23 22:20:30" itemprop="dateCreated datePublished" datetime="2013-11-23T22:20:30+08:00">2013-11-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaWeb/" itemprop="url" rel="index">
                    <span itemprop="name">JavaWeb</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;学习JSP技术也有小一个学期的时间了，借今天是周末的时间来简单的做一个总结。也为下一个月底开始的期末考试做个准备，免去挂科补考之苦 &gt;V&lt;……</p>
<h2 id="JSP概念"><a href="#JSP概念" class="headerlink" title="JSP概念"></a>JSP概念</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JSP的全名是Java Server Pages，翻译为中文名就是Java服务器页面。JSP的本质是一个简化的Servlet，它是由Sun公司提倡并参与组建的一种动态网站页面技术。JSP是由HTML标记语言，Java程序代码，JSP标签而组成的扩展名为.jsp的文本文件。使用JSP开发的网站应用可以在任何装有JRE运行环境和JavaWeb容器的操作系统上运行，即跨平台性比较好。</p>
<h2 id="JSP语法"><a href="#JSP语法" class="headerlink" title="JSP语法"></a>JSP语法</h2><p>JSP的语法有如下几类：</p>
<pre><code>1&gt; &lt;%@    ...    %&gt;  定义JSP指令

2&gt; &lt;%!    ...    %&gt;  定义Java代码段的全局成员变量

3&gt; &lt;%     ...    %&gt;  定义Java成员变量,编写Java处理逻辑

4&gt; &lt;%=    ...    %&gt;  输出内容到页面

5&gt; &lt;xxx:xxx xx=&quot;&quot; ... &gt; ... &lt;/xxx:xxx&gt; 系统JSP标签 第三方标签 以及 自定义标签 </code></pre><p>JSP页面示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span> pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.util.Date"</span>%&gt;</span><br><span class="line">&lt;%-- &lt;%<span class="meta">@include</span> file=<span class="string">"personal.jsp"</span> %&gt; --%&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">"spring"</span> uri=<span class="string">"http://www.springframework.org/tags"</span>%&gt;</span><br><span class="line">&lt;%-- &lt;%<span class="meta">@taglib</span> prefix=<span class="string">"custome"</span> tagdir=<span class="string">"自定义标签路径"</span>%&gt; --%&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">&lt;title&gt;Insert title here&lt;/title&gt;</span><br><span class="line">&lt;%! String flag = <span class="string">"MaxSoft"</span>; %&gt;</span><br><span class="line">&lt;%! <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DateUtils</span></span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">getNowDate</span><span class="params">()</span></span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Date();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">%&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;jsp:include page=<span class="string">"maxsoft.jsp"</span>/&gt;</span><br><span class="line">&lt;%-- &lt;spring:message text="Spring"&gt;&lt;/spring:message&gt; --%&gt;</span><br><span class="line">&lt;% String date = DateUtils.getNowDate().toLocaleString(); %&gt;</span><br><span class="line"></span><br><span class="line">北京时间：</span><br><span class="line"></span><br><span class="line">&lt;%=flag + <span class="string">":"</span> + date %&gt;</span><br><span class="line">&lt;%-- 注释内容 --%&gt;</span><br><span class="line">&lt;%-- &lt;% String name = <span class="string">"MaxSoft"</span>; %&gt; --%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>运行效果：<br><img  src="/uploads/jsp.png"/></p>
<h2 id="JSP标签库"><a href="#JSP标签库" class="headerlink" title="JSP标签库"></a>JSP标签库</h2><p>在使用JSP标签之前要在JSP页面中通过<font color=red>&lt;%@taglib prefix=”标签前缀” uri=“网络标签库地址” %&gt;</font> 或 <font color=red>&lt;%@taglib  prefix=”标签前缀”  tagdir=“自定义标签库地址” %&gt;</font> 将要使用的标签导入到当前的JSP页面中才可以使用。当然在JSP页面中有系统默认的标签库，是不需要导入就可以使用。具体可以参照以上的JSP页面示例。</p>
<p>我们在JSP中常用的标签有如下几种：</p>
<pre><code>1&gt; &lt;%@page import=“” language=&quot;&quot; pageEncoding=“” contentType=&quot;&quot; autoFlush=&quot;&quot; buffer=&quot;&quot; errorPage=&quot;&quot; %&gt;
     --import 用于将java类包导入到当前页面，可以导入多个，用“,”分割
     --language 用于指定服务器端的语言环境 默认为Java
     --pageEncoding 指定页面编码
     --contentType 指定当前页面的编码方式
     --autoFlush 自动刷新缓冲区
     --buffer 响应输出流的缓冲区大小，默认8KB
     --errorPage 指定错误页面，也可以在web.xml中设置

2&gt; &lt;%@include file=&quot;b.jsp&quot;%&gt; 包含指定页面的内容

3&gt; &lt;%@taglib prefix=&quot;spring&quot; uri=&quot;http://www.springframework.org/tags&quot; %&gt; 引入指定的标签库

4&gt; &lt;jsp:useBean  id=&quot;user&quot; class=&quot;org.maxsoft.User&quot;&gt; 引入指定的类并创建该类实例
5&gt; &lt;jsp:setProperty name=&quot;user&quot; property=&quot;name&quot; value=&quot;maxsoft&quot;&gt; 对应类实例设置属性
6&gt; &lt;jsp:getProperty name=&quot;user&quot; property=&quot;name&quot;&gt; 获取类实例的属性
7&gt; 其他的逻辑控制标签，页面跳转标签等</code></pre><h2 id="JSP内置对象"><a href="#JSP内置对象" class="headerlink" title="JSP内置对象"></a>JSP内置对象</h2><p>JSP的内置对象总共有9个(作用域由大到小)，分别是<br><font color=red>application</font> (javax.servlet.ServletContext) <font color=green>作用域 Application，随着Web容器的生命周期而存在</font>；<br><font color=red>session</font>(javax.servlet.http.HttpSession) <font color=green>作用域 Session，随着一次有效会话的生命周期而存在</font>；<br><font color=red>request</font>(javax.servlet.ServletRequest) <font color=green>作用域 Request，随着一次请求而存在</font>；<br><font color=red>pageContext</font>(javax.servlet.jsp.PageContext) <font color=green>作用域 Page，只在当前页面有效</font>；<br><font color=red>response</font>(javax.servlet.SrvletResponse) <font color=green>作用域 Page，只在当前页面有效</font>；<br><font color=red>out</font>(javax.servlet.jsp.JspWriter) <font color=green>作用域 Page，只在当前页面有效</font>；<br><font color=red>page</font>(当前页面对象及javax.lang.Object) <font color=green>作用域 Page，只在当前页面有效</font>；<br><font color=red>exception</font>(javax.lang.Throwable) <font color=green>作用域 Page，只在当前页面有效</font>；<br><font color=red>config</font>(javax.servlet.ServletConfig) <font color=green>作用域 Page，只在当前页面有效</font>；<br>其中out与response.write()不要同时使用，因为在服务响应之前，Web容器会先把out缓冲区的数据刷新给response对象中，然后才在response独享缓冲区获取响应数据。</p>
<h2 id="JSP的工作原理"><a href="#JSP的工作原理" class="headerlink" title="JSP的工作原理"></a>JSP的工作原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当浏览器发起一个请求到WEB容器，如果请求地址是以.jsp结尾时，Web容器则会把请求交给JSP引擎来编译执行。如果请求地址没有.jsp结尾时，Web容器会在Web.xml中查询对应的Servlet映射页面（存在jsp与Servlet的映射关系）解析编译并执行或直接执行Servlet并响应结果信息到客户端；Web容器中的JSP引擎就是一个Servlet程序，它负责解释和执行JSP页面。即把jsp页面交给JSP引擎翻译成一个Servlet程序，然后把该Servlet程序编译成Servlet的class文件，最后由WEB容器来装载和解释执行这个被编译后的Servlet程序，并响应结果给客户端。 </p>
<p>More info: <a href="http://www.oracle.com/technetwork/java/javaee/jsp/index.html" target="_blank" rel="noopener">Java Server Page</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="maxsoft"
      src="/images/apple-touch-icon-next.png">
  <p class="site-author-name" itemprop="name">maxsoft</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/maxsoft-bj" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;maxsoft-bj" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zylwlh810@163.com" title="E-Mail → mailto:zylwlh810@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">maxsoft</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">327k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:57</span>
</div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@latest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout: 3000,
        priority: true,
        ignores: [uri => uri.includes('#'),uri => uri == 'http://yoursite.com/page/4/',]
      });
      });
  </script>

</body>
</html>
