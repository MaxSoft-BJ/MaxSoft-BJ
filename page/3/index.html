<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","width":250,"display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":15},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MaxSoft">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="MaxSoft">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="maxsoft">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>MaxSoft</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">MaxSoft</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">「路漫漫其修远兮，吾将上下而求索」</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/14/JDK%E7%BA%BF%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8BSemaphore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/14/JDK%E7%BA%BF%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8BSemaphore/" class="post-title-link" itemprop="url">JDK线程控制工具类之Semaphore</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2015-03-14 09:08:42" itemprop="dateCreated datePublished" datetime="2015-03-14T09:08:42+08:00">2015-03-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Semaphore 是在 JDK 1.5 版本中的新增的关于线程相关辅助工具集中的一个工具类（位于 java.util.concurrent 包下）。Semaphore 主要维护了一组可用的信号，对并发的线程或任务进行定量控制，即 Semaphore 中有多少个可用信号，最多同时可并发执行多少个线程或任务。每个线程或任务执行完毕后需要释放其获取的信号，供其他等待中的线程或任务来获取。其中信号的获取主要是通过 acquire() 或 acquire(int count)方法，信号的释放通过 release() 或 release(int count) 方法；如果获取了信号不去释放那么当前的可用信号量将会减少直到可用信号量为0，则其他等待获取信号的线程或任务将会一直处于等待状态阻塞应用程序的执行。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Semaphore 可以用来控制同时访问特定资源的线程数量，从而协调各个线程的执行过程，保证合理的使用公共资源。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们可以通过 Semaphore 来模拟借阅者在图书馆借阅固定数量的图书的过程：<br>1&sdot;&nbsp;&nbsp; 首先，我们建立图书类（ Book.java ）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String sn;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">(String name, String sn)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">		<span class="keyword">this</span>.sn = sn;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getSn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> sn;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSn</span><span class="params">(String sn)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.sn = sn;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2&sdot;&nbsp;&nbsp; 其次，我们建立图书馆（ Library.java ）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Library</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> max_available; <span class="comment">//同一时间最多可借阅的借阅者数量</span></span><br><span class="line">	<span class="keyword">private</span> Semaphore available = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">protected</span> Book[] library = &#123;<span class="keyword">new</span> Book(<span class="string">"Java编程思想"</span>, <span class="string">"SN-9787111213826"</span>),<span class="keyword">new</span> Book(<span class="string">"Go语言实战"</span>, <span class="string">"SN-9787115445353"</span>),<span class="keyword">new</span> Book(<span class="string">"Python编程"</span>, <span class="string">"SN-9787512355309"</span>)&#125;;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">boolean</span>[] isloan = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Library</span><span class="params">(Book[] library)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> count = library.length;</span><br><span class="line">		<span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			max_available = count;</span><br><span class="line">			<span class="keyword">this</span>.library = library;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			max_available = <span class="keyword">this</span>.library.length;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.available = <span class="keyword">new</span> Semaphore(max_available, <span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">this</span>.library = library;</span><br><span class="line">		<span class="keyword">this</span>.isloan = <span class="keyword">new</span> <span class="keyword">boolean</span>[max_available];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Book <span class="title">getBook</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		available.acquire();</span><br><span class="line">		<span class="keyword">return</span> getNextAvailableItem();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putBook</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (markAsUnused(book)) available.release();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getWaiters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"排队等候的借阅者："</span> + available.getQueueLength() + <span class="string">" 位;"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> Book <span class="title">getNextAvailableItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; max_available; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!isloan[i]) &#123;</span><br><span class="line">				isloan[i] = <span class="keyword">true</span>;</span><br><span class="line">				<span class="keyword">return</span> library[i];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">markAsUnused</span><span class="params">(Book item)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; max_available; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (item == library[i]) &#123;</span><br><span class="line">				<span class="keyword">if</span> (isloan[i]) &#123;</span><br><span class="line">					isloan[i] = <span class="keyword">false</span>;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span></span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3&sdot;&nbsp;&nbsp; 接下来，我们建立借阅者（ Library.java ）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reader</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Library library;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Library <span class="title">getLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> library;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLibrary</span><span class="params">(Library library)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.library = library;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Reader</span><span class="params">(Library library,String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.library = library;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Book book = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			book = library.getBook();</span><br><span class="line">			System.out.println(<span class="string">"读者【"</span> + <span class="keyword">this</span>.getName() + <span class="string">"】--借阅了图书--&gt;"</span> + book.getName());</span><br><span class="line">			Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">9000</span>));</span><br><span class="line">			library.getWaiters();</span><br><span class="line">			System.out.println(<span class="string">"读者【"</span> + <span class="keyword">this</span>.getName() + <span class="string">"】--归还了图书--&gt;"</span> + book.getName());</span><br><span class="line">			library.putBook(book);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4&sdot;&nbsp;&nbsp; 最后，我们来进行测试模拟整个过程（ Library.java ）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimulationTest</span> </span>&#123;</span><br><span class="line">	Library library = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Before</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">		Book[] books = &#123;<span class="keyword">new</span> Book(<span class="string">"Java编程思想"</span>, <span class="string">"SN-9787111213826"</span>),</span><br><span class="line">				<span class="keyword">new</span> Book(<span class="string">"Go语言实战"</span>, <span class="string">"SN-9787115445353"</span>),</span><br><span class="line">				<span class="keyword">new</span> Book(<span class="string">"Python编程"</span>, <span class="string">"SN-9787512355309"</span>),</span><br><span class="line">				<span class="keyword">new</span> Book(<span class="string">"算法导论"</span>, <span class="string">"SN-9787111407010"</span>),</span><br><span class="line">				<span class="keyword">new</span> Book(<span class="string">"Learning Ecmascript 6"</span>, <span class="string">"SN-9781785884443"</span>)&#125;;</span><br><span class="line">		library = <span class="keyword">new</span> Library(books);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		ExecutorService se = Executors.newCachedThreadPool();</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"王小五"</span>));</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"赵小七"</span>));</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"刘小四"</span>));</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"田小六"</span>));</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"张小三"</span>));</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"李小九"</span>));</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"黄小明"</span>));</span><br><span class="line">		se.submit(<span class="keyword">new</span> Reader(library,<span class="string">"常小光"</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">50000</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码的运行结果如下：<img src='/uploads/semaphore_0.png' />通过上述测试结果我们可以清晰的看到每次最多能有5个借阅者同时进入借阅状态，剩下的借阅者则需要等待有归还的图书才可以进入借阅状态。这也明确的反映了 Semaphore 在多线程中的使用过程。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/13/JDK%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8BCyclicBarrier%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/13/JDK%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8BCyclicBarrier%20/" class="post-title-link" itemprop="url">JDK线程同步工具类之CyclicBarrier</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2015-03-13 12:48:15" itemprop="dateCreated datePublished" datetime="2015-03-13T12:48:15+08:00">2015-03-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CyclicBarrier 也是在 JDK 1.5 版本中的新增的关于线程同步辅助工具集中的一个工具类（位于 java.util.concurrent 包下），它允许一组线程互相等待以达到共同的障碍点。 CyclicBarriers 在涉及固定大小的线程的程序中很有用，它们必须需要的时候相互等待（即调用 await()方法）对方才可以跨越障碍点。由于 CyclicBarriers 的循环特性，障碍点被释放后是可以被重新使用的，这恰恰与CountDownLatch相反。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CyclicBarrier 支持一个可选的 Runnable 接口，该接口在派对中的最后一个线程到达后，但在任何线程被释放之前，每个障碍点只运行一次。 这种障碍行为对于在任何一方继续之前更新共享状态都很有用。<br>1&sdot;&nbsp;&nbsp; <font color=red>await()</font>：使当前线程进入等待状态。<br>2&sdot;&nbsp;&nbsp; <font color=red>await(long timeout, TimeUnit unit)</font>：使当前线程等待指定单位的时间。<br>3&sdot;&nbsp;&nbsp; <font color=red>isBroken()</font>：检查该障碍点是否处于终断状态。<br>4&sdot;&nbsp;&nbsp; <font color=red>reset()</font>：将障碍点重置为初始状态。<br>5&sdot;&nbsp;&nbsp; <font color=red>getParties()</font>：获取需要跨越障碍点的线程或任务数量。<br>6&sdot;&nbsp;&nbsp; <font color=red>getNumberWaiting()</font>：获取当前在障碍点出等待的线程或任务数量。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>CyclicBarrier 的使用场景如下：<br>1&sdot;&nbsp;&nbsp;当使用只有一个参数的构造函数 CyclicBarrier( int parties ) 时，在跨越障碍点时不需要执行预设的线程逻辑；<br>2&sdot;&nbsp;&nbsp;当使用带有俩个个参数的构造函数 CyclicBarrier( int parties, Runnable barrierAction ) 时，在跨越障碍点时需要执行预设的线程逻辑（barrierAction）；<br><font color=red>注意</font>：参数 parties 指达到障碍点的线程数或任务数；参数 barrierAction 为当这些线程或任务都达到障碍点时会执行预设逻辑对象。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们可以模拟一组线程进行数据统计的过程，其中各个子线程运行不同的逻辑，主线程进行对所有子线程的结果进行汇总：<br>1&sdot;&nbsp;&nbsp; 首先我们创建一个数据统计的线程类（ CyclicBarrierComponent.java ）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BrokenBarrierException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierComponent</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> CyclicBarrier barrier;</span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">int</span>[] array;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrierComponent</span><span class="params">(CyclicBarrier barrier, <span class="keyword">int</span> id, <span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.barrier = barrier;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">		<span class="keyword">this</span>.array = array;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		array[id] = <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</span><br><span class="line">		System.out.println(<span class="string">"CyclicBarrierComponent "</span> + id + <span class="string">" generates: "</span> + array[id]);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"CyclicBarrierComponent "</span> + id + <span class="string">" waiting"</span>);</span><br><span class="line">			barrier.await();</span><br><span class="line">			System.out.println(<span class="string">"CyclicBarrierComponent "</span> + id + <span class="string">" awaked"</span>);</span><br><span class="line">			barrier.await();</span><br><span class="line">			<span class="keyword">int</span> result = array[id] + array[id];</span><br><span class="line">			System.out.println(<span class="string">"CyclicBarrierComponent "</span> + id + <span class="string">" result: "</span> + result);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2&sdot;&nbsp;&nbsp;接下来我们创建一个测试类（ CyclicBarrierTestApp.java ）；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTestApp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span>[] array = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>];</span><br><span class="line">		CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">4</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="comment">// 在所有线程都到达Barrier时执行</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"CyclicBarrierTestApp running"</span>);</span><br><span class="line">				System.out.println(<span class="string">"sum the array : "</span> + (array[<span class="number">0</span>] + array[<span class="number">1</span>] + array[<span class="number">2</span>] + array[<span class="number">3</span>]));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="comment">// 启动子线程</span></span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> CyclicBarrierComponent(barrier, <span class="number">0</span>, array)).start();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> CyclicBarrierComponent(barrier, <span class="number">1</span>, array)).start();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> CyclicBarrierComponent(barrier, <span class="number">2</span>, array)).start();</span><br><span class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> CyclicBarrierComponent(barrier, <span class="number">3</span>, array)).start();</span><br><span class="line">		<span class="comment">// 模拟主线程执行，否则其他线程容易被打断执行逻辑</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">1000</span> * <span class="number">10</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3&sdot;&nbsp;&nbsp;以上代码的运行结果如下所示：<img src='/uploads/cyclicbarrier_0.png' />通过上述示例我们可以非常清晰的理解 CyclicBarrier 这个工具类作用以及使用方式。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/12/JDK%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8BCountDownLatch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/12/JDK%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%B9%8BCountDownLatch/" class="post-title-link" itemprop="url">JDK线程同步工具类之CountDownLatch</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2015-03-12 20:02:14" itemprop="dateCreated datePublished" datetime="2015-03-12T20:02:14+08:00">2015-03-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CountDownLatch 是在 JDK 1.5 版本中的新增的关于线程同步辅助工具集中的一个工具类（位于 java.util.concurrent 包下）。CountDownLatch 的功能是在完成一组在其他线程中正在执行的逻辑之前，允许一个或多个线程一直处于等待状态，从而达到线程同步的目的。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CountDownLatch 通过给定的数值来进行计数的初始化。调用 await() 方法进行对线程阻塞，调用 countDown() 方法来对计数次数的递减 ，如果计数次数为0时则所有等待的线程将被释放。<br/><font color=red>注意：</font>CountDownLatch 的计数次数不可以重置，如果需要重置则可以考虑使用 CyclicBarrier 工具类。<br>一下为该类中的主要的函数：<br>1&sdot;&nbsp;&nbsp; <font color=red>await()</font>：使当前线程进入等待状态。<br>2&sdot;&nbsp;&nbsp; <font color=red>await(long timeout, TimeUnit unit)</font>：使当前线程等待指定单位的时间。<br>3&sdot;&nbsp;&nbsp; <font color=red>countDown()</font>：对障碍点数量进行减一操作。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CountDownLatch 是一个多功能的同步工具，可用于多种场景。<br>1&sdot;&nbsp;&nbsp;当 CountDownLatch 初始化的计数为1，则可以用作一个简单的开/关锁存器或门：所有线程调用都处于等待状态，直到被调用了countDown()（即门或锁被打开）方法才会被释放（通过）。<br>2&sdot;&nbsp;&nbsp;当初始化为N的 CountDownLatch 可用于使一个主线程等待，直到N个子线程完成某个动作，或者某个动作已完成N次。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们接下来使用 CountDownLatch 来模拟一个计算机硬件检查的过程。<br>1&sdot;&nbsp;&nbsp; 首先我们来创建一个基类，来执行基础的通用操作（ BaseChecker.java ）。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseChecker</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isserviceup = <span class="keyword">false</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BaseChecker</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.latch = latch;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">verifyService</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIsserviceup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isserviceup;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsserviceup</span><span class="params">(<span class="keyword">boolean</span> isserviceup)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.isserviceup = isserviceup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			verifyService();</span><br><span class="line">			setIsserviceup(<span class="keyword">true</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace(System.err);</span><br><span class="line">			setIsserviceup(<span class="keyword">false</span>);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123; <span class="comment">//确保在finally中执行，否则有一个线程逻辑出现异常可能就会导致整个引用一直处在等待状态</span></span><br><span class="line">			<span class="keyword">if</span>(latch != <span class="keyword">null</span>)&#123;</span><br><span class="line">				latch.countDown(); <span class="comment">//进行计数次数的递减操作</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2&sdot;&nbsp;&nbsp; 其次我们来分别创建硬盘（DiskChecker.java），内存（MemoryChecker.java），网卡（NetWorkChecker.java）信息的检测类。示例代码如下：<br>DiskChecker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiskChecker</span> <span class="keyword">extends</span> <span class="title">BaseChecker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DiskChecker</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(latch);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDiskInfo</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">	    StringBuffer sb=<span class="keyword">new</span> StringBuffer();  </span><br><span class="line">	    File[] roots = File.listRoots();<span class="comment">// 获取磁盘分区列表  </span></span><br><span class="line">	    <span class="keyword">for</span> (File file : roots) &#123;  </span><br><span class="line">	         <span class="keyword">long</span> totalSpace=file.getTotalSpace();  </span><br><span class="line">	         <span class="keyword">long</span> usableSpace=file.getUsableSpace();  </span><br><span class="line">	         <span class="keyword">if</span>(totalSpace&gt;<span class="number">0</span>)&#123;  </span><br><span class="line">	             sb.append(<span class="string">"\n"</span>).append(file.getPath() + <span class="string">"(total:"</span>);  </span><br><span class="line">	             sb.append(Math.round(((<span class="keyword">double</span>)totalSpace/ (<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>))*<span class="number">100</span>/<span class="number">100.0</span>) + <span class="string">"GB  "</span>);  </span><br><span class="line">	             <span class="keyword">if</span>(Math.round((((<span class="keyword">double</span>)usableSpace/ (<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>))*<span class="number">100</span>)/<span class="number">100.0</span>)&lt;=<span class="number">1</span>)&#123;  </span><br><span class="line">	                 sb.append(<span class="string">"Remaining:"</span> + Math.round((((<span class="keyword">double</span>)usableSpace/ (<span class="number">1024</span>*<span class="number">1024</span>))*<span class="number">100</span>)/<span class="number">100.0</span>) + <span class="string">"MB) "</span>);  </span><br><span class="line">	             &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">	                 sb.append(<span class="string">"Remaining:"</span> + Math.round((((<span class="keyword">double</span>)usableSpace/ (<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>))*<span class="number">100</span>)/<span class="number">100.0</span>) + <span class="string">"GB) "</span>);  </span><br><span class="line">	             &#125;  </span><br><span class="line">	             sb.append(<span class="string">"Used:"</span> + Math.round((((<span class="keyword">double</span>)(totalSpace-usableSpace)/(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>))*<span class="number">100</span>)/<span class="number">100.0</span>) + <span class="string">"GB"</span>);  </span><br><span class="line">	         &#125;  </span><br><span class="line">	    &#125;  </span><br><span class="line">	    <span class="keyword">return</span> sb.toString();  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">			System.out.println(getDiskInfo());</span><br><span class="line">			System.out.println(<span class="string">"Hard disk detection completed!"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MemoryChecker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> com.sun.management.OperatingSystemMXBean;</span><br><span class="line"><span class="keyword">import</span> sun.management.ManagementFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryChecker</span> <span class="keyword">extends</span> <span class="title">BaseChecker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MemoryChecker</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(latch);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMemorySize</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">	    StringBuffer sb=<span class="keyword">new</span> StringBuffer();  </span><br><span class="line">	    OperatingSystemMXBean osmb = (OperatingSystemMXBean) ManagementFactory.getOperatingSystemMXBean();  </span><br><span class="line">	       sb.append(<span class="string">"Total system physical memory："</span> + osmb.getTotalPhysicalMemorySize() / <span class="number">1024</span> / <span class="number">1024</span> + <span class="string">"MB\n"</span>);  </span><br><span class="line">	       sb.append(<span class="string">"Total system physical memory available："</span> + osmb.getFreePhysicalMemorySize() / <span class="number">1024</span> / <span class="number">1024</span> + <span class="string">"MB"</span>);  </span><br><span class="line">	    <span class="keyword">return</span> sb.toString();  </span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">			System.out.println(getMemorySize());</span><br><span class="line">			System.out.println(<span class="string">"Memory test completed!"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NetWorkChecker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.NetworkInterface;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetWorkChecker</span> <span class="keyword">extends</span> <span class="title">BaseChecker</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">NetWorkChecker</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(latch);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getMacAddress</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">		StringBuffer msg = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	String mac_display_name;</span><br><span class="line">        	String mac_address; </span><br><span class="line">            Enumeration&lt;NetworkInterface&gt; enumeration = NetworkInterface.getNetworkInterfaces();  </span><br><span class="line">            <span class="keyword">while</span> (enumeration.hasMoreElements()) &#123;  </span><br><span class="line">                StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();  </span><br><span class="line">                NetworkInterface networkInterface = enumeration.nextElement();</span><br><span class="line">                <span class="keyword">if</span> (networkInterface != <span class="keyword">null</span>) &#123;  </span><br><span class="line">                	mac_display_name = networkInterface.getDisplayName();</span><br><span class="line">                    <span class="keyword">byte</span>[] bytes = networkInterface.getHardwareAddress();  </span><br><span class="line">                    <span class="keyword">if</span> (bytes != <span class="keyword">null</span>) &#123;  </span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;  </span><br><span class="line">                            <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;  </span><br><span class="line">                                stringBuffer.append(<span class="string">"-"</span>);  </span><br><span class="line">                            &#125;  </span><br><span class="line">                            <span class="keyword">int</span> tmp = bytes[i] &amp; <span class="number">0xff</span>; <span class="comment">// 字节转换为整数  </span></span><br><span class="line">                            String str = Integer.toHexString(tmp);  </span><br><span class="line">                            <span class="keyword">if</span> (str.length() == <span class="number">1</span>) &#123;  </span><br><span class="line">                                stringBuffer.append(<span class="string">"0"</span> + str);  </span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                                stringBuffer.append(str);  </span><br><span class="line">                            &#125;  </span><br><span class="line">                        &#125;  </span><br><span class="line">                        mac_address = stringBuffer.toString().toUpperCase();</span><br><span class="line">                        <span class="keyword">if</span>(!StringUtils.isEmpty(mac_address))&#123;</span><br><span class="line">                        	msg.append(<span class="string">"\n"</span>).append(mac_display_name).append(<span class="string">":"</span>);</span><br><span class="line">                        	msg.append(mac_address);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> msg.toString();</span><br><span class="line">    &#125;  </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">4000</span>);</span><br><span class="line">			System.out.println(getMacAddress());</span><br><span class="line">			System.out.println(<span class="string">"NetWork card testing completed!"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3&sdot;&nbsp;&nbsp; 最后我们来创建调用逻辑代码以及测试逻辑代码（Application.java）。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> List&lt;BaseChecker&gt; list = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch latch;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Application</span><span class="params">()</span> </span>&#123;	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">CheckComputerState</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">		latch = <span class="keyword">new</span> CountDownLatch(<span class="number">3</span>);</span><br><span class="line">		list = <span class="keyword">new</span> ArrayList&lt;BaseChecker&gt;();</span><br><span class="line">		list.add(<span class="keyword">new</span> DiskChecker(latch));</span><br><span class="line">		list.add(<span class="keyword">new</span> MemoryChecker(latch));</span><br><span class="line">		list.add(<span class="keyword">new</span> NetWorkChecker(latch));</span><br><span class="line">		ExecutorService execute = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">			execute.execute(list.get(i));</span><br><span class="line">		&#125;</span><br><span class="line">		latch.await();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (BaseChecker v : list) &#123;</span><br><span class="line">			<span class="keyword">if</span>(!v.isIsserviceup())&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			result = Application.CheckComputerState();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"\nExternal services validation completed !! Result was :"</span>+(result ? <span class="string">"Started up successfully!"</span> : <span class="string">" Failed to start!"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下图所示：<img src='/uploads/countdownlatch_0.png' /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/11/JDK%E4%BB%A3%E7%90%86%E4%BB%A5%E5%8F%8Acglib%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/11/JDK%E4%BB%A3%E7%90%86%E4%BB%A5%E5%8F%8Acglib%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" class="post-title-link" itemprop="url">JDK 代理以及 CGLib 动态代理</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2015-03-11 13:02:49" itemprop="dateCreated datePublished" datetime="2015-03-11T13:02:49+08:00">2015-03-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;代理技术( Proxy )其实就是一种设计模式，它提供了对目标对象特殊的访问方式。类似我们现实生活中的在银行柜台存钱一样，我们负责把钱递给柜台专员，而柜台专员则需要拿到钱后进行验钞，点数最后确认才能进行入库操作。这个过程中我们就是目标对象，而柜台专员则是扮演了代理这个角色进行了一些其他的操作（例子可能不太恰当但是就是这个逻辑 ^W^ …… 世界上最难的事儿，大概就是举一个浅显易懂且恰当的例子了 …… ）<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在我们日常的 Java 项目开发过程中主要的代理技术分为俩类，一类是JDK的代理技术另一类是CGLib的代理。</p>
<h2 id="JDK-代理"><a href="#JDK-代理" class="headerlink" title="JDK 代理"></a>JDK 代理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在 JDK 中代理技术分为两种，一种是<font color=red>静态代理</font>，另一种是<font color=red>动态代理</font>。动态代理相对静态代理在代码层面而言会相对简洁且完全体现出了代码的重用性，相对于功能逻辑的实现方面，静态代理需要定义接口或者父类，且被代理对象与代理对象要共同实现相同的接口或者是继承相同父类；动态代理的代理对象不需要实现接口，且代理对象的生成是利用 JDK 的反射技术在内存中动态构建代理对象(需要我们指定创建代理对象/目标对象实现的接口的类型)，但是目标对象必须实现接口，因此动态代理也被称为接口代理；</p>
<h3 id="JDK-之静态代理"><a href="#JDK-之静态代理" class="headerlink" title="JDK 之静态代理"></a>JDK 之静态代理</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JDK 静态代理是指通过代理对象与被代理对象实现同一个接口或继承同一个父类，然后在代理对象中的方法中调用被代理对象的相同的方法而实现的过程。<br>我们先申明一个共同的接口，然后代理类和被代理类各自实现自己的代码逻辑，如下：<br>用户实体代码，User.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> 用户实体信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> MaxSoft</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">	<span class="keyword">private</span> String id;</span><br><span class="line">	<span class="keyword">private</span> String code;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> sex;</span><br><span class="line">	<span class="keyword">private</span> String birthday;</span><br><span class="line">	<span class="comment">// set , get 省略了</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"User [id="</span> + id + <span class="string">", code="</span> + code + <span class="string">", name="</span> + name</span><br><span class="line">				+ <span class="string">", sex="</span> + sex + <span class="string">", birthday="</span> + birthday + <span class="string">"]"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口类代码，IUserService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.iservice.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"---&gt;执行了新增用户操作[UserServiceImpl.addUser(User user)]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"---&gt;执行了删除用户操作[UserServiceImpl.deleteUser(User user)]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现类代码，UserServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.iservice.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"---&gt;执行了新增用户操作[UserServiceImpl.addUser(User user)]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"---&gt;执行了删除用户操作[UserServiceImpl.deleteUser(User user)]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理类代码，UserServiceProxyImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy.statics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.iservice.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceProxyImpl</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">	IUserService target; <span class="comment">// 注意这里是关键</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">UserServiceProxyImpl</span><span class="params">(IUserService service)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.target = service;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"---&gt;【新增用户】执行前其他操作逻辑-----------"</span>);</span><br><span class="line">		target.addUser(user);</span><br><span class="line">		System.out.println(<span class="string">"---&gt;【新增用户】执行后其他操作逻辑-----------"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"---&gt;【删除用户】执行前其他操作逻辑-----------"</span>);</span><br><span class="line">		target.deleteUser(user);</span><br><span class="line">		System.out.println(<span class="string">"---&gt;【删除用户】执行后其他操作逻辑-----------"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码，ProxyTest.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.service.impl.UserServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.statics.UserServiceProxyImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	User user;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Before</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">		user = <span class="keyword">new</span> User();</span><br><span class="line">		user.setId(<span class="string">"1000000001"</span>);</span><br><span class="line">		user.setCode(<span class="string">"MaxSoft"</span>);</span><br><span class="line">		user.setName(<span class="string">"MaxSoft"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">static_proxy_test</span><span class="params">()</span></span>&#123;<span class="comment">// 静态代理测试</span></span><br><span class="line">		UserServiceProxyImpl userServiceProxyImpl = <span class="keyword">new</span> UserServiceProxyImpl(<span class="keyword">new</span> UserServiceImpl());</span><br><span class="line">		userServiceProxyImpl.addUser(user);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">500</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		userServiceProxyImpl.deleteUser(user);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试运行结果如图 1. ：<img src="/uploads/2015-03-11-001.png" title="图 1. 静态代理测试运行结果"/></p>
<h3 id="JDK-之动态代理"><a href="#JDK-之动态代理" class="headerlink" title="JDK 之动态代理"></a>JDK 之动态代理</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JDK 动态代理是指代理类通过传入的被代理对象实例使用 JDK 反射技术实例化代理实例并在执行被代理对象实例的方法前后植入其他个性化逻辑的过程。<br>该过程与静态代理不同之处在与代理类不需要实现被代理对象的接口，而是要实现 JDK 中动态代理的核心接口 InvocationHandler ，具体的代理类代码如下 ProxyFactory.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.utils.SysLog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Object target; <span class="comment">// 代理目标</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(Object target)</span> </span>&#123; <span class="comment">// 将目标对象传入进行代理</span></span><br><span class="line">		<span class="keyword">this</span>.target = target;     </span><br><span class="line">		<span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(),target.getClass().getInterfaces(), <span class="keyword">this</span>);<span class="comment">//返回代理对象    </span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		SysLog.sysBeforeLog(target,method, args); <span class="comment">// 执行前植入逻辑</span></span><br><span class="line">		Object obj = <span class="keyword">null</span>;</span><br><span class="line">		obj = method.invoke(target, args);</span><br><span class="line">		SysLog.sysAfterLog(target,method, args); <span class="comment">// 执行后植入逻辑</span></span><br><span class="line">		<span class="keyword">return</span> obj;    </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SysLog.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysLog</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sysBeforeLog</span><span class="params">(Object target,Method method, Object[] args)</span></span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"------&gt;目标对象的方法["</span>+target.getClass().getName() + <span class="string">"."</span> + method.getName()+<span class="string">"]执行前执行日志记录逻辑[JDKProxy.sysBeforeLog()]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sysAfterLog</span><span class="params">(Object target,Method method, Object[] args)</span></span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"------&gt;目标对象的方法["</span>+target.getClass().getName()+ <span class="string">"."</span> + method.getName()+<span class="string">"]执行后执行日志记录逻辑[JDKProxy.sysAfterLog()]"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码，在上述 ProxyTest.java 中加入如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJDKDynamicProxy</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ProxyFactory proxyFactory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">	IUserService userServiceJDK = (IUserService)proxyFactory.newInstance(<span class="keyword">new</span> UserServiceImpl());</span><br><span class="line">	userServiceJDK.addUser(user);</span><br><span class="line">	userServiceJDK.deleteUser(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试运行结果如图 2. ：<img src="/uploads/2015-03-11-002.png" title="图 2. 动态代理测试运行结果"/>以上示例就是 JDK 中动态代理的具体实现过程，我们是不是可以通过上述示例中看到 Spring 中 AOP 的影子呢？其实这就是一个相对简化的 AOP 示例。</p>
<h2 id="CGLib-代理"><a href="#CGLib-代理" class="headerlink" title="CGLib 代理"></a>CGLib 代理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CGLib（ Code Generation Library ）是一个开源项目 <a href="url=https://github.com/cglib"><font color=red>开源地址</font></a> 。到目前为止它是一个相对优秀的第三方 Code 生成类库，其可以在运行期扩展 Java 类与实现 Java 接口，这也是其实现动态代理的关键。</p>
<h3 id="源码片段"><a href="#源码片段" class="headerlink" title="源码片段"></a>源码片段</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CGLib 动态生成子类（继承父类或实现接口）是借助于 ASM 框架来完成的，具体的实现我们可以通过阅读代理类增强器 （ Enhancer ）来了解 。如下代码片段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">create</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	Class gen = <span class="keyword">null</span>;</span><br><span class="line">    	</span><br><span class="line">        <span class="keyword">synchronized</span> (source) &#123;</span><br><span class="line">            ClassLoader loader = getClassLoader(); <span class="comment">//获取当前引用的类加载器</span></span><br><span class="line">            Map cache2 = <span class="keyword">null</span>;</span><br><span class="line">            cache2 = (Map)source.cache.get(loader); <span class="comment">//通过类加载器尝试获取对应的缓冲信息</span></span><br><span class="line">            <span class="keyword">if</span> (cache2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cache2 = <span class="keyword">new</span> HashMap();</span><br><span class="line">                cache2.put(NAME_KEY, <span class="keyword">new</span> HashSet());</span><br><span class="line">                source.cache.put(loader, cache2); <span class="comment">// 缓冲当前的类加载器对应的缓冲数据</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (useCache) &#123;</span><br><span class="line">                Reference ref = (Reference)cache2.get(key);</span><br><span class="line">                gen = (Class) (( ref == <span class="keyword">null</span> ) ? <span class="keyword">null</span> : ref.get()); </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (gen == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object save = CURRENT.get();</span><br><span class="line">                CURRENT.set(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.key = key;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (attemptLoad) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            gen = loader.loadClass(getClassName());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                            <span class="comment">// ignore</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (gen == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         *  通过当前类进行生成类的字节数组，这里最关键的地方 </span></span><br><span class="line"><span class="comment">                         *  移步[net.sf.cglib.core.DefaultGeneratorStrategy.generate(ClassGenerator cg)]方法</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        <span class="keyword">byte</span>[] b = strategy.generate(<span class="keyword">this</span>);</span><br><span class="line">                        <span class="comment">// 通过类字节数组获取对应的类名</span></span><br><span class="line">                        String className = ClassNameReader.getClassName(<span class="keyword">new</span> ClassReader(b));</span><br><span class="line">                        <span class="comment">// 通过类加载器获取其对应的类名缓冲实例并新增类名到该缓冲实例中</span></span><br><span class="line">                        getClassNameCache(loader).add(className);</span><br><span class="line">                        <span class="comment">// 通过类名，类字节数组以及类加载器动态定义新的类</span></span><br><span class="line">                        gen = ReflectUtils.defineClass(className, b, loader); </span><br><span class="line">                    &#125;</span><br><span class="line">                   </span><br><span class="line">                    <span class="keyword">if</span> (useCache) &#123;</span><br><span class="line">                        <span class="comment">//在类加载器对应的缓冲中增加生成类的弱引用实例。</span></span><br><span class="line">                        cache2.put(key, <span class="keyword">new</span> WeakReference(gen)); </span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> firstInstance(gen); <span class="comment">// 实例化动态生成的类并返回。</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    CURRENT.set(save);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> firstInstance(gen);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Error e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CodeGenerationException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们通过 DefaultGeneratorStrategy.generate(ClassGenerator cg) 来继续分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.sf.cglib.core;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultGeneratorStrategy</span> <span class="keyword">implements</span> <span class="title">GeneratorStrategy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultGeneratorStrategy INSTANCE = <span class="keyword">new</span> DefaultGeneratorStrategy();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] generate(ClassGenerator cg) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 这里使用了 ASM 框架中的 ClassWriter 来进行输出类字节数组</span></span><br><span class="line">        ClassWriter cw = getClassWriter(); </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">          * 这是比较关键的操作</span></span><br><span class="line"><span class="comment">          * 继续移步[net.sf.cglib.proxy.Enhancer.generateClass(ClassVisitor v)] 方法</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">        transform(cg).generateClass(cw); </span><br><span class="line">        <span class="keyword">return</span> transform(cw.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ClassWriter <span class="title">getClassWriter</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DebuggingClassWriter(ClassWriter.COMPUTE_MAXS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续通过 Enhancer.generateClass(ClassVisitor v) 来进行分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateClass</span><span class="params">(ClassVisitor v)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Class sc = (superclass == null) ? Object.class : superclass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TypeUtils.isFinal(sc.getModifiers())) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot subclass final class "</span> + sc);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  这里通过基类获取其所有的构造函数的集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List constructors = <span class="keyword">new</span> ArrayList(Arrays.asList(sc.getDeclaredConstructors()));</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  过滤构造函数，将私有（private）构造函数，受保护的（protected）构造函数，</span></span><br><span class="line"><span class="comment">     *  非当前类的自身构造函数（父级的构造函数）都排除掉，具体过程可以查阅：</span></span><br><span class="line"><span class="comment">     *  net.sf.cglib.proxy.Enhancer.filterConstructors( ... ),</span></span><br><span class="line"><span class="comment">     *  net.sf.cglib.core.CollectionUtils.filter( ... )</span></span><br><span class="line"><span class="comment">     *  net.sf.cglib.core.VisibilityPredicate.evaluate( ... )</span></span><br><span class="line"><span class="comment">     *  这里就不再详述了。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    filterConstructors(sc, constructors);</span><br><span class="line"></span><br><span class="line">    List actualMethods = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    List interfaceMethods = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="keyword">final</span> Set forcePublic = <span class="keyword">new</span> HashSet();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  获取基类或接口中的方法，并排除掉静态（static），终态（final），</span></span><br><span class="line"><span class="comment">     *  私有（private），受保护（protected），非自身（父级方法），重复的方法。</span></span><br><span class="line"><span class="comment">     *  具体过程可以查阅：</span></span><br><span class="line"><span class="comment">     *  net.sf.cglib.proxy.Enhancer.getMethods( ... ) 以及 内部的其他调用逻辑</span></span><br><span class="line"><span class="comment">     *  这里就不再详述了。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    getMethods(sc, interfaces, actualMethods, interfaceMethods, forcePublic);</span><br><span class="line">    <span class="comment">//通过方法名称转换为方法实例</span></span><br><span class="line">    List methods = CollectionUtils.transform(actualMethods, <span class="keyword">new</span> Transformer() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">            Method method = (Method)value;</span><br><span class="line">            <span class="keyword">int</span> modifiers = Constants.ACC_FINAL</span><br><span class="line">                | (method.getModifiers()</span><br><span class="line">                   &amp; ~Constants.ACC_ABSTRACT</span><br><span class="line">                   &amp; ~Constants.ACC_NATIVE</span><br><span class="line">                   &amp; ~Constants.ACC_SYNCHRONIZED);</span><br><span class="line">            <span class="keyword">if</span> (forcePublic.contains(MethodWrapper.create(method))) &#123;</span><br><span class="line">                modifiers = (modifiers &amp; ~Constants.ACC_PROTECTED) | Constants.ACC_PUBLIC;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ReflectUtils.getMethodInfo(method, modifiers);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//通过字节码开始动态生成类</span></span><br><span class="line">    ClassEmitter e = <span class="keyword">new</span> ClassEmitter(v);</span><br><span class="line">    e.begin_class(Constants.V1_2,</span><br><span class="line">                  Constants.ACC_PUBLIC,</span><br><span class="line">                  getClassName(),</span><br><span class="line">                  Type.getType(sc),</span><br><span class="line">                  (useFactory ?</span><br><span class="line">                   TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) :</span><br><span class="line">                   TypeUtils.getTypes(interfaces)),</span><br><span class="line">                  Constants.SOURCE_FILE);</span><br><span class="line">    List constructorInfo = CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance());<span class="comment">//转换构造函数</span></span><br><span class="line"></span><br><span class="line">    e.declare_field(Constants.ACC_PRIVATE, BOUND_FIELD, Type.BOOLEAN_TYPE, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (!interceptDuringConstruction) &#123;</span><br><span class="line">        e.declare_field(Constants.ACC_PRIVATE, CONSTRUCTED_FIELD, Type.BOOLEAN_TYPE, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, <span class="keyword">null</span>);</span><br><span class="line">    e.declare_field(Constants.PRIVATE_FINAL_STATIC, STATIC_CALLBACKS_FIELD, CALLBACK_ARRAY, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (serialVersionUID != <span class="keyword">null</span>) &#123;</span><br><span class="line">        e.declare_field(Constants.PRIVATE_FINAL_STATIC, Constants.SUID_FIELD_NAME, Type.LONG_TYPE, serialVersionUID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackTypes.length; i++) &#123;</span><br><span class="line">        e.declare_field(Constants.ACC_PRIVATE, getCallbackField(i), callbackTypes[i], <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    emitMethods(e, methods, actualMethods);</span><br><span class="line">    emitConstructors(e, constructorInfo);</span><br><span class="line">    emitSetThreadCallbacks(e);</span><br><span class="line">    emitSetStaticCallbacks(e);</span><br><span class="line">    emitBindCallbacks(e);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useFactory) &#123;</span><br><span class="line">        <span class="keyword">int</span>[] keys = getCallbackKeys();</span><br><span class="line">        emitNewInstanceCallbacks(e);</span><br><span class="line">        emitNewInstanceCallback(e);</span><br><span class="line">        emitNewInstanceMultiarg(e, constructorInfo);</span><br><span class="line">        emitGetCallback(e, keys);</span><br><span class="line">        emitSetCallback(e, keys);</span><br><span class="line">        emitGetCallbacks(e);</span><br><span class="line">        emitSetCallbacks(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    e.end_class();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上源码片段就是 CGLib 通过字节码动态生成类的大致过程。</p>
<h3 id="使用实例"><a href="#使用实例" class="headerlink" title="使用实例"></a>使用实例</h3><p>CGLibProxyFactory.java 动态代理生成工厂类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy.cglib;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.utils.SysLog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CGLibProxyFactory</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	Object target;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">createProxyObject</span><span class="params">(Object obj)</span> </span>&#123;    </span><br><span class="line">        	<span class="keyword">this</span>.target = obj;    </span><br><span class="line">        	Object proxyObj = Enhancer.create(obj.getClass(), <span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">        	<span class="keyword">return</span> proxyObj;</span><br><span class="line">	&#125;   </span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		SysLog.sysBeforeLog(target, method, args);</span><br><span class="line">		obj = method.invoke(target, args);    </span><br><span class="line">		SysLog.sysAfterLog(target, method, args);</span><br><span class="line">		<span class="keyword">return</span> obj;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ProxyTest.java 测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.maxsoft.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.cglib.CGLibProxyFactory;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.dynamic.ProxyFactory;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.iservice.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.service.impl.UserService;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.service.impl.UserServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.maxsoft.proxy.statics.UserServiceProxyImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	User user;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Before</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">		user = <span class="keyword">new</span> User();</span><br><span class="line">		user.setId(<span class="string">"1000000001"</span>);</span><br><span class="line">		user.setCode(<span class="string">"MaxSoft"</span>);</span><br><span class="line">		user.setName(<span class="string">"MaxSoft"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cglib_proxy_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//实现接口代理</span></span><br><span class="line">		IUserService service = (IUserService)<span class="keyword">new</span> CGLibProxyFactory().createProxyObject(<span class="keyword">new</span> UserServiceImpl());<span class="comment">//实现了接口</span></span><br><span class="line">		service.addUser(user);</span><br><span class="line">		service.deleteUser(user);</span><br><span class="line">		System.out.println(<span class="string">"\n\t"</span>);</span><br><span class="line">		<span class="comment">//无接口实现代理</span></span><br><span class="line">		UserService uservice = (UserService)<span class="keyword">new</span> CGLibProxyFactory().createProxyObject(<span class="keyword">new</span> UserService());<span class="comment">//无接口实现</span></span><br><span class="line">		uservice.putUser(user);</span><br><span class="line">		uservice.offerUser(user);</span><br><span class="line">		uservice.getUser(user); <span class="comment">// 终态方法</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试运行结果：<img src='/uploads/2015-03-11-003.png' title="CGLib 代理运行结果"/>通过上述运行结果我们可以看到其中申明为 final 类型的方法并没有执行植入的代码，这也验证了由于 CGLib 采用动态创建子类（继承）的方法，对于 final 类型的方法无法进行代理。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/08/Java%20%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E8%AF%AF%E5%8C%BA%E5%92%8C%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93-%E8%BD%AC%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/08/Java%20%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E8%AF%AF%E5%8C%BA%E5%92%8C%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93-%E8%BD%AC%E8%BD%BD/" class="post-title-link" itemprop="url">Java 异常处理的误区和经验总结-转载</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2015-03-08 20:12:41" itemprop="dateCreated datePublished" datetime="2015-03-08T20:12:41+08:00">2015-03-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;感谢原作者的精心分享，非常接地气，容易理解，可以借鉴！<font color=red>转载自【<a href="https://www.ibm.com/developerworks/cn/java/j-lo-exception-misdirection/" target="_blank" rel="noopener">IBM 开发者博客中心</a>】</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文着重介绍了 Java 异常选择和使用中的一些误区，希望各位读者能够熟练掌握异常处理的一些注意点和原则，注意总结和归纳。只有处理好了异常，才能提升开发人员的基本素养，提高系统的健壮性，提升用户体验，提高产品的价值。</p>
<h2 id="误区一、异常的选择"><a href="#误区一、异常的选择" class="headerlink" title="误区一、异常的选择"></a>误区一、异常的选择</h2><p>如下异常分类图：<img src="/uploads/2015-03-08-001.png" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上图中描述了异常的结构，其实我们都知道异常分检测异常和非检测异常，但是在实际中又混淆了这两种异常的应用。由于非检测异常使用方便，很多开发人员就认为检测异常没什么用处。<br/>其实异常的应用情景可以概括为以下：<br/>一、调用代码不能继续执行，需要立即终止。出现这种情况的可能性太多太多，例如服务器连接不上、参数不正确等。这些时候都适用非检测异常，不需要调用代码的显式捕捉和处理，而且代码简洁明了。<br>二、调用代码需要进一步处理和恢复。假如将 SQLException 定义为非检测异常，这样操作数据时开发人员理所当然的认为 SQLException 不需要调用代码的显式捕捉和处理，进而会导致严重的 Connection 不关闭、Transaction 不回滚、DB 中出现脏数据等情况，正因为 SQLException 定义为检测异常，才会驱使开发人员去显式捕捉，并且在代码产生异常后清理资源。当然清理资源后，可以继续抛出非检测异常，阻止程序的执行。根据观察和理解，检测异常大多可以应用于工具类中。</p>
<h2 id="误区二、将异常直接显示在页面或客户端"><a href="#误区二、将异常直接显示在页面或客户端" class="headerlink" title="误区二、将异常直接显示在页面或客户端"></a>误区二、将异常直接显示在页面或客户端</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将异常直接打印在客户端的例子屡见不鲜，以 JSP 为例，一旦代码运行出现异常，默认情况下容器将异常堆栈信息直接打印在页面上。其实从客户角度来说，任何异常都没有实际意义，绝大多数的客户也根本看不懂异常信息，软件开发也要尽量避免将异常直接呈现给用户。<br>代码清单1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ibm.dw.sample.exception;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义 RuntimeException</span></span><br><span class="line"><span class="comment"> * 添加错误代码属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeException</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">RuntimeException</span> </span>&#123; </span><br><span class="line">     <span class="comment">//默认错误代码 </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer GENERIC = <span class="number">1000000</span>; </span><br><span class="line">    <span class="comment">//错误代码</span></span><br><span class="line">    <span class="keyword">private</span> Integer errorCode; </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">RuntimeException</span><span class="params">(Integer errorCode, Throwable cause)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>(errorCode, <span class="keyword">null</span>, cause);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">RuntimeException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//利用通用错误代码</span></span><br><span class="line">            <span class="keyword">this</span>(GENERIC, message, cause);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">RuntimeException</span><span class="params">(Integer errorCode, String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(message, cause);</span><br><span class="line">            <span class="keyword">this</span>.errorCode = errorCode;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> Integer <span class="title">getErrorCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> errorCode;</span><br><span class="line">     &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正如示例代码所示，在异常中引入错误代码，一旦出现异常，我们只要将异常的错误代码呈现给用户，或者将错误代码转换成更通俗易懂的提示。其实这里的错误代码还包含另外一个功能，开发人员亦可以根据错误代码准确的知道了发生了什么类型异常。</p>
<h2 id="误区三、对代码层次结构的污染"><a href="#误区三、对代码层次结构的污染" class="headerlink" title="误区三、对代码层次结构的污染"></a>误区三、对代码层次结构的污染</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们经常将代码分 Service、Business Logic、DAO 等不同的层次结构，DAO 层中会包含抛出异常的方法，如代码清单 2 所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Customer <span class="title">retrieveCustomerById</span><span class="params">(Long id)</span> throw SQLException </span>&#123;</span><br><span class="line"> <span class="comment">//根据 ID 查询数据库</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码咋一看没什么问题，但是从设计耦合角度仔细考虑一下，这里的 SQLException 污染到了上层调用代码，调用层需要显式的利用 try-catch 捕捉，或者向更上层次进一步抛出。根据设计隔离原则，我们可以适当修改成代码清单3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Customer <span class="title">retrieveCustomerById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//根据 ID 查询数据库</span></span><br><span class="line">     &#125;<span class="keyword">catch</span>(SQLException e)&#123;</span><br><span class="line">            <span class="comment">//利用非检测异常封装检测异常，降低层次耦合</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(SQLErrorCode, e);</span><br><span class="line">     &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="comment">//关闭连接，清理资源</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="误区四、忽略异常"><a href="#误区四、忽略异常" class="headerlink" title="误区四、忽略异常"></a>误区四、忽略异常</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如下异常处理只是将异常输出到控制台，没有任何意义。而且这里出现了异常并没有中断程序，进而调用代码继续执行，导致更多的异常。<br/>代码清单4：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retrieveObjectById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">   <span class="keyword">try</span>&#123;</span><br><span class="line">       <span class="comment">//..some code that throws SQLException</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>(SQLException ex)&#123;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *了解的人都知道，这里的异常打印毫无意义，仅仅是将错误堆栈输出到控制台。</span></span><br><span class="line"><span class="comment">       * 而在 Production 环境中，需要将错误堆栈输出到日志。</span></span><br><span class="line"><span class="comment">       * 而且这里 catch 处理之后程序继续执行，会导致进一步的问题*/</span></span><br><span class="line">        </span><br><span class="line">          ex.printStacktrace();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以重构成，代码清单5：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retrieveObjectById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line"> <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">//..some code that throws SQLException</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">catch</span>(SQLException ex)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(“Exception in retieveObjectById”, ex);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">finally</span>&#123;</span><br><span class="line">    <span class="comment">//clean up resultset, statement, connection etc</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个误区比较基本，一般情况下都不会犯此低级错误。</p>
<h2 id="误区五、将异常包含在循环语句块中"><a href="#误区五、将异常包含在循环语句块中" class="headerlink" title="误区五、将异常包含在循环语句块中"></a>误区五、将异常包含在循环语句块中</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如下代码所示（代码清单6），异常包含在 for 循环语句块中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(XXXException e)&#123;</span><br><span class="line">         <span class="comment">//….</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们都知道异常处理占用系统资源。一看，大家都认为不会犯这样的错误。换个角度，类 A 中执行了一段循环，循环中调用了 B 类的方法，B 类中被调用的方法却又包含 try-catch 这样的语句块。褪去类的层次结构，代码和上面如出一辙。</p>
<h2 id="误区六、利用-Exception-捕捉所有潜在的异常"><a href="#误区六、利用-Exception-捕捉所有潜在的异常" class="headerlink" title="误区六、利用 Exception 捕捉所有潜在的异常"></a>误区六、利用 Exception 捕捉所有潜在的异常</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一段方法执行过程中抛出了几个不同类型的异常，为了代码简洁，利用基类 Exception 捕捉所有潜在的异常，如下例所示（代码清单7）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retrieveObjectById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//…抛出 IOException 的代码调用</span></span><br><span class="line">        <span class="comment">//…抛出 SQLException 的代码调用</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        <span class="comment">//这里利用基类 Exception 捕捉的所有潜在的异常，如果多个层次这样捕捉，会丢失原始异常的有效信息</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(“Exception in retieveObjectById”, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以重构成，代码清单8：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retrieveObjectById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//..some code that throws RuntimeException, IOException, SQLException</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">        <span class="comment">//仅仅捕捉 IOException</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="comment">/*指定这里 IOException 对应的错误代码*/</span>code,“Exception in retieveObjectById”, e);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(SQLException e)&#123;</span><br><span class="line">        <span class="comment">//仅仅捕捉 SQLException</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="comment">/*指定这里 SQLException 对应的错误代码*/</span>code,“Exception in retieveObjectById”, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="误区七、多层次封装抛出非检测异常"><a href="#误区七、多层次封装抛出非检测异常" class="headerlink" title="误区七、多层次封装抛出非检测异常"></a>误区七、多层次封装抛出非检测异常</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果我们一直坚持不同类型的异常一定用不同的捕捉语句，那大部分例子可以绕过这一节了。但是如果仅仅一段代码调用会抛出一种以上的异常时，很多时候没有必要每个不同类型的 Exception 写一段 catch 语句，对于开发来说，任何一种异常都足够说明了程序的具体问题。<br>代码清单9：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">//可能抛出 RuntimeException、IOExeption 或者其它；</span></span><br><span class="line">    <span class="comment">//注意这里和误区六的区别，这里是一段代码抛出多种异常。以上是多段代码，各自抛出不同的异常</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">    <span class="comment">//一如既往的将 Exception 转换成 RuntimeException，但是这里的 e 其实是 RuntimeException 的实例，已经在前段代码中封装过</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="comment">/**/code, /**/</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们如上例所示，将所有的 Exception 再转换成 RuntimeException，那么当 Exception 的类型已经是 RuntimeException 时，我们又做了一次封装。将 RuntimeException 又重新封装了一次，进而丢失了原有的 RuntimeException 携带的有效信息。<br>解决办法是我们可以在 RuntimeException 类中添加相关的检查，确认参数 Throwable 不是 RuntimeException 的实例。如果是，将拷贝相应的属性到新建的实例上。或者用不同的 catch 语句块捕捉 RuntimeException 和其它的 Exception。个人偏好方式一，好处不言而喻。</p>
<h2 id="误区八、多层次打印异常"><a href="#误区八、多层次打印异常" class="headerlink" title="误区八、多层次打印异常"></a>误区八、多层次打印异常</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们先看一下下面的例子，定义了 2 个类 A 和 B。其中 A 类中调用了 B 类的代码，并且 A 类和 B 类中都捕捉打印了异常。<br>代码清单10：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(A<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line">     <span class="comment">//实例化 B 类，可以换成其它注入等方式</span></span><br><span class="line">     B b = <span class="keyword">new</span> B();</span><br><span class="line">     b.process();</span><br><span class="line">     <span class="comment">//other code might cause exception</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(XXXException e)&#123;</span><br><span class="line">       <span class="comment">//如果 B 类 process 方法抛出异常，异常会在 B 类中被打印，在这里也会被打印，从而会打印 2 次</span></span><br><span class="line">       logger.error(e);</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="comment">/* 错误代码 */</span> errorCode, <span class="comment">/*异常信息*/</span>msg, e);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(B<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//可能抛出异常的代码</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(XXXException e)&#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="comment">/* 错误代码 */</span> errorCode, <span class="comment">/*异常信息*/</span>msg, e);</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同一段异常会被打印 2 次。如果层次再复杂一点，不去考虑打印日志消耗的系统性能，仅仅在异常日志中去定位异常具体的问题已经够头疼的了。其实打印日志只需要在代码的最外层捕捉打印就可以了，异常打印也可以写成 AOP，织入到框架的最外层。</p>
<h2 id="误区九、异常包含的信息不能充分定位问题"><a href="#误区九、异常包含的信息不能充分定位问题" class="headerlink" title="误区九、异常包含的信息不能充分定位问题"></a>误区九、异常包含的信息不能充分定位问题</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;异常不仅要能够让开发人员知道哪里出了问题，更多时候开发人员还需要知道是什么原因导致的问题，我们知道 java .lang.Exception 有字符串类型参数的构造方法，这个字符串可以自定义成通俗易懂的提示信息。<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;简单的自定义信息开发人员只能知道哪里出现了异常，但是很多的情况下，开发人员更需要知道是什么参数导致了这样的异常。这个时候我们就需要将方法调用的参数信息追加到自定义信息中。下例只列举了一个参数的情况，多个参数的情况下，可以单独写一个工具类组织这样的字符串。<br>代码清单11：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retieveObjectById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//..some code that throws SQLException</span></span><br><span class="line">   &#125;<span class="keyword">catch</span>(SQLException ex)&#123;</span><br><span class="line">        <span class="comment">//将参数信息添加到异常信息中</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(“Exception in retieveObjectById with Object Id :”+ id, ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="误区十、不能预知潜在的异常"><a href="#误区十、不能预知潜在的异常" class="headerlink" title="误区十、不能预知潜在的异常"></a>误区十、不能预知潜在的异常</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在写代码的过程中，由于对调用代码缺乏深层次的了解，不能准确判断是否调用的代码会产生异常，因而忽略处理。在产生了 Production Bug 之后才想起来应该在某段代码处添加异常补捉，甚至不能准确指出出现异常的原因。这就需要开发人员不仅知道自己在做什么，而且要去尽可能的知道别人做了什么，可能会导致什么结果，从全局去考虑整个应用程序的处理过程。这些思想会影响我们对代码的编写和处理。</p>
<h2 id="误区十一、混用多种第三方日志库"><a href="#误区十一、混用多种第三方日志库" class="headerlink" title="误区十一、混用多种第三方日志库"></a>误区十一、混用多种第三方日志库</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现如今 Java 第三方日志库的种类越来越多，一个大项目中会引入各种各样的框架，而这些框架又会依赖不同的日志库的实现。最麻烦的问题倒不是引入所有需要的这些日志库，问题在于引入的这些日志库之间本身不兼容。如果在项目初期可能还好解决，可以把所有代码中的日志库根据需要重新引入一遍，或者换一套框架。但这样的成本不是每个项目都承受的起的，而且越是随着项目的进行，这种风险就越大。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;怎么样才能有效的避免类似的问题发生呢，现在的大多数框架已经考虑到了类似的问题，可以通过配置 Properties 或 xml 文件、参数或者运行时扫描 Lib 库中的日志实现类，真正在应用程序运行时才确定具体应用哪个特定的日志库。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实根据不需要多层次打印日志那条原则，我们就可以简化很多原本调用日志打印代码的类。很多情况下，我们可以利用拦截器或者过滤器实现日志的打印，降低代码维护、迁移的成本。</p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>以上纯属个人的经验和总结，事物都是辩证的，没有绝对的原则，适合自己的才是最有效的原则。希望以上的讲解和分析可以对您有所帮助。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/02/13/Java%20%E4%B8%AD%E7%9A%84%20HashMap%20%E4%B8%8E%20HashTable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/02/13/Java%20%E4%B8%AD%E7%9A%84%20HashMap%20%E4%B8%8E%20HashTable/" class="post-title-link" itemprop="url">Java 中的 HashMap 与 HashTable</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2015-02-13 09:21:10" itemprop="dateCreated datePublished" datetime="2015-02-13T09:21:10+08:00">2015-02-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;马上就要过春节了，心情舒坦了不少。其中不乏过年的气氛渐浓，当然最重要的原因大概就是客户年终结算顺利完成，给了项目组莫大的鼓励与能力的认可 ^W^ ……，以及项目组大领导特批年前可以提前3-4天回家过年啦啦啦，开森撒……<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;今天是农历2014年最后一天坐班了，手头上的工作也基本完事儿了。终于可以坐下来安安心心的学习相关的比较深度的技术了。经过一番财务系统底层源代码的阅读后，决定来分析下HashMap与HashTable的区别与联系，以加深理解。</p>
<h2 id="HashTable"><a href="#HashTable" class="headerlink" title="HashTable"></a>HashTable</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过对 JDK 中 HashTable 的源码进行分析后，可以非常清楚的看到在其关键的方法中都加上了线程同步的关键字，这也就确定了 HashTable 的线程安全特性。即我们常常听到同事或其他开发人员讲的 HashTable 是线程安全的 Map 集合，但是不知道具体是体现在哪 *✧⁺˚⁺ପ(๑･ω･)੭ु⁾⁾ ……。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HashTable 继承了 Dictionary 类并实现 Map，Cloneable，Serializable 接口。在其中一些关于改变 hashtable 容量，以及元素比较，查询的关键方法中都进行了线程同步的处理。接下来我们具体分析其中的部分关键代码：<br>首先我们可以通过 put(K key, V value) 方法可以看到 HashTable 不可存储键或值为 null 的键值对数据，源代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Make sure the value is not null</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    Entry tab[] = table;</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            V old = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">if</span> (count &gt;= threshold) &#123;</span><br><span class="line">        <span class="comment">// Rehash the table if the threshold is exceeded</span></span><br><span class="line">        rehash();</span><br><span class="line"></span><br><span class="line">        tab = table;</span><br><span class="line">        hash = hash(key);</span><br><span class="line">        index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Creates the new entry.</span></span><br><span class="line">    Entry&lt;K,V&gt; e = tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    count++;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 put(K key, V value)，方法不能接受null值（key 或 value），所以 remove(Object key)  方法也不可以接受 null 值，源代码代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Entry tab[] = table;</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index], prev = <span class="keyword">null</span> ; e != <span class="keyword">null</span> ; prev = e, e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            modCount++;</span><br><span class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                prev.next = e.next;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tab[index] = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            count--;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次就是 HashTable 的迭代器实现了除 Iterator 之外的 Enumeration 接口，源代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Enumerator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Enumeration</span>&lt;<span class="title">T</span>&gt;, <span class="title">Iterator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">//省略部分代码</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           Entry&lt;K,V&gt; e = entry;</span><br><span class="line">           <span class="keyword">int</span> i = index;</span><br><span class="line">           Entry[] t = table;</span><br><span class="line">           <span class="comment">/* Use locals for faster loop iteration */</span></span><br><span class="line">           <span class="keyword">while</span> (e == <span class="keyword">null</span> &amp;&amp; i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               e = t[--i];</span><br><span class="line">           &#125;</span><br><span class="line">           entry = e;</span><br><span class="line">           index = i;</span><br><span class="line">           <span class="keyword">return</span> e != <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> T <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           Entry&lt;K,V&gt; et = entry;</span><br><span class="line">           <span class="keyword">int</span> i = index;</span><br><span class="line">           Entry[] t = table;</span><br><span class="line">           <span class="comment">/* Use locals for faster loop iteration */</span></span><br><span class="line">           <span class="keyword">while</span> (et == <span class="keyword">null</span> &amp;&amp; i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               et = t[--i];</span><br><span class="line">           &#125;</span><br><span class="line">           entry = et;</span><br><span class="line">           index = i;</span><br><span class="line">           <span class="keyword">if</span> (et != <span class="keyword">null</span>) &#123;</span><br><span class="line">               Entry&lt;K,V&gt; e = lastReturned = entry;</span><br><span class="line">               entry = e.next;</span><br><span class="line">               <span class="keyword">return</span> type == KEYS ? (T)e.key : (type == VALUES ? (T)e.value : (T)e);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException(<span class="string">"Hashtable Enumerator"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Iterator methods</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> hasMoreElements();</span><br><span class="line">       &#125;</span><br><span class="line"><span class="comment">//省略部分代码</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过对 JDK 中 HashMap 的源码进行分析后，我们可以看到其所有的公有方法都没有做线程同步相关的处理，这也意味着当我们使用 HashMap 的时候如果在多线程环境中可能会引发线程安全问题；<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HashMap 继承了 AbstractMap 类并实现 Map，Cloneable，Serializable 接口。接下来我们具体分析其中的部分关键代码：<br>首先我们可以通过 put(K key, V value) 方法可以看到 HashMap 可以存储键或值为 null 的键值对数据，源代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 put(K key, V value)，方法能接受null值（key 或 value），所以 remove(Object key)  方法也可以接受 null 值，源代码代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Entry&lt;K,V&gt; e = removeEntryForKey(key);</span><br><span class="line">        <span class="keyword">return</span> (e == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">removeEntryForKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : hash(key);</span><br><span class="line">        <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">        Entry&lt;K,V&gt; prev = table[i];</span><br><span class="line">        Entry&lt;K,V&gt; e = prev;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">            Object k;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                modCount++;</span><br><span class="line">                size--;</span><br><span class="line">                <span class="keyword">if</span> (prev == e)</span><br><span class="line">                    table[i] = next;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    prev.next = next;</span><br><span class="line">                e.recordRemoval(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            prev = e;</span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次就是 HashTable 的迭代器只实现了 Iterator 接口，源代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HashIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">//省略部分代码</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> next != <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">nextEntry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">           Entry&lt;K,V&gt; e = next;</span><br><span class="line">           <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> ((next = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">               Entry[] t = table;</span><br><span class="line">               <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>)</span><br><span class="line">                   ;</span><br><span class="line">           &#125;</span><br><span class="line">           current = e;</span><br><span class="line">           <span class="keyword">return</span> e;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (current == <span class="keyword">null</span>)</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">           <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">           Object k = current.key;</span><br><span class="line">           current = <span class="keyword">null</span>;</span><br><span class="line">           HashMap.<span class="keyword">this</span>.removeEntryForKey(k);</span><br><span class="line">           expectedModCount = modCount;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="区别与联系"><a href="#区别与联系" class="headerlink" title="区别与联系"></a>区别与联系</h2><p>通过以上的源码分析我们可以看到 HashTable 与 HashMap 有如下关系：<br>HashTable 和 HashMap 都实现了 Map，Cloneable，Serializable 接口规范。<br>它们的不同点如下：<br>1· HashTable 是基于线程安全的Map集合，而 HashMap 是线程不安全的Map集合；<br>2· HashTable 继承了 Dictionary 类，而 HashMap 继承了 AbstractMap 类；<br>3· HashTable 在数据存储方面是不支持 null 值（key 或 value），而 HashMap 可以存储 null 值（key 或 value）；<br>4· HashTable 的迭代器实现了 Enumeration，Iterator 接口，而 HashMap 的迭代器只实现了 Iterator 接口；<br>5· 由于 HashTable 的线程安全特性，本身的效率会低于 HashMap 的效率；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/18/%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/11/18/%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">选择排序算法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-11-18 12:22:11" itemprop="dateCreated datePublished" datetime="2014-11-18T12:22:11+08:00">2014-11-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;选择排序算法和冒泡排序算法一样也是使用蛮力法设计的简单的排序算法。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;选择排序算法开始的时候，扫描整个序列，找到整个序列的最小记录和序列中的第一个记录进行交换，从而将最小的记录放到它在有序区的最终位置上，然后在从第二个记录开始扫描序列，找到n-1个序列中的最小记录，再和第二个记录交换位置。依次类推知道最后一个记录。如下图所示：<img src='/uploads/select_sort_0.png' /></p>
<h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java 语言的两种选择排序实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectSort</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select_1</span><span class="params">(<span class="keyword">int</span>[] a)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> index;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">			index = i;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; a.length; j++) &#123;</span><br><span class="line">				<span class="keyword">if</span>(a[index] &gt; a[j])&#123;</span><br><span class="line">					index = j;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(index != i)&#123;</span><br><span class="line">				<span class="keyword">int</span> temp = a[index];</span><br><span class="line">				a[index] = a[i];</span><br><span class="line">				a[i] = temp;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select_2</span><span class="params">(<span class="keyword">int</span>[] a)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> position;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">			position = i;</span><br><span class="line">			<span class="keyword">int</span> temp = a[i];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; a.length; j++) &#123;</span><br><span class="line">				<span class="keyword">if</span>(temp &gt; a[j])&#123;</span><br><span class="line">					position = j;</span><br><span class="line">					temp = a[j];</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			a[position] = a[i];</span><br><span class="line">			a[i] = temp;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span>[] a = &#123;<span class="number">6</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">5</span>,<span class="number">9</span>&#125;;</span><br><span class="line">		SelectSort sort = <span class="keyword">new</span> SelectSort();</span><br><span class="line">		sort.select_1(a);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">			System.out.print(<span class="string">" "</span>+a[i]+<span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码的运行结果如下：<img src='/uploads/select_sort_1.png' /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/16/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/11/16/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">冒泡排序算法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-11-16 20:12:41" itemprop="dateCreated datePublished" datetime="2014-11-16T20:12:41+08:00">2014-11-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>898</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;冒泡排序算法是使用蛮力法设计的相对比较简单的排序算法。同时，冒泡排序算法也清晰的展现了蛮力法的设计思想。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;冒泡排序算法开始的时候扫描整个序列，在扫描过程中俩俩比较相邻记录，如果反序则交换，最终，最大记录就被“沉底”，即到了序列的最后一个位置，第二趟扫描将第二大记录“沉到”了倒数第二个位置，重复上述操作，直到 n - 1 趟扫描后，整个序列就完成了排序。如下图：<img src='/uploads/bubble_sort_0.png'/></p>
<h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以上原理的 java 代码实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@function</span> 冒泡排序算法实现逻辑</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> MaxSoft</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2014-11-16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSort</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span>[] arr)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;arr.length; i++)&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j=i+<span class="number">1</span>; j&lt;arr.length; j++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(arr[i] &gt; arr[j])&#123;</span><br><span class="line">					temp = arr[i];</span><br><span class="line">					arr[i] = arr[j];</span><br><span class="line">					arr[j] = temp;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span>[] arr = &#123;<span class="number">5</span>,<span class="number">9</span>,<span class="number">1</span>,<span class="number">7</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">6</span>&#125;;</span><br><span class="line">		BubbleSort bubble = <span class="keyword">new</span> BubbleSort();</span><br><span class="line">		bubble.sort(arr);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;arr.length; i++)&#123;</span><br><span class="line">			System.out.print(arr[i] + <span class="string">"  "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码的运行结果如下：<img src="/uploads/bubble_sort_1.png"/></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/14/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/11/14/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">快速排序算法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-11-14 12:15:11" itemprop="dateCreated datePublished" datetime="2014-11-14T12:15:11+08:00">2014-11-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 快速排序算法由C. A. R. Hoare在1962年提出的基于分治技术的重要排序算法。分治技术主要是讲一个难以直接解决的大问题，划分成一些规模较小的子问题，以便各个击破分而治之。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 快速排序算法的主要原理如下：<br>1&sdot;&nbsp;&nbsp;划分：选定一个记录作为轴值，以轴值为基准将整个序列划分为俩个子序列 A<sub>1</sub> … A<sub>i-1</sub> 和 A<sub>i+1</sub> …  A<sub>n</sub> ，轴值的位置 i 在划分的过程中确定，并且前一个子序列中记录的值均小于或等于轴值，后一个子序列中记录的值均大于或等于轴值；<br>2&sdot;&nbsp;&nbsp;求解子问题：分别对划分后的每一个子序列递归处理；<br>3&sdot;&nbsp;&nbsp;合并：由于对子序列 A<sub>1</sub> … A<sub>i-1</sub> 和 A<sub>i+1</sub> …  A<sub>n</sub> 的排序是就地进行的，所以合并并不需要执行任何操作；<br>如下图所示：<img src='/uploads/quick_sort_0.png' />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在快速排序中，轴值的选择应该遵循平衡子问题的原则，使划分后的俩个子序列的长度尽量相同「即<font color=red>划分的对称性</font>」，这是决定快速排序算法时间性能的关键。轴值的选择有很多方法，例如可以在划分之前，在序列中随机选出一个记录作为轴值，这样可以使轴值的选择是随机的，从而期望划分是较对称的。<br>例如，假设以第一个记录作为轴值，对待排序序列进行划分的过程为：<br>1&sdot;&nbsp;&nbsp;初始化：取第一个记录作为基准，设置俩个参数 i , j 分别用来指示将要与基准记录进行比较的左侧记录位置和右侧记录位置，也就是本次划分的区间。<img src='/uploads/quick_sort_1.png'/>2&sdot;&nbsp;&nbsp;右侧扫描过程：将基准记录与 j 指向的记录进行比较，如果 j 指向记录的关键码大，则 j 前移一个记录位置（即 j- -）。重复右侧扫描过程，直到右侧的记录小（即反序），若 i &lt; j ，则将基准记录与 j 指向的记录进行交换；<img src='/uploads/quick_sort_2.png'/>3&sdot;&nbsp;&nbsp;左侧扫描过程：将基准记录与 i 指向的记录进行比较，如果 i 指向记录的关键码小，则 i 后移一个记录位置（即 i+ + ）。重复左侧扫描过程，直到左侧的记录大（即反序），若 i &lt; j，则将基准记录与 i 指向的记录交换；<img src='/uploads/quick_sort_3.png'/>4&sdot;&nbsp;&nbsp;重复（2），（3）步骤，直到 i 与 j 指向同一位置，即基准记录最终的位置。<img src='/uploads/quick_sort_4.png'/></p>
<h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过以上原理分析后可以转化为以下代码实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@function</span> 快速排序算法Java代码实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> MaxSoft</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2014-11-14 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuickSort</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@function</span> 对排序目标对象进行划分组</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> target 待排序对象</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> left 划分组索引</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> right 划分组索引</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 轴值</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">part</span><span class="params">(<span class="keyword">int</span>[] target, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> temp = target[left];</span><br><span class="line">		<span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">			<span class="keyword">while</span> (left &lt; right &amp;&amp; target[right] &gt;= temp) &#123;</span><br><span class="line">				right--;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(left &lt; right)&#123;</span><br><span class="line">				target[left++] = target[right];</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">while</span> (left &lt; right &amp;&amp; target[left] &lt;= temp) &#123;</span><br><span class="line">				left++;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(left &lt; right)&#123;</span><br><span class="line">				target[right--] = target[left];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		target[left] = temp;</span><br><span class="line">		<span class="keyword">return</span> left;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(<span class="keyword">int</span>[] target, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(left&lt;right)&#123;</span><br><span class="line">			<span class="keyword">int</span> temp = part(target, left, right);</span><br><span class="line">			quickSort(target, left, temp - <span class="number">1</span>);</span><br><span class="line">			quickSort(target, temp + <span class="number">1</span>, right);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span>[] a = &#123;<span class="number">3</span>,<span class="number">9</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>&#125;;</span><br><span class="line">		QuickSort quickSort = <span class="keyword">new</span> QuickSort();</span><br><span class="line">		quickSort.quickSort(a, <span class="number">0</span>, a.length-<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;a.length; i++)&#123;</span><br><span class="line">			System.out.print(a[i] + <span class="string">"  "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上示例代码运行结果如下图：<img src='/uploads/quick_sort_5.png'></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/13/LRU%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/11/13/LRU%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">LRU算法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-11-13 16:15:11" itemprop="dateCreated datePublished" datetime="2014-11-13T16:15:11+08:00">2014-11-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LRU是Least Recently Used的缩写，即最近最久未使用，常用于页面置换算法，是为虚拟页式存储管理服务的。主要思想是在单位容量内，淘汰最近最久没有使用的数据。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在固定容量的容器中，把每次访问的数据加入到该容器中，如果在加入的过程中检查到该容器中已经存在要加入的数据，则将其挪到容器头部，如果没有检查到，且容器未满，则依次加入；如果容器已满则移除最先进入的数据后继续。<br>原理运行过程如下图：<img src='/uploads/lru_0.jpg' /></p>
<h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRU</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> CAPACITY = <span class="number">5</span>;</span><br><span class="line">	Object[] arr = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LRU</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		arr = <span class="keyword">new</span> Object[CAPACITY];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LRU</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(capacity != <span class="number">0</span>)&#123;</span><br><span class="line">			CAPACITY = capacity;</span><br><span class="line">			arr = <span class="keyword">new</span> Object[capacity];</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			arr = <span class="keyword">new</span> Object[CAPACITY];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@desc</span> 校验容器是否为空</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@desc</span> 校验容器是否已满</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOutOfBoundary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (size &gt;= CAPACITY) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@desc</span> 查找容器中是否存在要加入的数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">indexOfElements</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (o.equals(arr[i])) &#123;</span><br><span class="line">				<span class="keyword">return</span> i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@desc</span> 在容器中加入数据</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">push</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> temp = -<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (!isOutOfBoundary() &amp;&amp; indexOfElements(o) == -<span class="number">1</span>) &#123; <span class="comment">// 如果没有超出容量且没有找到数据</span></span><br><span class="line">			arr[size++] = o;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isOutOfBoundary() &amp;&amp; indexOfElements(o) == -<span class="number">1</span>) &#123; <span class="comment">// 如果超出容量且没有找到数据</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size - <span class="number">1</span>; i++) &#123;</span><br><span class="line">				arr[i] = arr[i + <span class="number">1</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			arr[size - <span class="number">1</span>] = o;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			temp = indexOfElements(o);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = temp; i &lt; size - <span class="number">1</span>; i++) &#123;</span><br><span class="line">				arr[i] = arr[i + <span class="number">1</span>];</span><br><span class="line">			&#125;</span><br><span class="line">			arr[size - <span class="number">1</span>] = o;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (temp == -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> o;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++)&#123;</span><br><span class="line">			System.out.print(arr[i] + <span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		LRU lru = <span class="keyword">new</span> LRU(<span class="number">5</span>);</span><br><span class="line">		<span class="keyword">int</span>[] a = &#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">7</span>&#125;;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">			lru.push(a[i]);</span><br><span class="line">			lru.show();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码的运行结果如下图：<img src='/uploads/lru_1.jpg' /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/09/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E7%9A%84%E4%B8%80%E8%88%AC%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/11/09/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E7%9A%84%E4%B8%80%E8%88%AC%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">算法设计的一般过程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-11-09 20:15:11" itemprop="dateCreated datePublished" datetime="2014-11-09T20:15:11+08:00">2014-11-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 收拾书架的时候看到了大学时学习的「算法设计与分析」，重新学习了一下算法设计的一般过程这个章节，感觉还是比较适用 <del>V</del>。</p>
<h2 id="算法设计的一般过程"><a href="#算法设计的一般过程" class="headerlink" title="算法设计的一般过程"></a>算法设计的一般过程</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法问题的解决方案，这个解决问题的方案本身并不是问题的答案，而是能获得答案的指令序列。不言而喻，由于实际问题千奇百怪，问题求解的方法千变万化，所以，算法的设计过程是一个灵活的充满智慧的过程，它要求设计人员根据实际情况具体问题具体分析。可以肯定的是，发明（或发现）算法是一个非常有创造性和值的付出精力的过程。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在设计算法时，遵循下列步骤可以在一定程度上指导算法的设计。</p>
<h3 id="理解问题"><a href="#理解问题" class="headerlink" title="理解问题"></a>理解问题</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在面对一个算法任务时，算法设计者往往不能准确的理解要求他做的是什么，对算法希望实现什么只有一个大致的想法就匆忙的落笔写算法，其后果往往是写出的算法漏洞百出。在设计算法时需要做的第一件事情是完全理解要解决的问题，仔细阅读问题的描述，手工处理一些小的用例。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对设计算法来说，这是一项重要的技能：准确的理解算法的输入是什么？要求算法做的是什么？即明确算法的入口和出口，这是设计算法的切入点。</p>
<h3 id="预测所有可能的输入"><a href="#预测所有可能的输入" class="headerlink" title="预测所有可能的输入"></a>预测所有可能的输入</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法的输入确定了该算法所解决问题的一个实例。一般而言，对于问题 P. 总有其相对应的实例集 I. 则算法 A 若是问题 P. 的算法，意味着把 P. 的任意一个实例 input ∈I. 作为算法 A. 的输入，都能得到问题 P. 的输出。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;预测算法所有可能的输入。包括合法的输入和非法的输出。事实上，无法保证一个算法（或程序）永远不会遇到一个错误的输入，一个对大部分输入都运行正确而只有一个输入不行的算法，就像一颗等待爆炸的炸弹。这绝不是危言耸听，有大量这种引起灾难性后果的案例。例如，许多年以前，整个 AT&amp;T 的长途电话网崩溃，造成了几十亿美元的直接损失。原因只是一段程序设计者认为他的代码能一直传送正确的参数值，可是有一天，一个不应该有的值作为参数传递了，导致了整个北美电话系统的崩溃。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果养成习惯——首先考虑问题和他的数据，然后列举出算法必须处理的所有特殊情况，那么可以更快速的成功构造算法。</p>
<h3 id="在精确解和近似解间做选择"><a href="#在精确解和近似解间做选择" class="headerlink" title="在精确解和近似解间做选择"></a>在精确解和近似解间做选择</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;计算机科学的研究目标是用计算机来求解人类所面临的各种问题。但是，有些问题无法求得精确解，例如求平方根、解非线性方程、求定积分等，有些问题由于其固有的复杂性，求精确解需要花费太多的时间，其中最著名的要算旅行商问题（即 TSP 问题，是指旅行家要旅行 n 个城市，要求经理各个城市且仅经历一次，并要求所走的路程最短），此时，只能求出近似解。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有时需要根据问题以及问题所受的资源限制，在精确解和近似解间做选择。</p>
<h3 id="确定适当的数据结构"><a href="#确定适当的数据结构" class="headerlink" title="确定适当的数据结构"></a>确定适当的数据结构</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在结构化的程序设计时代，著名的计算机学者沃斯（Wirth）提出了“算法 + 数据结构 = 程序”的观点，断言了算法和数据结构是构成计算机程序的重要基础。在面向对象的程序设计时代，数据结构对于算法设计和分析任然是至关重要的。本书所讨论的很多算法设计技术都是基于精心设计的数据结构。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确定数据结构通常包括对问题实例的数据进行组织和重构，以及完成算法所设计的辅助数据结构，在很多情况下，数据结构的设计直接影响基于该结构之上设计的算法的时间性能。</p>
<h3 id="算法设计技术"><a href="#算法设计技术" class="headerlink" title="算法设计技术"></a>算法设计技术</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在，设计算法的必要条件都已经具备了，如何设计一个算法来解决一个特定的问题呢？这正是本书讨论的主题。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法设计技术（algorithm design technique, 也称算法设计策略）是设计算法的一般性方法，可用于解决不同计算领域的多种问题。本书讨论的算法设计技术已经被证明是对算法设计非常有用的通用技术，包括蛮力法、分治法、减治法、动态规划法、贪心法、回溯法，分支限界法、概率算法、近似算法等。这些算法设计技术构成了一组强有力的工具，在为新问题（即没有令人满意的已知算法可以解决的问题）设计算法时，可以运用这些技术设计出新的算法。算法设计技术作为问题求解的一般性策略，在解决计算机领域以外的问题时，也能发挥相当大的作用，读者在日后的学习和工作中将会发现学习算法设计技术的好处。</p>
<h3 id="描述算法"><a href="#描述算法" class="headerlink" title="描述算法"></a>描述算法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在构思和设计了一个算法之后，必须清楚准确的将所设计的求解步骤记录下载，即描述算法。描述算法的常用方法有自然语言，流程图，程序设计语言和伪代码等，其中伪代码是比较合适的描述算法的方法。</p>
<h3 id="跟踪算法"><a href="#跟踪算法" class="headerlink" title="跟踪算法"></a>跟踪算法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;逻辑错误无法由计算机检测出来，因为计算机只会执行程序，而不会理解动机。经验和研究都表明，发现算法（或程序）中的逻辑错误的重要方法就是系统地跟踪算法。跟踪必须要用“心和手”来进行，跟踪者要像计算机一样，用一组输入值来执行该算法，并且这组输入值要最大可能的暴露算法中的错误。即使有十年经验的高级软件工程师，也经常使用该方法查找算法中的逻辑错误。</p>
<h3 id="分析算法的效率"><a href="#分析算法的效率" class="headerlink" title="分析算法的效率"></a>分析算法的效率</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法有俩种效率：时间效率和空间效率，时间效率显示了算法运行的有多快，空间效率则显示了算法需要多少额外的存储空间，相比而言，我们更加关注算法的时间效率。事实上，计算机所有应用问题，包括计算机自身的发展，都是围绕着“时间——速度”这样一个中心进行的。一般来说，一个好的算法首先应该是比同类算法的时间效率高，算法的时间效率用时间复杂度性来度量。</p>
<h3 id="根据算法编写代码"><a href="#根据算法编写代码" class="headerlink" title="根据算法编写代码"></a>根据算法编写代码</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现代计算机技术还不能讲伪代码形式的算法直接“输入”进计算机中，而需要把算法转变为特定的程序设计语言编写的程序，算法中的一条指令可能对应实际程序中的多条指令。在把算法转变为程序的过程中，虽然现代编译器提供了代码优化功能，但仍需要一些标准的技巧，比如，在循环之外计算循环中的不变式、合并公共子表达式、用开销低的操作替代开销高的操作等。一般来说，这样的优化对算法速度的影响是一个常数因子，可能会使程序提高10% ~ 50% 的速度。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;算法设计的一般过程如 图 1. 所示。需要强调的是，一个好的算法是反复努力和重新修正的结果，所以，即使幸运的得到了一个貌似完美的算法，也应该尝试的改进它，那么，什么时候应该停止这种改进呢？设计算法是一种工程行为，需要在资源有限的情况下，在互斥的目标之间进行权衡。设计者的时间显然也是一种资源，在实际应用中，常常是项目进度表迫使我们停止改进算法。<br><img src="/uploads/2014-11-09-01.png" title="图 1. 算法设计的一般过程" /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/08/29/Tomcat%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/08/29/Tomcat%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">Tomcat配置总结</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-08-29 15:20:31" itemprop="dateCreated datePublished" datetime="2014-08-29T15:20:31+08:00">2014-08-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index">
                    <span itemprop="name">Web容器</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Tomcat-简介"><a href="#Tomcat-简介" class="headerlink" title="Tomcat 简介"></a>Tomcat 简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tomcat是Apache 软件基金会（Apache Software Foundation）的一个核心项目，主要由Apache组织、Sun 公司开发而成。在Tomcat中最新的Servlet 和JSP规范总是能得到很好的体现，主要原因大概就是Tomcat的发展历程有Sun的提倡和参与建立。由于Tomcat性能相对较稳定，技术也相对比较新且免费开源；是当前相对比较流行的Web容器。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tomcat 的配置文件是一个格式化的XML文档，所有配置信息都在conf/server.xml文件中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8085"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JasperListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span>  <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span> </span></span><br><span class="line"><span class="tag">		<span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span>  <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">maxPostSize</span>=<span class="string">"5120000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8089"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span>  <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span>  <span class="attr">prefix</span>=<span class="string">"localhost_access_log."</span> <span class="attr">suffix</span>=<span class="string">".txt"</span> <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以下简单介绍几个常用的配置标签以及属性。</p>
<h3 id="Server标签"><a href="#Server标签" class="headerlink" title="Server标签"></a>Server标签</h3><p><font color=red><b>Server</b></font>标签代表了整个Catalina servlet容器。 因此，它必须是conf/server.xml配置文件中的单个根标签。 其属性代表了整个servlet容器所具有的特性。<br>基本属性如下：<br>&nbsp;&nbsp;1&gt; <font color=red><b>className</b></font> ：值为Java实现类的名称。 这个类必须实现org.apache.catalina.Server接口。 如果没有指定类名，则使用标准实现类名称（Server的标准实现是org.apache.catalina.core.StandardServer）。<br>&nbsp;&nbsp;2&gt; <font color=red><b>address</b></font> ：值为服务器等待关机命令的TCP / IP地址。 如果没有指定地址，则使用localhost地址。<br>&nbsp;&nbsp;3&gt; <font color=red><b>port</b></font> ：值为服务器等待关机命令的TCP / IP端口号。 设置值为-1则，禁用关闭端口。<br>&nbsp;&nbsp;4&gt; <font color=red><b>shutdown</b></font> ：值为通过TCP / IP连接接收到指定端口号的命令字符串来关闭Tomcat</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	... // 其他配置</span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Service标签"><a href="#Service标签" class="headerlink" title="Service标签"></a>Service标签</h3><p><font color=red><b>Service</b></font>标签表示一个或多个连接器组件的组合，这些组件共享一个用于处理传入请求的引擎组件。 一个或多个Service标签可以嵌套在Server标签中。<br>基本属性如下：<br>&nbsp;&nbsp;1&gt; <font color=red><b>className</b></font> ：值为Java实现类的名称。 这个类必须实现org.apache.catalina.Service接口。 如果没有指定类名，则使用标准实现（Service的标准实现是org.apache.catalina.core.StandardService）。<br>&nbsp;&nbsp;2&gt; <font color=red><b>name</b></font> ：值为服务的显示名称，如果您使用标准Catalina组件，将包含在日志消息中。 与特定服务器关联的每个服务的名称必须是唯一的。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Executor标签"><a href="#Executor标签" class="headerlink" title="Executor标签"></a>Executor标签</h3><p><font color=red><b>Executor</b></font>表示可以在Tomcat中的组件之间共享的线程池。 虽然每个连接器都可以创建了一个线程池，但是我们也可以在多个连接器之间共享一个线程池。执行线程的执行者必须实现org.apache.catalina.Executor接口。执行程序是Service标签的嵌套标签。 为了让连接器获取它，Executor标签必须配置在server.xml中的Connector标签之前<br>基本属性如下：<br>&nbsp;&nbsp;1&gt; <font color=red><b>className</b></font> ：值为Java实现类名，该类必须实现org.apache.catalina.Executor接口。 该接口确保对象可以通过其名称属性进行引用，并实现生命周期，以便可以使用容器启动和停止该对象。 (className的默认值是org.apache.catalina.core.StandardThreadExecutor)<br>&nbsp;&nbsp;2&gt; <font color=red><b>name</b></font> ：值为用于在server.xml中的其他位置引用此池的名称。 该名称是必填项，并且是全局唯一的。</p>
<p>默认的实现类（org.apache.catalina.core.StandardThreadExecutor）支持如下属性：<br>&nbsp;&nbsp;1&gt; <font color=red><b>threadPriority</b></font> ：(Integer)线程优先级，默认为5(Thread.NORM_PRIORITY常量的值)<br>&nbsp;&nbsp;2&gt; <font color=red><b>daemon</b></font> ：(Boolean)线程是否为守护线程，默认是true<br>&nbsp;&nbsp;3&gt; <font color=red><b>namePrefix</b></font> ：(String)线程的名称前缀。格式(namePrefix + threadNumber)<br>&nbsp;&nbsp;4&gt; <font color=red><b>maxThreads</b></font> ：(Integer)线程池中活动线程的最大数量，默认值为200<br>&nbsp;&nbsp;5&gt; <font color=red><b>minSpareThreads</b></font> ：(Integer)始终保持活动状态的线程的最小数量，默认值为25<br>&nbsp;&nbsp;6&gt; <font color=red><b>maxIdleTime</b></font> ：(Integer)空闲线程关闭之前的毫秒数，默认值是60000ms<br>&nbsp;&nbsp;7&gt; <font color=red><b>maxQueueSize</b></font> ：(Integer)排队等待执行的最大可运行任务数。 默认值是Integer.MAX_VALUE<br>&nbsp;&nbsp;8&gt; <font color=red><b>prestartminSpareThreads</b></font> ：(Boolean)启动Executor时是否启动minSpareThreads，默认是false<br>&nbsp;&nbsp;9&gt; <font color=red><b>threadRenewalDelay</b></font> ：(Long)如果配置了ThreadLocalLeakPreventionListener，它会通知这个执行者关于停止的上下文。 上下文停止后，池中的线程将被更新。 为了避免同时更新所有的线程，这个选项设置了更新任何2个线程之间的延迟。 该值以毫秒为单位，默认值为1000毫秒。 如果值是负数，线程不会被更新。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">		...</span><br><span class="line">		<span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">"maxsoftThreadPool"</span> <span class="attr">namePrefix</span>=<span class="string">"maxsoft-exec-"</span>  <span class="attr">maxThreads</span>=<span class="string">"100"</span> <span class="attr">minSpareThreads</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line">		...</span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Connector标签之HTTP协议"><a href="#Connector标签之HTTP协议" class="headerlink" title="Connector标签之HTTP协议"></a>Connector标签之HTTP协议</h3><p><font color=red><b>HTTP</b></font>连接器标签表示支持HTTP / 1.1协议的连接器组件。 它使Catalina除了能够执行servlet和JSP页面外，还可以作为独立的Web服务器。 此组件的特定实例将监听服务器上特定TCP端口号的连接。 一个或多个这样的连接器可以配置为单个服务的一部分，每个连接器都可以转发给关联的引擎执行请求处理并创建响应。<br>连接器的所有实现都支持以下属性：<br>&nbsp;&nbsp;1&gt; <font color=red><b>allowTrace</b></font>：用于启用或禁用TRACE方法，默认值为false<br>&nbsp;&nbsp;2&gt; <font color=red><b>asyncTimeout</b></font>：异步请求的默认超时时间(毫秒)，默认值为10000ms<br>&nbsp;&nbsp;3&gt; <font color=red><b>enableLookups</b></font>：配置是否需要调用request.getRemoteHost()来执行DNS查找并返回远程客户端的实际主机名。默认值为false(以字符串形式返回IP地址)<br>&nbsp;&nbsp;4&gt; <font color=red><b>maxHeaderCount</b></font>：容器允许的最大请求头数，默认值100<br>&nbsp;&nbsp;5&gt; <font color=red><b>maxParameterCount</b></font>：参数和值对（GET和POST）的最大数量将由容器自动解析，如果超出此限制的参数和值对将被忽略。 小于0的值意味着没有限制。 默认值为10000<br>&nbsp;&nbsp;6&gt; <font color=red><b>maxPostSize</b></font>：将由容器FORM URL参数分析处理的POST的最大字节数。 通过将此属性设置为小于零的值可以禁用限制。 默认值为2097152（2MB）。<br>&nbsp;&nbsp;7&gt; <font color=red><b>maxSavePostSize</b></font>：在FORM或CLIENT-CERT身份验证期间，容器将保存/缓存的POST的最大数据（单位KB）。 对于这两种身份验证，POST都将在用户通过身份验证之前保存/缓存。 对于CLIENT-CERT认证，POST在SSL握手期间被缓冲，并且在请求被处理时清空缓冲器。 对于FORM认证，当用户被重定向到登录表单时，POST被保存，并保留到用户成功认证或与认证请求关联的会话过期。 可以通过将此属性设置为-1来禁用限制。 将该属性设置为零将禁用在验证过程中保存POST数据。 默认值为4096（4kb）。<br>&nbsp;&nbsp;8&gt; <font color=red><b>parseBodyMethods</b></font>：一个用逗号分隔的HTTP方法列表，为其请求参数将被解析为与POST相同的请求参数。 这对于希望支持PUT请求的POST风格语义的RESTful应用程序非常有用。 注意，除POST之外的任何设置都会导致Tomcat的行为违背了servlet规范的意图。 根据HTTP规范，这里特别禁止HTTP方法TRACE。 默认值POST<br>&nbsp;&nbsp;9&gt; <font color=red><b>port</b></font>：TCP端口号，如果设置为0，则Tomcat将随机选择一个空闲端口用于该连接器。<br>&nbsp;&nbsp;10&gt; <font color=red><b>protocol</b></font>：设置协议类别，默认是HTTP/1.1。它使用自动切换机制来选择阻塞的基于Java的连接器或基于APR /本机的连接器。如果PATH（Windows）或LD_LIBRARY_PATH（在大多数unix系统上）环境变量包含Tomcat本机库，则将使用APR /本机连接器。如果找不到本地库，将使用阻塞的基于Java的连接器。请注意，APR /本机连接器具有与Java连接器不同的HTTPS设置。<br>为了使用明确的协议而不是依靠上述的自动切换机制，可以使用以下值：<br>org.apache.coyote.http11.Http11Protocol - 阻止Java连接器<br>org.apache.coyote.http11.Http11NioProtocol - 非阻塞的Java连接器<br>org.apache.coyote.http11.Http11AprProtocol - APR /本地连接器。<br>&nbsp;&nbsp;11&gt; <font color=red><b>proxyName</b></font>：代理服务器名称。如果在代理配置中使用该连接器，则配置该属性是要指定要调用request.getServerName()时要返回的服务器名称。<br>&nbsp;&nbsp;12&gt; <font color=red><b>proxyPort</b></font>：代理服务端口。如果在代理配置中使用该连接器，则配置该属性是要指定要调用request.getServerPort()时要返回的服务器端口号。<br>&nbsp;&nbsp;13&gt; <font color=red><b>redirectPort</b></font>：重定向端口。如果该连接器支持非SSL请求，并且收到匹配的<security-constraint>需要SSL传输的请求，Catalina将自动将请求重定向到此处指定的端口号。<br>&nbsp;&nbsp;14&gt; <font color=red><b>scheme</b></font>：协议名称。可以通过调用request.getScheme()返回协议的名称。 默认值是HTTP。<br>&nbsp;&nbsp;15&gt; <font color=red><b>secure</b></font>：是否加密。如果您希望调用request.isSecure（）以对此连接器接收到的请求返回true，请将此属性设置为true。 您可能希望在SSL连接器或从SSL加速器接收数据的非SSL连接器（如加密卡，SSL设备甚至Web服务器）上使用此连接器。 默认值是false。<br>&nbsp;&nbsp;16&gt; <font color=red><b>URIEncoding</b></font>：设置用于解码URI字节的字符编码，在％xx解码URL之后。 默认值是ISO-8859-1。<br>&nbsp;&nbsp;17&gt; <font color=red><b>useBodyEncodingForURI</b></font>：这指定了contentType中指定的编码是否应该用于URI查询参数，而不是使用URIEncoding。 此设置用于与Tomcat 4.1.x兼容，其中contentType中指定的编码或使用Request.setCharacterEncoding方法显式设置的编码也用于URL中的参数。 默认值是false。<br>&nbsp;&nbsp;18&gt; <font color=red><b>useIPVHosts</b></font>：将此属性设置为true可使Tomcat使用收到请求的IP地址来确定发送请求的主机。 默认值是false。<br>&nbsp;&nbsp;19&gt; <font color=red><b>xpoweredBy</b></font>：将此属性设置为true，以使Tomcat通过使用规范中建议的头部进行对Servlet规范的支持。 默认值是false。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">		...</span><br><span class="line">		<span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">"maxsoftThreadPool"</span> <span class="attr">namePrefix</span>=<span class="string">"maxsoft-exec-"</span>  <span class="attr">maxThreads</span>=<span class="string">"100"</span> <span class="attr">minSpareThreads</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">maxPostSize</span>=<span class="string">"5120000"</span>  <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span>/&gt;</span></span><br><span class="line">		...</span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>标准HTTP连接器（BIO，NIO和APR / native）除了上面列出的常见连接器属性外，还支持以下属性：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#Standard_Implementation" target="_blank" rel="noopener">标准HTTP连接器属性</a></p>
<p>除了上面列出的通用连接器和HTTP属性外，BIO和NIO实现还支持以下Java TCP套接字属性：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#Java_TCP_socket_attributes" target="_blank" rel="noopener">BIO和NIO实现支持属性</a></p>
<p>以下属性是特定于BIO连接器的：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#BIO_specific_configuration" target="_blank" rel="noopener">特定于BIO连接器属性</a></p>
<p>以下属性是特定于NIO连接器的：<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#NIO_specific_configuration" target="_blank" rel="noopener">特定于NIO连接器属性</a></p>
<p>以下属性是特定于APR /本机连接器:<br>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html#APR/native_specific_configuration" target="_blank" rel="noopener">特定于APR /本机连接器属性</a></p>
<p>详情移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/http.html" target="_blank" rel="noopener">HTTP连接器</a></p>
<h3 id="Connector标签之AJP协议"><a href="#Connector标签之AJP协议" class="headerlink" title="Connector标签之AJP协议"></a>Connector标签之AJP协议</h3><p><font color=red><b>AJP</b></font>连接器标签表示一个连接器组件，通过AJP协议与Web连接器进行通信。 这适用于将Tomcat无形集成到现有（或新的）Apache安装中的情况，并希望Apache处理Web应用程序中包含的静态内容和/或使用Apache的SSL处理。该连接器在与引擎的jvmRoute属性结合使用时支持负载平衡。<br>其配置属性基本和HTTP类似，详情可以移步：<a href="http://tomcat.apache.org/tomcat-7.0-doc/config/ajp.html" target="_blank" rel="noopener">AJP连接器</a></p>
<h3 id="Engine标签"><a href="#Engine标签" class="headerlink" title="Engine标签"></a>Engine标签</h3><p><font color=red><b>Engine</b></font>标签表示与特定的Catalina服务相关联的整个请求处理机器。 它接收并处理来自一个或多个连接器的所有请求，并将完成的响应返回给连接器，以便最终传输回客户端。一个引擎标签必须嵌套在一个Service标签内，跟随与这个Service相关的所有对应的Connector标签。</p>
<p>引擎的所有实现都支持以下属性：<br>&nbsp;&nbsp;1&gt; <font color=red><b>backgroundProcessorDelay</b></font>：该值表示调用该引擎上的backgroundProcess方法与其子容器（包括所有主机和上下文）之间的延迟（以秒为单位）。 如果子容器的延迟值不是负数（这意味着他们正在使用自己的处理线程），子容器将不会被调用。 将其设置为正值将导致线程产生。 等待指定的时间后，线程将调用该引擎及其所有子容器上的backgroundProcess方法。 默认值为10，表示延迟10秒。<br>&nbsp;&nbsp;2&gt; <font color=red><b>className</b></font>：值为Java实现类的名称。 这个类必须实现org.apache.catalina.Engine接口。默认是为标准实现类（Engine的标准实现是org.apache.catalina.core.StandardEngine）。<br>&nbsp;&nbsp;3&gt; <font color=red><b>defaultHost</b></font>：默认主机名，用于标识将处理指向该服务器上主机名称但未在此配置文件中配置的请求的主机。 这个名字必须匹配其中一个嵌套的主机元素的名字属性。<br>&nbsp;&nbsp;4&gt; <font color=red><b>jvmRoute</b></font>：必须在负载平衡场景中使用的标识符才能启用会话共享。 该标识符必须在参与群集的所有Tomcat服务器中唯一，它将被附加到生成的会话标识符中，因此允许前端代理始终将特定会话转发到同一个Tomcat实例。注意，jvmRoute也可以使用jvmRoute系统属性进行设置。 在<Engine>属性中设置的jvmRoute将覆盖任何jvmRoute系统属性。<br>&nbsp;&nbsp;5&gt; <font color=red><b>name</b></font>：该引擎的逻辑名称，用于日志和错误消息。 在同一服务器中使用多个服务标签时，每个引擎必须分配一个唯一的名称。<br>&nbsp;&nbsp;6&gt; <font color=red><b>startStopThreads</b></font>：该引擎将用于并行启动子主机标签的线程数，默认值是1。</p>
<p>配置示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.StandardServer"</span> <span class="attr">address</span>=<span class="string">"192.168.0.8"</span> <span class="attr">port</span>=<span class="string">"8008"</span> <span class="attr">shundown</span>=<span class="string">"-1"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--&lt;Service name="Catalina" className="org.apache.catalina.core.StandardService"&gt; &lt;/Service&gt;--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.MaxSoftService"</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"MaxSoft"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">		... </span><br><span class="line">	  <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><a href="http://tomcat.apache.org/tomcat-7.0-doc/config/engine.html" target="_blank" rel="noopener">详细配置</a></p>
<h3 id="Host标签"><a href="#Host标签" class="headerlink" title="Host标签"></a>Host标签</h3><p>Host标签表示一个虚拟主机，它是一个服务器的网络名称（如“<a href="http://www.maxsoft.org”）与运行Tomcat的特定服务器的关联。" target="_blank" rel="noopener">www.maxsoft.org”）与运行Tomcat的特定服务器的关联。</a></p>
<p>主机的所有实现都支持以下属性：</p>
<p>&nbsp;&nbsp;1&gt; <font color=red><b>appBase</b></font>：该虚拟主机的应用程序根目录，默认值是webapps<br>&nbsp;&nbsp;2&gt; <font color=red><b>xmlBase</b></font>：该虚拟主机的XML的根目录，默认值是conf / <engine_name> / <host_name>的值。<br>&nbsp;&nbsp;3&gt; <font color=red><b>createDirs</b></font>：默认值是true。Tomcat尝试在启动阶段创建由属性appBase和xmlBase定义的目录。<br>&nbsp;&nbsp;4&gt; <font color=red><b>autoDeploy</b></font>：该值指示Tomcat是否应在Tomcat运行时定期检查新的或更新的Web应用程序。 默认值为true。<br>&nbsp;&nbsp;4&gt; <font color=red><b>backgroundProcessorDelay</b></font>：该值表示在该主机上调用backgroundProcess方法与其子容器（包括所有上下文）之间的延迟（以秒为单位）。默认值为-1<br>&nbsp;&nbsp;5&gt; <font color=red><b>className</b></font>：该值为Java实现类的名称，这个类必须实现org.apache.catalina.Host接口。默认值标准实现（org.apache.catalina.core.StandardHost）<br>&nbsp;&nbsp;6&gt; <font color=red><b>deployIgnore</b></font>：用于定义在设置autoDeploy和deployOnStartup时要忽略的路径<br>&nbsp;&nbsp;7&gt; <font color=red><b>deployOnStartup</b></font>：该值指示在Tomcat启动时是否应自动部署此主机的Web应用程序。默认为true<br>&nbsp;&nbsp;8&gt; <font color=red><b>failCtxIfServletStartFails</b></font>：每个子上下文可以覆盖这个属性，默认值为false<br>&nbsp;&nbsp;9&gt; <font color=red><b>name</b></font>：虚拟主机的网络名称。<br>&nbsp;&nbsp;10&gt; <font color=red><b>startStopThreads</b></font>：该主机将用于并行启动子上下文元素的线程数。默认值为1<br>&nbsp;&nbsp;11&gt; <font color=red><b>undeployOldVersions</b></font>：该值作为自动部署过程的一部分的Tomcat是否将检查使用并行部署部署的旧的，未使用的Web应用程序版本，如果找到，则将其删除。 该值仅适用于autoDeploy为true的情况，默认值false。</p>
<p><a href="http://tomcat.apache.org/tomcat-7.0-doc/config/host.html" target="_blank" rel="noopener">详细配置</a></p>
<p>More info: <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat Home</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/08/10/%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%20Java%20IO%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/08/10/%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%20Java%20IO%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">深入分析 Java I/O 的工作机制</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-08-10 20:01:11" itemprop="dateCreated datePublished" datetime="2014-08-10T20:01:11+08:00">2014-08-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%AC%E8%BD%BD/" itemprop="url" rel="index">
                    <span itemprop="name">转载</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Java-的-I-O-类库的基本架构"><a href="#Java-的-I-O-类库的基本架构" class="headerlink" title="Java 的 I/O 类库的基本架构"></a>Java 的 I/O 类库的基本架构</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I/O 问题是任何编程语言都无法回避的问题，可以说 I/O 问题是整个人机交互的核心问题，因为 I/O 是机器获取和交换信息的主要渠道。在当今这个数据大爆炸时代，I/O 问题尤其突出，很容易成为一个性能瓶颈。正因如此，所以 Java 在 I/O 上也一直在做持续的优化，如从 1.4 开始引入了 NIO，提升了 I/O 的性能。关于 NIO 我们将在后面详细介绍。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Java 的 I/O 操作类在包 java.io 下，大概有将近 80 个类，但是这些类大概可以分成四组，分别是：<br>1&sdot;&nbsp;基于字节操作的 I/O 接口：InputStream 和 OutputStream<br>2&sdot;&nbsp;基于字符操作的 I/O 接口：Writer 和 Reader<br>3&sdot;&nbsp;基于磁盘操作的 I/O 接口：File<br>4&sdot;&nbsp;基于网络操作的 I/O 接口：Socket<br>前两组主要是根据传输数据的数据格式，后两组主要是根据传输数据的方式，虽然 Socket 类并不在 java.io 包下，但是我仍然把它们划分在一起，因为我个人认为 I/O 的核心问题要么是数据格式影响 I/O 操作，要么是传输方式影响 I/O 操作，也就是将什么样的数据写到什么地方的问题，I/O 只是人与机器或者机器与机器交互的手段，除了在它们能够完成这个交互功能外，我们关注的就是如何提高它的运行效率了，而数据格式和传输方式是影响效率最关键的因素了。我们后面的分析也是基于这两个因素来展开的。</p>
<h2 id="基于字节的-I-O-操作接口"><a href="#基于字节的-I-O-操作接口" class="headerlink" title="基于字节的 I/O 操作接口"></a>基于字节的 I/O 操作接口</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基于字节的 I/O 操作接口输入和输出分别是：InputStream 和 OutputStream，InputStream 输入流的类继承层次如下图所示：<br>图 1. InputStream 相关类层次结构<br><img src='/uploads/ibm_2014-08-10-1.png'/>输入流根据数据类型和操作方式又被划分成若干个子类，每个子类分别处理不同操作类型，OutputStream 输出流的类层次结构也是类似，如下图所示：<br><img src='/uploads/ibm_2014-08-10-2.png'/>这里就不详细解释每个子类如何使用了，如果不清楚的话可以参考一下 JDK 的 API 说明文档，这里只想说明两点，一个是操作数据的方式是可以组合使用的，如这样组合使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutputStream out = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"fileName"</span>))</span><br></pre></td></tr></table></figure>
<p>还有一点是流最终写到什么地方必须要指定，要么是写到磁盘要么是写到网络中，其实从上面的类图中我们发现，写网络实际上也是写文件，只不过写网络还有一步需要处理就是底层操作系统再将数据传送到其它地方而不是本地磁盘。关于网络 I/O 和磁盘 I/O 我们将在后面详细介绍。</p>
<h2 id="基于字符的-I-O-操作接口"><a href="#基于字符的-I-O-操作接口" class="headerlink" title="基于字符的 I/O 操作接口"></a>基于字符的 I/O 操作接口</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不管是磁盘还是网络传输，最小的存储单元都是字节，而不是字符，所以 I/O 操作的都是字节而不是字符，但是为啥有操作字符的 I/O 接口呢？这是因为我们的程序中通常操作的数据都是以字符形式，为了操作方便当然要提供一个直接写字符的 I/O 接口，如此而已。我们知道字符到字节必须要经过编码转换，而这个编码又非常耗时，而且还会经常出现乱码问题，所以 I/O 的编码问题经常是让人头疼的问题。关于 I/O 编码问题请参考另一篇文章<a href="https://www.ibm.com/developerworks/cn/java/j-lo-chinesecoding/" target="_blank" rel="noopener">《深入分析Java中的中文编码问题》</a>。<br>下图是写字符的 I/O 操作接口涉及到的类，Writer 类提供了一个抽象方法 write(char cbuf[], int off, int len) 由子类去实现。<br>图 3. Writer 相关类层次结构<img src='/uploads/ibm_2014-08-10-3.png'/>读字符的操作接口也有类似的类结构，如下图所示：<br>图 4.Reader 类层次结构<img src='/uploads/ibm_2014-08-10-4.png'/>读字符的操作接口中也是 int read(char cbuf[], int off, int len)，返回读到的 n 个字节数，不管是 Writer 还是 Reader 类它们都只定义了读取或写入的数据字符的方式，也就是怎么写或读，但是并没有规定数据要写到哪去，写到哪去就是我们后面要讨论的基于磁盘和网络的工作机制。</p>
<h2 id="字节与字符的转化接口"><a href="#字节与字符的转化接口" class="headerlink" title="字节与字符的转化接口"></a>字节与字符的转化接口</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外数据持久化或网络传输都是以字节进行的，所以必须要有字符到字节或字节到字符的转化。字符到字节需要转化，其中读的转化过程如下图所示：<br>图 5. 字符解码相关类结构<img src='/uploads/ibm_2014-08-10-5.jpg'/>InputStreamReader 类是字节到字符的转化桥梁，InputStream 到 Reader 的过程要指定编码字符集，否则将采用操作系统默认字符集，很可能会出现乱码问题。StreamDecoder 正是完成字节到字符的解码的实现类。也就是当你用如下方式读取一个文件时：<br>清单 1.读取文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">           StringBuffer str = <span class="keyword">new</span> StringBuffer(); </span><br><span class="line">           <span class="keyword">char</span>[] buf = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">1024</span>]; </span><br><span class="line">           FileReader f = <span class="keyword">new</span> FileReader(<span class="string">"file"</span>); </span><br><span class="line">           <span class="keyword">while</span>(f.read(buf)&gt;<span class="number">0</span>)&#123; </span><br><span class="line">               str.append(buf); </span><br><span class="line">           &#125; </span><br><span class="line">           str.toString(); </span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>FileReader 类就是按照上面的工作方式读取文件的，FileReader 是继承了 InputStreamReader 类，实际上是读取文件流，然后通过 StreamDecoder 解码成 char，只不过这里的解码字符集是默认字符集。<br>写入也是类似的过程如下图所示：<br>图 6. 字符编码相关类结构<img src='/uploads/ibm_2014-08-10-6.jpg'/>通过 OutputStreamWriter 类完成，字符到字节的编码过程，由 StreamEncoder 完成编码过程</p>
<h2 id="磁盘-I-O-工作机制"><a href="#磁盘-I-O-工作机制" class="headerlink" title="磁盘 I/O 工作机制"></a>磁盘 I/O 工作机制</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前面介绍了基本的 Java I/O 的操作接口，这些接口主要定义了如何操作数据，以及介绍了操作两种数据结构：字节和字符的方式。还有一个关键问题就是数据写到何处，其中一个主要方式就是将数据持久化到物理磁盘，下面将介绍如何将数据持久化到物理磁盘的过程。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们知道数据在磁盘的唯一最小描述就是文件，也就是说上层应用程序只能通过文件来操作磁盘上的数据，文件也是操作系统和磁盘驱动器交互的一个最小单元。值得注意的是 Java 中通常的 File 并不代表一个真实存在的文件对象，当你通过指定一个路径描述符时，它就会返回一个代表这个路径相关联的一个虚拟对象，这个可能是一个真实存在的文件或者是一个包含多个文件的目录。为何要这样设计？因为大部分情况下，我们并不关心这个文件是否真的存在，而是关心这个文件到底如何操作。例如我们手机里通常存了几百个朋友的电话号码，但是我们通常关心的是我有没有这个朋友的电话号码，或者这个电话号码是什么，但是这个电话号码到底能不能打通，我们并不是时时刻刻都去检查，而只有在真正要给他打电话时才会看这个电话能不能用。也就是使用这个电话记录要比打这个电话的次数多很多。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;何时真正会要检查一个文件存不存？就是在真正要读取这个文件时，例如 FileInputStream 类都是操作一个文件的接口，注意到在创建一个 FileInputStream 对象时，会创建一个 FileDescriptor 对象，其实这个对象就是真正代表一个存在的文件对象的描述，当我们在操作一个文件对象时可以通过 getFD() 方法获取真正操作的与底层操作系统关联的文件描述。例如可以调用 FileDescriptor.sync() 方法将操作系统缓存中的数据强制刷新到物理磁盘中。<br>下面以清单 1 的程序为例，介绍下如何从磁盘读取一段文本字符。如下图所示：<br>图 7. 从磁盘读取文件<img src='/uploads/ibm_2014-08-10-7.jpg'/>当传入一个文件路径，将会根据这个路径创建一个 File 对象来标识这个文件，然后将会根据这个 File 对象创建真正读取文件的操作对象，这时将会真正创建一个关联真实存在的磁盘文件的文件描述符 FileDescriptor，通过这个对象可以直接控制这个磁盘文件。由于我们需要读取的是字符格式，所以需要 StreamDecoder 类将 byte 解码为 char 格式，至于如何从磁盘驱动器上读取一段数据，由操作系统帮我们完成。至于操作系统是如何将数据持久化到磁盘以及如何建立数据结构需要根据当前操作系统使用何种文件系统来回答，至于文件系统的相关细节可以参考另外的文章。</p>
<h2 id="Java-Socket-的工作机制"><a href="#Java-Socket-的工作机制" class="headerlink" title="Java Socket 的工作机制"></a>Java Socket 的工作机制</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Socket 这个概念没有对应到一个具体的实体，它是描述计算机之间完成相互通信一种抽象功能。打个比方，可以把 Socket 比作为两个城市之间的交通工具，有了它，就可以在城市之间来回穿梭了。交通工具有多种，每种交通工具也有相应的交通规则。Socket 也一样，也有多种。大部分情况下我们使用的都是基于 TCP/IP 的流套接字，它是一种稳定的通信协议。<br>下图是典型的基于 Socket 的通信的场景：<br>图 8.Socket 通信示例<img src='/uploads/ibm_2014-08-10-8.jpg'/>主机 A 的应用程序要能和主机 B 的应用程序通信，必须通过 Socket 建立连接，而建立 Socket 连接必须需要底层 TCP/IP 协议来建立 TCP 连接。建立 TCP 连接需要底层 IP 协议来寻址网络中的主机。我们知道网络层使用的 IP 协议可以帮助我们根据 IP 地址来找到目标主机，但是一台主机上可能运行着多个应用程序，如何才能与指定的应用程序通信就要通过 TCP 或 UPD 的地址也就是端口号来指定。这样就可以通过一个 Socket 实例唯一代表一个主机上的一个应用程序的通信链路了。</p>
<h2 id="建立通信链路"><a href="#建立通信链路" class="headerlink" title="建立通信链路"></a>建立通信链路</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当客户端要与服务端通信，客户端首先要创建一个 Socket 实例，操作系统将为这个 Socket 实例分配一个没有被使用的本地端口号，并创建一个包含本地和远程地址和端口号的套接字数据结构，这个数据结构将一直保存在系统中直到这个连接关闭。在创建 Socket 实例的构造函数正确返回之前，将要进行 TCP 的三次握手协议，TCP 握手协议完成后，Socket 实例对象将创建完成，否则将抛出 IOException 错误。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;与之对应的服务端将创建一个 ServerSocket 实例，ServerSocket 创建比较简单只要指定的端口号没有被占用，一般实例创建都会成功，同时操作系统也会为 ServerSocket 实例创建一个底层数据结构，这个数据结构中包含指定监听的端口号和包含监听地址的通配符，通常情况下都是“*”即监听所有地址。之后当调用 accept() 方法时，将进入阻塞状态，等待客户端的请求。当一个新的请求到来时，将为这个连接创建一个新的套接字数据结构，该套接字数据的信息包含的地址和端口信息正是请求源地址和端口。这个新创建的数据结构将会关联到 ServerSocket 实例的一个未完成的连接数据结构列表中，注意这时服务端与之对应的 Socket 实例并没有完成创建，而要等到与客户端的三次握手完成后，这个服务端的 Socket 实例才会返回，并将这个 Socket 实例对应的数据结构从未完成列表中移到已完成列表中。所以 ServerSocket 所关联的列表中每个数据结构，都代表与一个客户端的建立的 TCP 连接。</p>
<h2 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;传输数据是我们建立连接的主要目的，如何通过 Socket 传输数据，下面将详细介绍。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当连接已经建立成功，服务端和客户端都会拥有一个 Socket 实例，每个 Socket 实例都有一个 InputStream 和 OutputStream，正是通过这两个对象来交换数据。同时我们也知道网络 I/O 都是以字节流传输的。当 Socket 对象创建时，操作系统将会为 InputStream 和 OutputStream 分别分配一定大小的缓冲区，数据的写入和读取都是通过这个缓存区完成的。写入端将数据写到 OutputStream 对应的 SendQ 队列中，当队列填满时，数据将被发送到另一端 InputStream 的 RecvQ 队列中，如果这时 RecvQ 已经满了，那么 OutputStream 的 write 方法将会阻塞直到 RecvQ 队列有足够的空间容纳 SendQ 发送的数据。值得特别注意的是，这个缓存区的大小以及写入端的速度和读取端的速度非常影响这个连接的数据传输效率，由于可能会发生阻塞，所以网络 I/O 与磁盘 I/O 在数据的写入和读取还要有一个协调的过程，如果两边同时传送数据时可能会产生死锁，在后面 NIO 部分将介绍避免这种情况。</p>
<h2 id="NIO-的工作方式"><a href="#NIO-的工作方式" class="headerlink" title="NIO 的工作方式"></a>NIO 的工作方式</h2><h3 id="BIO-带来的挑战"><a href="#BIO-带来的挑战" class="headerlink" title="BIO 带来的挑战"></a>BIO 带来的挑战</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BIO 即阻塞 I/O，不管是磁盘 I/O 还是网络 I/O，数据在写入 OutputStream 或者从 InputStream 读取时都有可能会阻塞。一旦有线程阻塞将会失去 CPU 的使用权，这在当前的大规模访问量和有性能要求情况下是不能接受的。虽然当前的网络 I/O 有一些解决办法，如一个客户端一个处理线程，出现阻塞时只是一个线程阻塞而不会影响其它线程工作，还有为了减少系统线程的开销，采用线程池的办法来减少线程创建和回收的成本，但是有一些使用场景仍然是无法解决的。如当前一些需要大量 HTTP 长连接的情况，像淘宝现在使用的 Web 旺旺项目，服务端需要同时保持几百万的 HTTP 连接，但是并不是每时每刻这些连接都在传输数据，这种情况下不可能同时创建这么多线程来保持连接。即使线程的数量不是问题，仍然有一些问题还是无法避免的。如这种情况，我们想给某些客户端更高的服务优先级，很难通过设计线程的优先级来完成，另外一种情况是，我们需要让每个客户端的请求在服务端可能需要访问一些竞争资源，由于这些客户端是在不同线程中，因此需要同步，而往往要实现这些同步操作要远远比用单线程复杂很多。以上这些情况都说明，我们需要另外一种新的 I/O 操作方式。</p>
<h3 id="NIO-的工作机制"><a href="#NIO-的工作机制" class="headerlink" title="NIO 的工作机制"></a>NIO 的工作机制</h3><p>我们先看一下 NIO 涉及到的关联类图，如下：<br>图 9.NIO 相关类图<img src='/uploads/ibm_2014-08-10-9.jpg'/><br>上图中有两个关键类：Channel 和 Selector，它们是 NIO 中两个核心概念。我们还用前面的城市交通工具来继续比喻 NIO 的工作方式，这里的 Channel 要比 Socket 更加具体，它可以比作为某种具体的交通工具，如汽车或是高铁等，而 Selector 可以比作为一个车站的车辆运行调度系统，它将负责监控每辆车的当前运行状态：是已经出战还是在路上等等，也就是它可以轮询每个 Channel 的状态。这里还有一个 Buffer 类，它也比 Stream 更加具体化，我们可以将它比作为车上的座位，Channel 是汽车的话就是汽车上的座位，高铁上就是高铁上的座位，它始终是一个具体的概念，与 Stream 不同。Stream 只能代表是一个座位，至于是什么座位由你自己去想象，也就是你在去上车之前并不知道，这个车上是否还有没有座位了，也不知道上的是什么车，因为你并不能选择，这些信息都已经被封装在了运输工具（Socket）里面了，对你是透明的。NIO 引入了 Channel、Buffer 和 Selector 就是想把这些信息具体化，让程序员有机会控制它们，如：当我们调用 write() 往 SendQ 写数据时，当一次写的数据超过 SendQ 长度是需要按照 SendQ 的长度进行分割，这个过程中需要有将用户空间数据和内核地址空间进行切换，而这个切换不是你可以控制的。而在 Buffer 中我们可以控制 Buffer 的 capacity，并且是否扩容以及如何扩容都可以控制。<br>理解了这些概念后我们看一下，实际上它们是如何工作的，下面是典型的一段 NIO 代码：<br>清单 2. NIO 工作代码示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selector</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        Selector selector = Selector.open();</span><br><span class="line">        ServerSocketChannel ssc = ServerSocketChannel.open();</span><br><span class="line">        ssc.configureBlocking(<span class="keyword">false</span>);<span class="comment">//设置为非阻塞方式</span></span><br><span class="line">        ssc.socket().bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8080</span>));</span><br><span class="line">        ssc.register(selector, SelectionKey.OP_ACCEPT);<span class="comment">//注册监听的事件</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Set selectedKeys = selector.selectedKeys();<span class="comment">//取得所有key集合</span></span><br><span class="line">            Iterator it = selectedKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                SelectionKey key = (SelectionKey) it.next();</span><br><span class="line">                <span class="keyword">if</span> ((key.readyOps() &amp; SelectionKey.OP_ACCEPT) == SelectionKey.OP_ACCEPT) &#123;</span><br><span class="line">                    ServerSocketChannel ssChannel = (ServerSocketChannel) key.channel();</span><br><span class="line">                 SocketChannel sc = ssChannel.accept();<span class="comment">//接受到服务端的请求</span></span><br><span class="line">                    sc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    sc.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> </span><br><span class="line">                ((key.readyOps() &amp; SelectionKey.OP_READ) == SelectionKey.OP_READ) &#123;</span><br><span class="line">                    SocketChannel sc = (SocketChannel) key.channel();</span><br><span class="line">                    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                        buffer.clear();</span><br><span class="line">                        <span class="keyword">int</span> n = sc.read(buffer);<span class="comment">//读取数据</span></span><br><span class="line">                        <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        buffer.flip();</span><br><span class="line">                    &#125;</span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 Selector 的静态工厂创建一个选择器，创建一个服务端的 Channel 绑定到一个 Socket 对象，并把这个通信信道注册到选择器上，把这个通信信道设置为非阻塞模式。然后就可以调用 Selector 的 selectedKeys 方法来检查已经注册在这个选择器上的所有通信信道是否有需要的事件发生，如果有某个事件发生时，将会返回所有的 SelectionKey，通过这个对象 Channel 方法就可以取得这个通信信道对象从而可以读取通信的数据，而这里读取的数据是 Buffer，这个 Buffer 是我们可以控制的缓冲器。<br>在上面的这段程序中，是将 Server 端的监听连接请求的事件和处理请求的事件放在一个线程中，但是在实际应用中，我们通常会把它们放在两个线程中，一个线程专门负责监听客户端的连接请求，而且是阻塞方式执行的；另外一个线程专门来处理请求，这个专门处理请求的线程才会真正采用 NIO 的方式，像 Web 服务器 Tomcat 和 Jetty 都是这个处理方式，关于 Tomcat 和 Jetty 的 NIO 处理方式可以参考文章《 Jetty 的工作原理和与 Tomcat 的比较》。<br>下图是描述了基于 NIO 工作方式的 Socket 请求的处理过程：<br>图 10. 基于 NIO 的 Socket 请求的处理过程<img src='/uploads/ibm_2014-08-10-10.jpg'/><br>上图中的 Selector 可以同时监听一组通信信道（Channel）上的 I/O 状态，前提是这个 Selector 要已经注册到这些通信信道中。选择器 Selector 可以调用 select() 方法检查已经注册的通信信道上的是否有 I/O 已经准备好，如果没有至少一个信道 I/O 状态有变化，那么 select 方法会阻塞等待或在超时时间后会返回 0。上图中如果有多个信道有数据，那么将会将这些数据分配到对应的数据 Buffer 中。所以关键的地方是有一个线程来处理所有连接的数据交互，每个连接的数据交互都不是阻塞方式，所以可以同时处理大量的连接请求。</p>
<h3 id="Buffer-的工作方式"><a href="#Buffer-的工作方式" class="headerlink" title="Buffer 的工作方式"></a>Buffer 的工作方式</h3><p>上面介绍了 Selector 将检测到有通信信道 I/O 有数据传输时，通过 selelct() 取得 SocketChannel，将数据读取或写入 Buffer 缓冲区。下面讨论一下 Buffer 如何接受和写出数据？<br>Buffer 可以简单的理解为一组基本数据类型的元素列表，它通过几个变量来保存这个数据的当前位置状态，也就是有四个索引。如下表所示：<br>表 1.Buffer 中的参数项<img src='/uploads/ibm_2014-08-10-11.png'/>在实际操作数据时它们有如下关系图：<img src='/uploads/ibm_2014-08-10-12.jpg'/><br>我们通过 ByteBuffer.allocate(11) 方法创建一个 11 个 byte 的数组缓冲区，初始状态如上图所示，position 的位置为 0，capacity 和 limit 默认都是数组长度。当我们写入 5 个字节时位置变化如下图所示：<img src='/uploads/ibm_2014-08-10-13.jpg'/><br>这时我们需要将缓冲区的 5 个字节数据写入 Channel 通信信道，所以我们需要调用 byteBuffer.flip() 方法，数组的状态又发生如下变化：<img src='/uploads/ibm_2014-08-10-14.jpg'/><br>这时底层操作系统就可以从缓冲区中正确读取这 5 个字节数据发送出去了。在下一次写数据之前我们在调一下 clear() 方法。缓冲区的索引状态又回到初始位置。<br>这里还要说明一下 mark，当我们调用 mark() 时，它将记录当前 position 的前一个位置，当我们调用 reset 时，position 将恢复 mark 记录下来的值。<br>还有一点需要说明，通过 Channel 获取的 I/O 数据首先要经过操作系统的 Socket 缓冲区再将数据复制到 Buffer 中，这个的操作系统缓冲区就是底层的 TCP 协议关联的 RecvQ 或者 SendQ 队列，从操作系统缓冲区到用户缓冲区复制数据比较耗性能，Buffer 提供了另外一种直接操作操作系统缓冲区的的方式即 ByteBuffer.allocateDirector(size)，这个方法返回的 byteBuffer 就是与底层存储空间关联的缓冲区，它的操作方式与 linux2.4 内核的 sendfile 操作方式类似。</p>
<h2 id="I-O-调优"><a href="#I-O-调优" class="headerlink" title="I/O 调优"></a>I/O 调优</h2><p>下面就磁盘 I/O 和网络 I/O 的一些常用的优化技巧进行总结如下：</p>
<h3 id="磁盘-I-O-优化"><a href="#磁盘-I-O-优化" class="headerlink" title="磁盘 I/O 优化"></a>磁盘 I/O 优化</h3><h4 id="性能检测"><a href="#性能检测" class="headerlink" title="性能检测"></a>性能检测</h4><p>我们的应用程序通常都需要访问磁盘读取数据，而磁盘 I/O 通常都很耗时，我们要判断 I/O 是否是一个瓶颈，我们有一些参数指标可以参考：<br>如我们可以压力测试应用程序看系统的 I/O wait 指标是否正常，例如测试机器有 4 个 CPU，那么理想的 I/O wait 参数不应该超过 25%，如果超过 25% 的话，I/O 很可能成为应用程序的性能瓶颈。Linux 操作系统下可以通过 iostat 命令查看。<br>通常我们在判断 I/O 性能时还会看另外一个参数就是 IOPS，我们应用程序需要最低的 IOPS 是多少，而我们的磁盘的 IOPS 能不能达到我们的要求。每个磁盘的 IOPS 通常是在一个范围内，这和存储在磁盘的数据块的大小和访问方式也有关。但是主要是由磁盘的转速决定的，磁盘的转速越高磁盘的 IOPS 也越高。<br>现在为了提高磁盘 I/O 的性能，通常采用一种叫 RAID 的技术，就是将不同的磁盘组合起来来提高 I/O 性能，目前有多种 RAID 技术，每种 RAID 技术对 I/O 性能提升会有不同，可以用一个 RAID 因子来代表，磁盘的读写吞吐量可以通过 iostat 命令来获取，于是我们可以计算出一个理论的 IOPS 值，计算公式如下所以：<br>( 磁盘数 * 每块磁盘的 IOPS)/( 磁盘读的吞吐量 +RAID 因子 * 磁盘写的吞吐量 )=IOPS<br>这个公式的详细信息请查阅参考资料 Understanding Disk I/O。</p>
<h4 id="提升-I-O-性能"><a href="#提升-I-O-性能" class="headerlink" title="提升 I/O 性能"></a>提升 I/O 性能</h4><p>提升磁盘 I/O 性能通常的方法有：<br>1&sdot;&nbsp;增加缓存，减少磁盘访问次数<br>2&sdot;&nbsp;优化磁盘的管理系统，设计最优的磁盘访问策略，以及磁盘的寻址策略，这里是在底层操作系统层面考虑的。<br>3&sdot;&nbsp;设计合理的磁盘存储数据块，以及访问这些数据块的策略，这里是在应用层面考虑的。如我们可以给存放的数据设计索引，通过寻址索引来加快和减少磁盘的访问，还有可以采用异步和非阻塞的方式加快磁盘的访问效率。<br>4&sdot;&nbsp;应用合理的 RAID 策略提升磁盘 IO，每种 RAID 的区别我们可以用下表所示：<img src='/uploads/ibm_2014-08-10-15.jpg'/></p>
<h3 id="网络-I-O-优化"><a href="#网络-I-O-优化" class="headerlink" title="网络 I/O 优化"></a>网络 I/O 优化</h3><p>网络 I/O 优化通常有一些基本处理原则：<br>1&sdot;&nbsp;一个是减少网络交互的次数：要减少网络交互的次数通常我们在需要网络交互的两端会设置缓存，比如 Oracle 的 JDBC 驱动程序，就提供了对查询的 SQL 结果的缓存，在客户端和数据库端都有，可以有效的减少对数据库的访问。关于 Oracle JDBC 的内存管理可以参考《 Oracle JDBC 内存管理》。除了设置缓存还有一个办法是，合并访问请求：如在查询数据库时，我们要查 10 个 id，我可以每次查一个 id，也可以一次查 10 个 id。再比如在访问一个页面时通过会有多个 js 或 css 的文件，我们可以将多个 js 文件合并在一个 HTTP 链接中，每个文件用逗号隔开，然后发送到后端 Web 服务器根据这个 URL 链接，再拆分出各个文件，然后打包再一并发回给前端浏览器。这些都是常用的减少网络 I/O 的办法。<br>2&sdot;&nbsp;减少网络传输数据量的大小：减少网络数据量的办法通常是将数据压缩后再传输，如 HTTP 请求中，通常 Web 服务器将请求的 Web 页面 gzip 压缩后在传输给浏览器。还有就是通过设计简单的协议，尽量通过读取协议头来获取有用的价值信息。比如在代理程序设计时，有 4 层代理和 7 层代理都是来尽量避免要读取整个通信数据来取得需要的信息。<br>3&sdot;&nbsp;尽量减少编码：通常在网络 I/O 中数据传输都是以字节形式的，也就是通常要序列化。但是我们发送要传输的数据都是字符形式的，从字符到字节必须编码。但是这个编码过程是比较耗时的，所以在要经过网络 I/O 传输时，尽量直接以字节形式发送。也就是尽量提前将字符转化为字节，或者减少字符到字节的转化过程。<br>4&sdot;&nbsp;根据应用场景设计合适的交互方式：所谓的交互场景主要包括同步与异步阻塞与非阻塞方式，下面将详细介绍。</p>
<h4 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h4><p>所谓同步就是一个任务的完成需要依赖另外一个任务时，只有等待被依赖的任务完成后，依赖的任务才能算完成，这是一种可靠的任务序列。要么成功都成功，失败都失败，两个任务的状态可以保持一致。而异步是不需要等待被依赖的任务完成，只是通知被依赖的任务要完成什么工作，依赖的任务也立即执行，只要自己完成了整个任务就算完成了。至于被依赖的任务最终是否真正完成，依赖它的任务无法确定，所以它是不可靠的任务序列。我们可以用打电话和发短信来很好的比喻同步与异步操作。<br>在设计到 IO 处理时通常都会遇到一个是同步还是异步的处理方式的选择问题。因为同步与异步的 I/O 处理方式对调用者的影响很大，在数据库产品中都会遇到这个问题。因为 I/O 操作通常是一个非常耗时的操作，在一个任务序列中 I/O 通常都是性能瓶颈。但是同步与异步的处理方式对程序的可靠性影响非常大，同步能够保证程序的可靠性，而异步可以提升程序的性能，必须在可靠性和性能之间做个平衡，没有完美的解决办法。</p>
<h4 id="阻塞与非阻塞"><a href="#阻塞与非阻塞" class="headerlink" title="阻塞与非阻塞"></a>阻塞与非阻塞</h4><p>阻塞与非阻塞主要是从 CPU 的消耗上来说的，阻塞就是 CPU 停下来等待一个慢的操作完成 CPU 才接着完成其它的事。非阻塞就是在这个慢的操作在执行时 CPU 去干其它别的事，等这个慢的操作完成时，CPU 再接着完成后续的操作。虽然表面上看非阻塞的方式可以明显的提高 CPU 的利用率，但是也带了另外一种后果就是系统的线程切换增加。增加的 CPU 使用时间能不能补偿系统的切换成本需要好好评估。</p>
<h4 id="两种的方式的组合"><a href="#两种的方式的组合" class="headerlink" title="两种的方式的组合"></a>两种的方式的组合</h4><p>组合的方式可以由四种，分别是：同步阻塞、同步非阻塞、异步阻塞、异步非阻塞，这四种方式都对 I/O 性能有影响。下面给出分析，并有一些常用的设计用例参考。<br>表 3. 四种组合方式<img src='/uploads/ibm_2014-08-10-16.jpg'/><br>虽然异步和非阻塞能够提升 I/O 的性能，但是也会带来一些额外的性能成本，例如会增加线程数量从而增加 CPU 的消耗，同时也会导致程序设计的复杂度上升。如果设计的不合理的话反而会导致性能下降。在实际设计时要根据应用场景综合评估一下。<br>下面举一些异步和阻塞的操作实例：<br>在 Cassandra 中要查询数据通常会往多个数据节点发送查询命令，但是要检查每个节点返回数据的完整性，所以需要一个异步查询同步结果的应用场景，部分代码如下：<br>清单 3.异步查询同步结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncResult</span> <span class="keyword">implements</span> <span class="title">IAsyncResult</span></span>&#123; </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">byte</span>[] result_; </span><br><span class="line">   <span class="keyword">private</span> AtomicBoolean done_ = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>); </span><br><span class="line">   <span class="keyword">private</span> Lock lock_ = <span class="keyword">new</span> ReentrantLock(); </span><br><span class="line">   <span class="keyword">private</span> Condition condition_; </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">long</span> startTime_; </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">AsyncResult</span><span class="params">()</span></span>&#123;        </span><br><span class="line">       condition_ = lock_.newCondition();<span class="comment">// 创建一个锁</span></span><br><span class="line">       startTime_ = System.currentTimeMillis(); </span><br><span class="line">   &#125;    </span><br><span class="line"><span class="comment">/*** 检查需要的数据是否已经返回，如果没有返回阻塞 */</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] get()&#123; </span><br><span class="line">       lock_.lock(); </span><br><span class="line">       <span class="keyword">try</span>&#123; </span><br><span class="line">           <span class="keyword">if</span> (!done_.get())&#123;condition_.await();&#125; </span><br><span class="line">       &#125;<span class="keyword">catch</span> (InterruptedException ex)&#123; </span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(ex); </span><br><span class="line">       &#125;<span class="keyword">finally</span>&#123;lock_.unlock();&#125; </span><br><span class="line">       <span class="keyword">return</span> result_; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/*** 检查需要的数据是否已经返回 */</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> done_.get();&#125; </span><br><span class="line"><span class="comment">/*** 检查在指定的时间内需要的数据是否已经返回，如果没有返回抛出超时异常 */</span> </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">byte</span>[] get(<span class="keyword">long</span> timeout, TimeUnit tu) <span class="keyword">throws</span> TimeoutException&#123; </span><br><span class="line">       lock_.lock(); </span><br><span class="line">       <span class="keyword">try</span>&#123;            <span class="keyword">boolean</span> bVal = <span class="keyword">true</span>; </span><br><span class="line">           <span class="keyword">try</span>&#123; </span><br><span class="line">               <span class="keyword">if</span> ( !done_.get() )&#123; </span><br><span class="line">          <span class="keyword">long</span> overall_timeout = timeout - (System.currentTimeMillis() - startTime_); </span><br><span class="line">                   <span class="keyword">if</span>(overall_timeout &gt; <span class="number">0</span>)<span class="comment">// 设置等待超时的时间</span></span><br><span class="line">                       bVal = condition_.await(overall_timeout, TimeUnit.MILLISECONDS); </span><br><span class="line">                   <span class="keyword">else</span> bVal = <span class="keyword">false</span>; </span><br><span class="line">               &#125; </span><br><span class="line">           &#125;<span class="keyword">catch</span> (InterruptedException ex)&#123; </span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(ex); </span><br><span class="line">           &#125; </span><br><span class="line">           <span class="keyword">if</span> ( !bVal &amp;&amp; !done_.get() )&#123;<span class="comment">// 抛出超时异常</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">"Operation timed out."</span>); </span><br><span class="line">           &#125; </span><br><span class="line">       &#125;<span class="keyword">finally</span>&#123;lock_.unlock();      &#125; </span><br><span class="line">       <span class="keyword">return</span> result_; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/*** 该函数拱另外一个线程设置要返回的数据，并唤醒在阻塞的线程 */</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">result</span><span class="params">(Message response)</span></span>&#123;        </span><br><span class="line">       <span class="keyword">try</span>&#123; </span><br><span class="line">           lock_.lock(); </span><br><span class="line">           <span class="keyword">if</span> ( !done_.get() )&#123;                </span><br><span class="line">               result_ = response.getMessageBody();<span class="comment">// 设置返回的数据</span></span><br><span class="line">               done_.set(<span class="keyword">true</span>); </span><br><span class="line">               condition_.signal();<span class="comment">// 唤醒阻塞的线程</span></span><br><span class="line">           &#125; </span><br><span class="line">       &#125;<span class="keyword">finally</span>&#123;lock_.unlock();&#125;        </span><br><span class="line">   &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文阐述的内容较多，从 Java 基本 I/O 类库结构开始说起，主要介绍了磁盘 I/O 和网络 I/O 的基本工作方式，最后介绍了关于 I/O 调优的一些方法。</p>
<p>转载自: <a href="https://www.ibm.com/developerworks/cn/java/j-lo-javaio/" target="_blank" rel="noopener">深入分析 Java I/O 的工作机制</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/04/01/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BHandlerMapping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/04/01/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BHandlerMapping/" class="post-title-link" itemprop="url">SpringMVC组件之HandlerMapping—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-04-01 12:45:30" itemprop="dateCreated datePublished" datetime="2014-04-01T12:45:30+08:00">2014-04-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="HandlerMapping简介"><a href="#HandlerMapping简介" class="headerlink" title="HandlerMapping简介"></a>HandlerMapping简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HandlerMapping是SpringMVC中相对较重要的一个接口类，<font color=red>主要功能是将请求映射到处理程序以及拦截器列表以进行预处理和后处理</font>。在Spring MVC中提供了该接口的内置实现，当然我们也可以定制，扩展或替换它们。今天主要分析 RequestMappingHandlerMapping (支持@RequestMapping注解方法) 实现类。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DispatcherServlet在启动时会读取相关的配置文件并创建HandlerMapping实例，并且放到一个集合中，由于HandlerMapping实例都实现了Order接口，则会根据order对HandlerMapping进行排序。那么在DispatcherServlet接受请求时会循环遍历存有HandlerMapping实例的有序集合。由于，RequestMappingHandlerMapping的order值是0，则最先开始接收请求。</p>
<h3 id="RequestMappingHandlerMapping初始化过程"><a href="#RequestMappingHandlerMapping初始化过程" class="headerlink" title="RequestMappingHandlerMapping初始化过程"></a>RequestMappingHandlerMapping初始化过程</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在RequestMappingHandlerMapping类中直接继承了RequestMappingInfoHandlerMapping类以及实现了EmbeddedValueResolverAware接口。其中RequestMappingInfoHandlerMapping也是一个抽象类，其继承了AbstractHandlerMethodMapping<RequestMappingInfo>抽象类，而AbstractHandlerMethodMapping抽象类实现了InitializingBean类，并且定义了整个流程初始化的逻辑，在其实例化后对调用了afterPropertiesSet(…)方法，在该方法的实现中完成对Method Handler的注册逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMappingHandlerMapping</span> <span class="keyword">extends</span> <span class="title">RequestMappingInfoHandlerMapping</span> <span class="keyword">implements</span> <span class="title">EmbeddedValueResolverAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useSuffixPatternMatch = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useRegisteredSuffixPatternMatch = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useTrailingSlashMatch = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ContentNegotiationManager contentNegotiationManager = <span class="keyword">new</span> ContentNegotiationManager();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; fileExtensions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> StringValueResolver embeddedValueResolver;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmbeddedValueResolver</span><span class="params">(StringValueResolver resolver)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.embeddedValueResolver  = resolver;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 判断是否对指定的路径匹配规则进行路径注册</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.useRegisteredSuffixPatternMatch) &#123;</span><br><span class="line">			<span class="keyword">this</span>.fileExtensions.addAll(<span class="keyword">this</span>.contentNegotiationManager.getAllFileExtensions());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">super</span>.afterPropertiesSet(); <span class="comment">//进行初始化操作</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHandler</span><span class="params">(Class&lt;?&gt; beanType)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 检查Class是否为@Controller或@RequestMapping注解类型</span></span><br><span class="line">		<span class="keyword">return</span> ((AnnotationUtils.findAnnotation(beanType, Controller<span class="class">.<span class="keyword">class</span>) !</span>= <span class="keyword">null</span>) || (AnnotationUtils.findAnnotation(beanType, RequestMapping<span class="class">.<span class="keyword">class</span>) !</span>= <span class="keyword">null</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RequestMappingInfo <span class="title">getMappingForMethod</span><span class="params">(Method method, Class&lt;?&gt; handlerType)</span> </span>&#123;</span><br><span class="line">		RequestMappingInfo info = <span class="keyword">null</span>;</span><br><span class="line">		RequestMapping methodAnnotation = AnnotationUtils.findAnnotation(method, RequestMapping<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (methodAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">			RequestCondition&lt;?&gt; methodCondition = getCustomMethodCondition(method);</span><br><span class="line">			info = createRequestMappingInfo(methodAnnotation, methodCondition);</span><br><span class="line">			RequestMapping typeAnnotation = AnnotationUtils.findAnnotation(handlerType, RequestMapping<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			<span class="keyword">if</span> (typeAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">				RequestCondition&lt;?&gt; typeCondition = getCustomTypeCondition(handlerType);</span><br><span class="line">				info = createRequestMappingInfo(typeAnnotation, typeCondition).combine(info);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> info;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RequestMappingInfo <span class="title">createRequestMappingInfo</span><span class="params">(RequestMapping annotation, RequestCondition&lt;?&gt; customCondition)</span> </span>&#123;</span><br><span class="line">		String[] patterns = resolveEmbeddedValuesInPatterns(annotation.value());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RequestMappingInfo(</span><br><span class="line">				<span class="keyword">new</span> PatternsRequestCondition(patterns, getUrlPathHelper(), getPathMatcher(), <span class="keyword">this</span>.useSuffixPatternMatch, <span class="keyword">this</span>.useTrailingSlashMatch, <span class="keyword">this</span>.fileExtensions),</span><br><span class="line">				<span class="keyword">new</span> RequestMethodsRequestCondition(annotation.method()),</span><br><span class="line">				<span class="keyword">new</span> ParamsRequestCondition(annotation.params()),</span><br><span class="line">				<span class="keyword">new</span> HeadersRequestCondition(annotation.headers()),</span><br><span class="line">				<span class="keyword">new</span> ConsumesRequestCondition(annotation.consumes(), annotation.headers()),</span><br><span class="line">				<span class="keyword">new</span> ProducesRequestCondition(annotation.produces(), annotation.headers(), getContentNegotiationManager()),</span><br><span class="line">				customCondition);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> String[] resolveEmbeddedValuesInPatterns(String[] patterns) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.embeddedValueResolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> patterns;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			String[] resolvedPatterns = <span class="keyword">new</span> String[patterns.length];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; patterns.length; i++) &#123;</span><br><span class="line">				resolvedPatterns[i] = <span class="keyword">this</span>.embeddedValueResolver.resolveStringValue(patterns[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> resolvedPatterns;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在以上源码中看到其实现并重写了afterPropertiesSet()方法,并且在方法结束时调用了父级的afterPropertiesSet(),其方法体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandlerMethodMapping</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractHandlerMapping</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		initHandlerMethods(); <span class="comment">//初始化HandlerMethods</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initHandlerMethods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 省略部分代码</span></span><br><span class="line">		String[] beanNames = (<span class="keyword">this</span>.detectHandlerMethodsInAncestorContexts ?</span><br><span class="line">				BeanFactoryUtils.beanNamesForTypeIncludingAncestors(getApplicationContext(), Object.class) :</span><br><span class="line">				getApplicationContext().getBeanNamesForType(Object<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">			<span class="keyword">if</span> (isHandler(getApplicationContext().getType(beanName)))&#123; <span class="comment">//开始检查是否为指定注解的类型（具体功能由子类提供实现）</span></span><br><span class="line">				detectHandlerMethods(beanName); <span class="comment">//在句柄方法集里面查找对应的句柄（处理器）</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		handlerMethodsInitialized(getHandlerMethods()); <span class="comment">//开始初始化句柄方法集（HandlerMethods）</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">detectHandlerMethods</span><span class="params">(<span class="keyword">final</span> Object handler)</span> </span>&#123;</span><br><span class="line">		Class&lt;?&gt; handlerType = (handler <span class="keyword">instanceof</span> String) ? getApplicationContext().getType((String) handler) : handler.getClass();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">final</span> Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</span><br><span class="line"></span><br><span class="line">		Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, <span class="keyword">new</span> MethodFilter() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> getMappingForMethod(method, userType) != <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">			T mapping = getMappingForMethod(method, userType);</span><br><span class="line">			registerHandlerMethod(handler, method, mapping);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 开始注册相关的句柄以及处理其唯一的映射关系</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandlerMethod</span><span class="params">(Object handler, Method method, T mapping)</span> </span>&#123;</span><br><span class="line">		HandlerMethod newHandlerMethod = createHandlerMethod(handler, method);</span><br><span class="line">		HandlerMethod oldHandlerMethod = handlerMethods.get(mapping);</span><br><span class="line">		<span class="keyword">if</span> (oldHandlerMethod != <span class="keyword">null</span> &amp;&amp; !oldHandlerMethod.equals(newHandlerMethod)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Ambiguous mapping found. Cannot map '"</span> + newHandlerMethod.getBean()</span><br><span class="line">					+ <span class="string">"' bean method \n"</span> + newHandlerMethod + <span class="string">"\nto "</span> + mapping + <span class="string">": There is already '"</span></span><br><span class="line">					+ oldHandlerMethod.getBean() + <span class="string">"' bean method\n"</span> + oldHandlerMethod + <span class="string">" mapped."</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.handlerMethods.put(mapping, newHandlerMethod);</span><br><span class="line">		</span><br><span class="line">		Set&lt;String&gt; patterns = getMappingPathPatterns(mapping);</span><br><span class="line">		<span class="keyword">for</span> (String pattern : patterns) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!getPathMatcher().isPattern(pattern)) &#123;</span><br><span class="line">				<span class="keyword">this</span>.urlMap.add(pattern, mapping);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解配置示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/personal"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">personal</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"user/personal"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/employee_panel"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hr_employee_panel</span><span class="params">(<span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(flag==<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"user/hr_employee_panel_accordion"</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"user/hr_employee_panel"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/03/27/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BViewResolver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/apple-touch-icon-next.png">
      <meta itemprop="name" content="maxsoft">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MaxSoft">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2014/03/27/SpringMVC%E7%BB%84%E4%BB%B6%E4%B9%8BViewResolver/" class="post-title-link" itemprop="url">SpringMVC组件之ViewResolver—Spring系列学习笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表时间</span>

              <time title="创建时间：2014-03-27 12:45:30" itemprop="dateCreated datePublished" datetime="2014-03-27T12:45:30+08:00">2014-03-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E7%B3%BB%E5%88%97/" itemprop="url" rel="index">
                    <span itemprop="name">Spring系列</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SpringMVC组件之ViewResolver"><a href="#SpringMVC组件之ViewResolver" class="headerlink" title="SpringMVC组件之ViewResolver"></a>SpringMVC组件之ViewResolver</h2><p>SpringMVC中通过配置可以支持多种视图的解析，并且可以非常和谐的工作，这个功能主要归功于其中的ViewResolver接口。ViewResolver解析器的作用就是把一个视图的逻辑名称解析为一个能展示图形文本的视图对象。通过View接口对象进行视图渲染并响应给客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line">	<span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到该接口的源码中只提供了一个解析视图的功能；<br><font color=red>该接口的直接子类实现有如下几类：</font></p>
<pre><code>1&gt; org.springframework.web.servlet.view.AbstractCachingViewResolver
2&gt; org.springframework.web.servlet.view.BeanNameViewResolver
3&gt; org.springframework.web.servlet.view.ContentNegotiatingViewResolver</code></pre><h3 id="AbstractCachingViewResolver"><a href="#AbstractCachingViewResolver" class="headerlink" title="AbstractCachingViewResolver"></a>AbstractCachingViewResolver</h3><p>该抽象类主要提供了视图缓冲的功能，也就该解析器解析过的视图，会被存储起来，等到下次请求过来需要解析视图时，首先会判断该视图是否被解析过，如果被解析过了，那么就在缓冲中获取该视图，否则重新解析并存储到缓冲里面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCachingViewResolver</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CACHE_LIMIT = <span class="number">1024</span>;<span class="comment">//这里的默认是缓冲视图数量为 1024</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> View UNRESOLVED_VIEW = <span class="keyword">new</span> View() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cacheLimit = DEFAULT_CACHE_LIMIT; </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> cacheUnresolved = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*线程安全的基础上并发能力相对较好*/</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, View&gt; viewAccessCache = <span class="keyword">new</span> ConcurrentHashMap&lt;Object, View&gt;(DEFAULT_CACHE_LIMIT);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*能够保持缓冲数据的有序性，操作相对便捷*/</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, View&gt; viewCreationCache =</span><br><span class="line">			<span class="keyword">new</span> LinkedHashMap&lt;Object, View&gt;(DEFAULT_CACHE_LIMIT, <span class="number">0.75f</span>, <span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Object, View&gt; eldest)</span> </span>&#123;</span><br><span class="line">					<span class="keyword">if</span> (size() &gt; getCacheLimit()) &#123;</span><br><span class="line">						viewAccessCache.remove(eldest.getKey());</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCacheLimit</span><span class="params">(<span class="keyword">int</span> cacheLimit)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cacheLimit = cacheLimit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCacheLimit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.cacheLimit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCache</span><span class="params">(<span class="keyword">boolean</span> cache)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cacheLimit = (cache ? DEFAULT_CACHE_LIMIT : <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">this</span>.cacheLimit &gt; <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCacheUnresolved</span><span class="params">(<span class="keyword">boolean</span> cacheUnresolved)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cacheUnresolved = cacheUnresolved;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCacheUnresolved</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.cacheUnresolved;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isCache()) &#123; <span class="comment">// 是否缓冲了视图信息</span></span><br><span class="line">			<span class="keyword">return</span> createView(viewName, locale);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			Object cacheKey = getCacheKey(viewName, locale);</span><br><span class="line">			View view = <span class="keyword">this</span>.viewAccessCache.get(cacheKey);</span><br><span class="line">			<span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">synchronized</span> (<span class="keyword">this</span>.viewCreationCache) &#123;</span><br><span class="line">					view = <span class="keyword">this</span>.viewCreationCache.get(cacheKey);</span><br><span class="line">					<span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="comment">// 重新出创建视图对象</span></span><br><span class="line">						view = createView(viewName, locale);</span><br><span class="line">						<span class="keyword">if</span> (view == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.cacheUnresolved) &#123; <span class="comment">// 如果没有查询到该视图，同事也没有缓冲该视图，则启用默认视图</span></span><br><span class="line">							view = UNRESOLVED_VIEW;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">							<span class="keyword">this</span>.viewAccessCache.put(cacheKey, view);</span><br><span class="line">							<span class="keyword">this</span>.viewCreationCache.put(cacheKey, view);</span><br><span class="line">							<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">								logger.trace(<span class="string">"Cached view ["</span> + cacheKey + <span class="string">"]"</span>);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> (view != UNRESOLVED_VIEW ? view : <span class="keyword">null</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">getCacheKey</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> viewName + <span class="string">"_"</span> + locale;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeFromCache</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isCache()) &#123;</span><br><span class="line">			logger.warn(<span class="string">"View caching is SWITCHED OFF -- removal not necessary"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			Object cacheKey = getCacheKey(viewName, locale);</span><br><span class="line">			Object cachedView;</span><br><span class="line">			<span class="keyword">synchronized</span> (<span class="keyword">this</span>.viewCreationCache) &#123;</span><br><span class="line">				<span class="keyword">this</span>.viewAccessCache.remove(cacheKey);</span><br><span class="line">				cachedView = <span class="keyword">this</span>.viewCreationCache.remove(cacheKey);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.viewCreationCache) &#123;</span><br><span class="line">			<span class="keyword">this</span>.viewAccessCache.clear();</span><br><span class="line">			<span class="keyword">this</span>.viewCreationCache.clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">createView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> loadView(viewName, locale);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们看到AbstractCachingViewResolver接口中使用了两个Map用于缓存View视图对象，分别如下：</p>
<pre><code>1&gt; ConcurrentHashMap：在线程安全的条件下提供了较好的并发访问能力，效率较高
2&gt; LinkedHashMap：保证了值的有序性，同时它有方法是删除最前保存的值</code></pre><p>其中removeEldestEntry()方法返回true时，表示达到了最大空间，删除值；返回false时，表示没有达到上线。通常使用ConcurrentHashMap来获取缓存数据，同时结合LinkedHashMap来操作缓冲会更加方便。<br><font color=red>该抽象类的直接实现类有如下几个：</font></p>
<pre><code>1&gt;  org.springframework.web.servlet.view.ResourceBundleViewResolver
2&gt;  org.springframework.web.servlet.view.UrlBasedViewResolver
3&gt;  org.springframework.web.servlet.view.XmlViewResolver</code></pre><h4 id="ResourceBundleViewResolver"><a href="#ResourceBundleViewResolver" class="headerlink" title="ResourceBundleViewResolver"></a>ResourceBundleViewResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceBundleViewResolver</span> <span class="keyword">extends</span> <span class="title">AbstractCachingViewResolver</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">Ordered</span>, <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_BASENAME = <span class="string">"views"</span>; <span class="comment">/*默认的基（根）名称*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;<span class="comment">/*默认排序值为1024*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String[] basenames = <span class="keyword">new</span> String[] &#123;DEFAULT_BASENAME&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ClassLoader bundleClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String defaultParentView;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Locale[] localesToInitialize;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Locale, BeanFactory&gt; localeCache = <span class="keyword">new</span> HashMap&lt;Locale, BeanFactory&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;List&lt;ResourceBundle&gt;, ConfigurableApplicationContext&gt; bundleCache = <span class="keyword">new</span> HashMap&lt;List&lt;ResourceBundle&gt;, ConfigurableApplicationContext&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		BeanFactory factory = initFactory(locale);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> factory.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">			<span class="comment">// to allow for ViewResolver chaining</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> BeanFactory <span class="title">initFactory</span><span class="params">(Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			BeanFactory cachedFactory = <span class="keyword">this</span>.localeCache.get(locale);</span><br><span class="line">			<span class="keyword">if</span> (cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> cachedFactory;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		List&lt;ResourceBundle&gt; bundles = <span class="keyword">new</span> LinkedList&lt;ResourceBundle&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String basename : <span class="keyword">this</span>.basenames) &#123;</span><br><span class="line">			ResourceBundle bundle = getBundle(basename, locale);</span><br><span class="line">			bundles.add(bundle);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			BeanFactory cachedFactory = <span class="keyword">this</span>.bundleCache.get(bundles);</span><br><span class="line">			<span class="keyword">if</span> (cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">this</span>.localeCache.put(locale, cachedFactory);</span><br><span class="line">				<span class="keyword">return</span> cachedFactory;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 为视图创建一个子应用程序上下文对象</span></span><br><span class="line">		GenericWebApplicationContext factory = <span class="keyword">new</span> GenericWebApplicationContext();</span><br><span class="line">		factory.setParent(getApplicationContext());</span><br><span class="line">		factory.setServletContext(getServletContext());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从资源包加载定义的解析器</span></span><br><span class="line">		PropertiesBeanDefinitionReader reader = <span class="keyword">new</span> PropertiesBeanDefinitionReader(factory);</span><br><span class="line">		reader.setDefaultParentBean(<span class="keyword">this</span>.defaultParentView);</span><br><span class="line">		<span class="keyword">for</span> (ResourceBundle bundle : bundles) &#123;</span><br><span class="line">			reader.registerBeanDefinitions(bundle);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		factory.refresh();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 这里缓冲了解析器实例和多语实例</span></span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.localeCache.put(locale, factory);</span><br><span class="line">			<span class="keyword">this</span>.bundleCache.put(bundles, factory);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> factory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ResourceBundle <span class="title">getBundle</span><span class="params">(String basename, Locale locale)</span> <span class="keyword">throws</span> MissingResourceException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ResourceBundle.getBundle(basename, locale, getBundleClassLoader());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (ConfigurableApplicationContext factory : <span class="keyword">this</span>.bundleCache.values()) &#123;</span><br><span class="line">			factory.close();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.localeCache.clear();</span><br><span class="line">		<span class="keyword">this</span>.bundleCache.clear();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们可以理解该解析器是通过配置资源属性文件（默认文件为views.properties）来进行获取每一个请求相对应的解析器逻辑名称和地址，然后进行视图的处理。<br>配置文件示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.ResourceBundleViewResolver"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basename"</span> <span class="attr">value</span>=<span class="string">"maxsoft-views"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>maxsoft-views.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">main.(class)</span>=<span class="string">org.springframework.web.servlet.view.InternalResourceView    </span></span><br><span class="line"><span class="meta">mian.url</span>=<span class="string">/main.jsp    </span></span><br><span class="line"><span class="meta">news.(class)</span>=<span class="string">org.springframework.web.servlet.view.InternalResourceView    </span></span><br><span class="line"><span class="meta">news.url</span>=<span class="string">/news.jsp</span></span><br></pre></td></tr></table></figure>

<h4 id="UrlBasedViewResolver"><a href="#UrlBasedViewResolver" class="headerlink" title="UrlBasedViewResolver"></a>UrlBasedViewResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlBasedViewResolver</span> <span class="keyword">extends</span> <span class="title">AbstractCachingViewResolver</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REDIRECT_URL_PREFIX = <span class="string">"redirect:"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FORWARD_URL_PREFIX = <span class="string">"forward:"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class viewClass;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String prefix = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String suffix = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String[] viewNames = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String contentType;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> redirectContextRelative = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> redirectHttp10Compatible = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String requestContextAttribute;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Map of static attributes, keyed by attribute name (String) */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; staticAttributes = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Boolean exposePathVariables;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewClass</span><span class="params">(Class viewClass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (viewClass == <span class="keyword">null</span> || !requiredViewClass().isAssignableFrom(viewClass)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">					<span class="string">"Given view class ["</span> + (viewClass != <span class="keyword">null</span> ? viewClass.getName() : <span class="keyword">null</span>) +</span><br><span class="line">					<span class="string">"] is not of type ["</span> + requiredViewClass().getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.viewClass = viewClass;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.initApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (getViewClass() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Property 'viewClass' is required"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">createView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//是否处理给定的视图</span></span><br><span class="line">		<span class="keyword">if</span> (!canHandle(viewName, locale)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 检查是否为重定向指令</span></span><br><span class="line">		<span class="keyword">if</span> (viewName.startsWith(REDIRECT_URL_PREFIX)) &#123;</span><br><span class="line">			String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length()); <span class="comment">//过滤前缀</span></span><br><span class="line">			RedirectView view = <span class="keyword">new</span> RedirectView(redirectUrl, isRedirectContextRelative(), isRedirectHttp10Compatible());</span><br><span class="line">			<span class="keyword">return</span> applyLifecycleMethods(viewName, view);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 检查是否为转发指令</span></span><br><span class="line">		<span class="keyword">if</span> (viewName.startsWith(FORWARD_URL_PREFIX)) &#123;</span><br><span class="line">			String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length()); <span class="comment">//过滤前缀</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> InternalResourceView(forwardUrl);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//否则调用基类loadView()获取视图。</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.createView(viewName, locale);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">canHandle</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		String[] viewNames = getViewNames();</span><br><span class="line">		<span class="keyword">return</span> (viewNames == <span class="keyword">null</span> || PatternMatchUtils.simpleMatch(viewNames, viewName));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		AbstractUrlBasedView view = buildView(viewName);</span><br><span class="line">		View result = applyLifecycleMethods(viewName, view);</span><br><span class="line">		<span class="keyword">return</span> (view.checkResource(locale) ? result : <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> View <span class="title">applyLifecycleMethods</span><span class="params">(String viewName, AbstractView view)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (View) getApplicationContext().getAutowireCapableBeanFactory().initializeBean(view, viewName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AbstractUrlBasedView <span class="title">buildView</span><span class="params">(String viewName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		AbstractUrlBasedView view = (AbstractUrlBasedView) BeanUtils.instantiateClass(getViewClass());</span><br><span class="line">		view.setUrl(getPrefix() + viewName + getSuffix());</span><br><span class="line">		String contentType = getContentType();</span><br><span class="line">		<span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">			view.setContentType(contentType);</span><br><span class="line">		&#125;</span><br><span class="line">		view.setRequestContextAttribute(getRequestContextAttribute());</span><br><span class="line">		view.setAttributesMap(getAttributesMap());</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.exposePathVariables != <span class="keyword">null</span>) &#123;</span><br><span class="line">			view.setExposePathVariables(exposePathVariables);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> view;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码我们可以理解，UrlBasedViewResolver是对ViewResolver接口的一种简单实现，并且继承了AbstractCachingViewResolver抽象类。<br>UrlBasedViewResolver主要通过「prefix属性 + 逻辑视图名称 + suffix属性 」拼接字符方式来解析视图。如prefix=/WEB-INF/jsp/，suffix=.jsp，返回的视图名称viewName=maxsoft/main，则其解析出来的视图URL就是/WEB-INF/jsp/maxsoft/main.jsp。<br>prefix ：默认是空字符串；<br>suffix：默认是空字符串；<br>URLBasedViewResolver解析器也支持返回的视图名称中包含（重定向）<font color=red>「redirect:前缀 」</font>，通过前缀过滤组成一个RedirectView，在RedirectView中将把请求返回的模型数据组装为查询参数的形式拼接到redirect的URL后面，然后通过HttpServletResponse对象的sendRedirect方法进行重定向。<br>同样URLBasedViewResolver还支持<font color=red>「forword:前缀 」</font>，通过前缀过滤后会被封装成一个InternalResourceView对象，然后在服务器端利用RequestDispatcher的forword方式跳转到指定的地址。<br>配置文件示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.UrlBasedViewResolver"</span>&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp"</span> /&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span>    </span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span>/&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><font color=red>注意：使用UrlBasedViewResolver的时候必须指定视图类名（viewClass），即告诉解析器解析成哪种视图，通常使用较多的是org.springframework.web.servlet.view.InternalResourceView，利用它来展现jsp，如果我们使用JSTL的时候则需要使用org.springframework.web.servlet.view.JstlView</font></p>
<p>通过源码继承关系可以发现，在某种角度上看UrlBasedViewResolver也是如下几类视图解析器的「基类」：</p>
<pre><code>1&gt; org.springframework.web.servlet.view.AbstractTemplateViewResolver
2&gt; org.springframework.web.servlet.view.InternalResourceViewResolver
3&gt; org.springframework.web.servlet.view.jasperreports.JasperReportsViewResolver
4&gt; org.springframework.web.servlet.view.tiles3.TilesViewResolver
5&gt; org.springframework.web.servlet.view.tiles2.TilesViewResolver
6&gt; org.springframework.web.servlet.view.xslt.XsltViewResolver</code></pre><h4 id="XmlViewResolver"><a href="#XmlViewResolver" class="headerlink" title="XmlViewResolver"></a>XmlViewResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlViewResolver</span> <span class="keyword">extends</span> <span class="title">AbstractCachingViewResolver</span> <span class="keyword">implements</span> <span class="title">Ordered</span>, <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认的视图解析器配置文件路径</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_LOCATION = <span class="string">"/WEB-INF/views.xml"</span>;</span><br><span class="line">	<span class="comment">// 默认的排序值</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Resource location;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ConfigurableApplicationContext cachedFactory;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 省略部分代码</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocation</span><span class="params">(Resource location)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.location = location;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			initFactory();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">getCacheKey</span><span class="params">(String viewName, Locale locale)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> viewName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> View <span class="title">loadView</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		BeanFactory factory = initFactory();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> factory.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> BeanFactory <span class="title">initFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.cachedFactory;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Resource actualLocation = <span class="keyword">this</span>.location;</span><br><span class="line">		<span class="keyword">if</span> (actualLocation == <span class="keyword">null</span>) &#123;</span><br><span class="line">			actualLocation = getApplicationContext().getResource(DEFAULT_LOCATION);</span><br><span class="line">		&#125;</span><br><span class="line">		GenericWebApplicationContext factory = <span class="keyword">new</span> GenericWebApplicationContext();</span><br><span class="line">		factory.setParent(getApplicationContext());</span><br><span class="line">		factory.setServletContext(getServletContext());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 加载XML资源文件</span></span><br><span class="line">		XmlBeanDefinitionReader reader = <span class="keyword">new</span> XmlBeanDefinitionReader(factory);</span><br><span class="line">		reader.setEnvironment(getApplicationContext().getEnvironment());</span><br><span class="line">		reader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(getApplicationContext()));</span><br><span class="line">		reader.loadBeanDefinitions(actualLocation);</span><br><span class="line"></span><br><span class="line">		factory.refresh();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isCache()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.cachedFactory = factory;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> factory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.cachedFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.cachedFactory.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述源码中我们发现，该XmlViewResolver解析器也是通过资源配置文件进行对请求视图的解析。资源文件的默认是地址是”/WEB-INF/views.xml”，我们也可以通过在Spring容器中注册实例时重新的定义其路径，例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.XmlViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"location"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/WEB-INF/resource/xml/spring-views.xml<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>spring-views.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/main.jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"user"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.JstlView"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/user.jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>工作原理：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;控制器返回逻辑视图名称，XmlViewResolver解析器将会在spring-views.xml资源配置文件中查找该逻辑视图名称相对应的视图解析实例，并返回其视图地址给DispatcherServlet，进行渲染响应给客户端。</p>
<h3 id="BeanNameViewResolver"><a href="#BeanNameViewResolver" class="headerlink" title="BeanNameViewResolver"></a>BeanNameViewResolver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanNameViewResolver</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Integer.MAX_VALUE;  <span class="comment">//默认最大的排序值</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.order = order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		ApplicationContext context = getApplicationContext();</span><br><span class="line">		<span class="keyword">if</span> (!context.containsBean(viewName)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> context.getBean(viewName, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码分析我们可以理解，BeanNameViewResolver是通过视图的逻辑名称在Spring容器中获取注入的视图解析实例（不进行实例的缓冲），进行对视图的解析处理。<br>配置文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.BeanNameViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"maxsoft"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"/main.jsp"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ContentNegotiatingViewResolver"><a href="#ContentNegotiatingViewResolver" class="headerlink" title="ContentNegotiatingViewResolver"></a>ContentNegotiatingViewResolver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentNegotiatingViewResolver</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ViewResolver</span>, <span class="title">Ordered</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(ContentNegotiatingViewResolver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> order = Ordered.HIGHEST_PRECEDENCE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ContentNegotiationManager contentNegotiationManager;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ContentNegotiationManagerFactoryBean cnManagerFactoryBean = <span class="keyword">new</span> ContentNegotiationManagerFactoryBean();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useNotAcceptableStatusCode = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;View&gt; defaultViews;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.order = order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.order;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentNegotiationManager</span><span class="params">(ContentNegotiationManager contentNegotiationManager)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.contentNegotiationManager = contentNegotiationManager;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFavorPathExtension</span><span class="params">(<span class="keyword">boolean</span> favorPathExtension)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setFavorPathExtension(favorPathExtension);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUseJaf</span><span class="params">(<span class="keyword">boolean</span> useJaf)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setUseJaf(useJaf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFavorParameter</span><span class="params">(<span class="keyword">boolean</span> favorParameter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setFavorParameter(favorParameter);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameterName</span><span class="params">(String parameterName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setParameterName(parameterName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIgnoreAcceptHeader</span><span class="params">(<span class="keyword">boolean</span> ignoreAcceptHeader)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setIgnoreAcceptHeader(ignoreAcceptHeader);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMediaTypes</span><span class="params">(Map&lt;String, String&gt; mediaTypes)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mediaTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">			Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">			props.putAll(mediaTypes);</span><br><span class="line">			<span class="keyword">this</span>.cnManagerFactoryBean.setMediaTypes(props);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultContentType</span><span class="params">(MediaType defaultContentType)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setDefaultContentType(defaultContentType);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUseNotAcceptableStatusCode</span><span class="params">(<span class="keyword">boolean</span> useNotAcceptableStatusCode)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.useNotAcceptableStatusCode = useNotAcceptableStatusCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultViews</span><span class="params">(List&lt;View&gt; defaultViews)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.defaultViews = defaultViews;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setViewResolvers</span><span class="params">(List&lt;ViewResolver&gt; viewResolvers)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.viewResolvers = viewResolvers;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initServletContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">		Collection&lt;ViewResolver&gt; matchingBeans = BeanFactoryUtils.beansOfTypeIncludingAncestors(getApplicationContext(), ViewResolver<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>()</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.viewResolvers = <span class="keyword">new</span> ArrayList&lt;ViewResolver&gt;(matchingBeans.size());</span><br><span class="line">			<span class="keyword">for</span> (ViewResolver viewResolver : matchingBeans) &#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span> != viewResolver) &#123;</span><br><span class="line">					<span class="keyword">this</span>.viewResolvers.add(viewResolver);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; viewResolvers.size(); i++) &#123;</span><br><span class="line">				<span class="keyword">if</span> (matchingBeans.contains(viewResolvers.get(i))) &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				String name = viewResolvers.get(i).getClass().getName() + i;</span><br><span class="line">				getApplicationContext().getAutowireCapableBeanFactory().initializeBean(viewResolvers.get(i), name);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers.isEmpty()) &#123;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">		&#125;</span><br><span class="line">		OrderComparator.sort(<span class="keyword">this</span>.viewResolvers);</span><br><span class="line">		<span class="keyword">this</span>.cnManagerFactoryBean.setServletContext(servletContext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.contentNegotiationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.cnManagerFactoryBean.afterPropertiesSet();</span><br><span class="line">			<span class="keyword">this</span>.contentNegotiationManager = <span class="keyword">this</span>.cnManagerFactoryBean.getObject();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		RequestAttributes attrs = RequestContextHolder.getRequestAttributes();</span><br><span class="line">		Assert.isInstanceOf(ServletRequestAttributes<span class="class">.<span class="keyword">class</span>, <span class="title">attrs</span>)</span>;</span><br><span class="line">		List&lt;MediaType&gt; requestedMediaTypes = getMediaTypes(((ServletRequestAttributes) attrs).getRequest());</span><br><span class="line">		<span class="keyword">if</span> (requestedMediaTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">			List&lt;View&gt; candidateViews = getCandidateViews(viewName, locale, requestedMediaTypes);</span><br><span class="line">			View bestView = getBestView(candidateViews, requestedMediaTypes, attrs);</span><br><span class="line">			<span class="keyword">if</span> (bestView != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> bestView;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.useNotAcceptableStatusCode) &#123;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">			<span class="keyword">return</span> NOT_ACCEPTABLE_VIEW;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> List&lt;MediaType&gt; <span class="title">getMediaTypes</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request);</span><br><span class="line">			List&lt;MediaType&gt; acceptableMediaTypes = <span class="keyword">this</span>.contentNegotiationManager.resolveMediaTypes(webRequest);</span><br><span class="line">			acceptableMediaTypes = acceptableMediaTypes.isEmpty() ? Collections.singletonList(MediaType.ALL) : acceptableMediaTypes;</span><br><span class="line">			List&lt;MediaType&gt; producibleMediaTypes = getProducibleMediaTypes(request);</span><br><span class="line">			Set&lt;MediaType&gt; compatibleMediaTypes = <span class="keyword">new</span> LinkedHashSet&lt;MediaType&gt;();</span><br><span class="line">			<span class="keyword">for</span> (MediaType acceptable : acceptableMediaTypes) &#123;</span><br><span class="line">				<span class="keyword">for</span> (MediaType producible : producibleMediaTypes) &#123;</span><br><span class="line">					<span class="keyword">if</span> (acceptable.isCompatibleWith(producible)) &#123;</span><br><span class="line">						compatibleMediaTypes.add(getMostSpecificMediaType(acceptable, producible));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			List&lt;MediaType&gt; selectedMediaTypes = <span class="keyword">new</span> ArrayList&lt;MediaType&gt;(compatibleMediaTypes);</span><br><span class="line">			MediaType.sortBySpecificityAndQuality(selectedMediaTypes);</span><br><span class="line">			<span class="comment">// 省略部分代码</span></span><br><span class="line">			<span class="keyword">return</span> selectedMediaTypes;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (HttpMediaTypeNotAcceptableException ex) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">private</span> List&lt;MediaType&gt; <span class="title">getProducibleMediaTypes</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		Set&lt;MediaType&gt; mediaTypes = (Set&lt;MediaType&gt;) request.getAttribute(HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(mediaTypes)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;MediaType&gt;(mediaTypes);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> Collections.singletonList(MediaType.ALL);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> MediaType <span class="title">getMostSpecificMediaType</span><span class="params">(MediaType acceptType, MediaType produceType)</span> </span>&#123;</span><br><span class="line">		produceType = produceType.copyQualityValue(acceptType);</span><br><span class="line">		<span class="keyword">return</span> MediaType.SPECIFICITY_COMPARATOR.compare(acceptType, produceType) &lt; <span class="number">0</span> ? acceptType : produceType;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> List&lt;View&gt; <span class="title">getCandidateViews</span><span class="params">(String viewName, Locale locale, List&lt;MediaType&gt; requestedMediaTypes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		List&lt;View&gt; candidateViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">		<span class="keyword">for</span> (ViewResolver viewResolver : <span class="keyword">this</span>.viewResolvers) &#123;</span><br><span class="line">			View view = viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">				candidateViews.add(view);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> (MediaType requestedMediaType : requestedMediaTypes) &#123;</span><br><span class="line">				List&lt;String&gt; extensions = <span class="keyword">this</span>.contentNegotiationManager.resolveFileExtensions(requestedMediaType);</span><br><span class="line">				<span class="keyword">for</span> (String extension : extensions) &#123;</span><br><span class="line">					String viewNameWithExtension = viewName + <span class="string">"."</span> + extension;</span><br><span class="line">					view = viewResolver.resolveViewName(viewNameWithExtension, locale);</span><br><span class="line">					<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">						candidateViews.add(view);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(<span class="keyword">this</span>.defaultViews)) &#123;</span><br><span class="line">			candidateViews.addAll(<span class="keyword">this</span>.defaultViews);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> candidateViews;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> View <span class="title">getBestView</span><span class="params">(List&lt;View&gt; candidateViews, List&lt;MediaType&gt; requestedMediaTypes, RequestAttributes attrs)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (View candidateView : candidateViews) &#123;</span><br><span class="line">			<span class="keyword">if</span> (candidateView <span class="keyword">instanceof</span> SmartView) &#123;</span><br><span class="line">				SmartView smartView = (SmartView) candidateView;</span><br><span class="line">				<span class="keyword">if</span> (smartView.isRedirectView()) &#123;</span><br><span class="line">					<span class="comment">// 省略部分代码</span></span><br><span class="line">					<span class="keyword">return</span> candidateView;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (MediaType mediaType : requestedMediaTypes) &#123;</span><br><span class="line">			<span class="keyword">for</span> (View candidateView : candidateViews) &#123;</span><br><span class="line">				<span class="keyword">if</span> (StringUtils.hasText(candidateView.getContentType())) &#123;</span><br><span class="line">					MediaType candidateContentType = MediaType.parseMediaType(candidateView.getContentType());</span><br><span class="line">					<span class="keyword">if</span> (mediaType.isCompatibleWith(candidateContentType)) &#123;</span><br><span class="line">						<span class="comment">// 省略部分代码</span></span><br><span class="line">						attrs.setAttribute(View.SELECTED_CONTENT_TYPE, mediaType, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">						<span class="keyword">return</span> candidateView;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> View NOT_ACCEPTABLE_VIEW = <span class="keyword">new</span> View() &#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">			response.setStatus(HttpServletResponse.SC_NOT_ACCEPTABLE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过源码分析我们可以得知，ContentNegotiatingViewResolver本身不解析视图，而是委托给其他ViewResolver<font color=red>「resolveViewName() –&gt;getCandidateViews(), getBestView()」</font>。 默认情况下，这些其他类别的视图解析器是从应用容器中获取的，尽管它们也可以通过使用viewResolvers属性来显式设置。 但是，为了使该视图解析器能够正常工作，需要将order属性设置为比其他更高的优先级（默认值是Ordered.HIGHEST_PRECEDENCE）<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;该视图解析器使用所请求的媒体类型来为请求选择合适的视图，请求的媒体类型是通过配置的ContentNegotiationManager确定的<font color=red>「getMediaTypes()」</font>。 一旦确定了所请求的媒体类型，该解析器查询每个委托视图解析器以查看并确定所请求的媒体类型是否与视图的内容类型兼容）。 最兼容的视图被返回。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时，该视图解析器显式的增加了defaultViews属性，允许我们覆盖视图解析器提供的视图。 当然，这些默认视图以candicates的形式提供，并且需要具有请求的内容类型（通过文件扩展名，参数或Accept头，如上所述）。 我们也可以直接设置默认的内容类型，当其他机制（Accept头，文件扩展名或参数）导致不匹配时，将返回默认的内容类型。<br>例如，如果请求路径是/view.html，则此视图解析器将查找具有文本/ html内容类型（基于html文件扩展名）的视图。 使用text / html请求Accept头的请求/查看具有相同的结果。<br>配置文件示例如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.ContentNegotiatingViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"favorParameter"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"ignoreAcceptHeader"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultViews"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.json.MappingJacksonJsonView"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.xml.MarshallingView"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.oxm.jaxb.Jaxb2Marshaller"</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"classesToBeBound"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.maxsoft.User<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mediaTypes"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"xml"</span> <span class="attr">value</span>=<span class="string">"application/xml"</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"json"</span> <span class="attr">value</span>=<span class="string">"application/json"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 如果在order值为1的视图解析器中没有匹配到则会使用该视图解析器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceView"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_blank" rel="noopener">Spring MVC</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="maxsoft"
      src="/images/apple-touch-icon-next.png">
  <p class="site-author-name" itemprop="name">maxsoft</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/maxsoft-bj" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;maxsoft-bj" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zylwlh810@163.com" title="E-Mail → mailto:zylwlh810@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">maxsoft</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">318k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:49</span>
</div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@latest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout: 3000,
        priority: true,
        ignores: [uri => uri.includes('#'),uri => uri == 'http://yoursite.com/page/3/',]
      });
      });
  </script>

</body>
</html>
